(()=>{var e={723:e=>{function webpackEmptyAsyncContext(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}))}webpackEmptyAsyncContext.keys=()=>[];webpackEmptyAsyncContext.resolve=webpackEmptyAsyncContext;webpackEmptyAsyncContext.id=723;e.exports=webpackEmptyAsyncContext},930:e=>{function webpackEmptyAsyncContext(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}))}webpackEmptyAsyncContext.keys=()=>[];webpackEmptyAsyncContext.resolve=webpackEmptyAsyncContext;webpackEmptyAsyncContext.id=930;e.exports=webpackEmptyAsyncContext}};var t={};function __nccwpck_require__(r){var s=t[r];if(s!==undefined){return s.exports}var n=t[r]={exports:{}};var i=true;try{e[r](n,n.exports,__nccwpck_require__);i=false}finally{if(i)delete t[r]}return n.exports}(()=>{__nccwpck_require__.d=(e,t)=>{for(var r in t){if(__nccwpck_require__.o(t,r)&&!__nccwpck_require__.o(e,r)){Object.defineProperty(e,r,{enumerable:true,get:t[r]})}}}})();(()=>{__nccwpck_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{__nccwpck_require__.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r={};(()=>{"use strict";__nccwpck_require__.r(r);__nccwpck_require__.d(r,{ConnectionState:()=>P,OrderAction:()=>S,OrderStatus:()=>N,OrderType:()=>y,SecType:()=>R,default:()=>g});const e={NOT_READY:"not-ready",READY:"ready",OPERATION_STARTED:"operation-started",OPERATION_ENDED:"operation-ended",OPERATION_FAILED:"operation-failed"};const t={OK:"ok",OLD:"old",OFF:"off"};const s={PASSWORD:"password",KEY:"key"};const n={OK:"ok",FAILED:"failed"};const i={SUPABASE:"supabase",PUSHER:"pusher",ASTRADB:"astradb",SEATABLE:"seatable",NORTHFLANK:"northflank",RENDER:"render",REDIS:"redis",CLOUDFLARE:"cloudflare",POSTGRESQL:"postgresql",BITIO:"bitio",YC:"yc"};const o={PPP_ASPIRANT_WORKER:"ppp-aspirant-worker",CLOUDFLARE_WORKER:"cloudflare-worker",CLOUD_PPP_ASPIRANT:"cloud-ppp-aspirant",DEPLOYED_PPP_ASPIRANT:"deployed-ppp-aspirant",SYSTEMD_PPP_ASPIRANT:"systemd-ppp-aspirant",SUPABASE_PARSER:"supabase-parser",NYSE_NSDQ_HALTS:"nyse-nsdq-halts"};const a={ACTIVE:"active",STOPPED:"stopped",FAILED:"failed"};const c={BINANCE:"BINANCE",BYBIT_LINEAR:"BYBIT_LINEAR",BYBIT_SPOT:"BYBIT_SPOT",MOEX:"MOEX",SPBX:"SPBX",US:"US",UTEX_MARGIN_STOCKS:"UTEX_MARGIN_STOCKS",RUS:"RUS",CUSTOM:"CUSTOM",MOEX_SECURITIES:"MOEX_SECURITIES",MOEX_FX_METALS:"MOEX_FX_METALS",MOEX_FORTS:"MOEX_FORTS",CAPITALCOM:"CAPITALCOM"};const u=[c.BINANCE,c.BYBIT_SPOT,c.BYBIT_LINEAR];const l={ALPACA:"alpaca",ALOR:"alor",TINKOFF:"tinkoff",UTEX:"utex",PSINA:"psina",BINANCE:"binance",HUOBI:"huobi",BYBIT:"bybit",MEXC:"mexc",FINAM:"finam",IB:"ib",CAPITALCOM:"capitalcom",UNKNOWN:"unknown"};const d={MARKET_DATA_RECORDER:"market-data-recorder",STOP_LOSS_TAKE_PROFIT:"stop-loss-take-profit",CUSTOM:"custom"};const T={BINANCE:"BINANCE",BYBIT_LINEAR:"BYBIT_LINEAR",BYBIT_SPOT:"BYBIT_SPOT",UTEX_MARGIN_STOCKS:"UTEX_MARGIN_STOCKS",PSINA_US_STOCKS:"PSINA_US_STOCKS",ALOR_SPBX:"ALOR_SPBX",ALOR_MOEX_SECURITIES:"ALOR_MOEX_SECURITIES",ALOR_MOEX_FX_METALS:"ALOR_MOEX_FX_METALS",ALOR_FORTS:"ALOR_FORTS",TINKOFF:"TINKOFF",FINAM:"FINAM",ALPACA:"ALPACA",IB:"IB",CAPITALCOM:"CAPITALCOM"};const E={ALOR_OPENAPI_V2:"alor-openapi-v2",ALPACA_V2_PLUS:"alpaca-v2-plus",TINKOFF_GRPC_WEB:"tinkoff-grpc-web",IB:"ib",CAPITALCOM:"capitalcom",UTEX_MARGIN_STOCKS:"utex-margin-stocks",BINANCE_V3:"binance-v3",MEXC_V3:"mexc-v3",BYBIT_V5:"bybit-v5",FINAM_TRADE_API:"finam-trade-api",PAPER_TRADE:"paper-trade",COMBINED_L1:"combined-l1",COMBINED_ORDERBOOK:"combined-orderbook",CUSTOM:"custom"};const m={CAPS_LIMIT_ORDERS:"caps-limit-orders",CAPS_MARKET_ORDERS:"caps-marker-orders",CAPS_ACTIVE_ORDERS:"caps-active-orders",CAPS_CONDITIONAL_ORDERS:"caps-conditional-orders",CAPS_ORDERBOOK:"caps-orderbook",CAPS_TIME_AND_SALES:"caps-time-and-sales",CAPS_POSITIONS:"caps-positions",CAPS_TIMELINE:"caps-timeline",CAPS_LEVEL1:"caps-level1",CAPS_EXTENDED_LEVEL1:"caps-extended-level1",CAPS_CHARTS:"caps-charts",CAPS_MIC:"caps-mic",CAPS_ORDER_DESTINATION:"caps-order-destination",CAPS_ORDER_TIF:"caps-order-tif",CAPS_ORDER_DISPLAY_SIZE:"caps-order-display-size",CAPS_US_NBBO:"caps-us-nbbo",CAPS_NSDQ_TOTALVIEW:"caps-nsdq-totalview",CAPS_ARCABOOK:"caps-arcabook",CAPS_BLUEATS:"caps-blueats",CAPS_NYSE_OPENBOOK:"caps-nyse-openbook",CAPS_DIRECTEDGE_BOOK:"caps-directedge-book",CAPS_BZX_BOOK:"caps-bzx-book",CAPS_NOII:"caps-noii",CAPS_PAPER:"caps-paper"};const O={TRADER:"trader",DAY_VOLUME:"day-volume",STATUS:"status",TRADING_STATUS:"trading-status",LAST_PRICE:"last-price",LAST_PRICE_ABSOLUTE_CHANGE:"last-price-absolute-change",LAST_PRICE_RELATIVE_CHANGE:"last-price-relative-change",EXTENDED_LAST_PRICE:"extended-last-price",EXTENDED_LAST_PRICE_ABSOLUTE_CHANGE:"extended-last-price-absolute-change",EXTENDED_LAST_PRICE_RELATIVE_CHANGE:"extended-last-price-relative-change",BEST_BID:"best-bid",BEST_ASK:"best-ask",MIDPOINT:"midpoint",ORDERBOOK:"orderbook",MARKET_PRINT:"market-print",POSITION:"position",POSITION_SIZE:"position-size",POSITION_AVERAGE:"position-average",ACTIVE_ORDER:"active-order",CONDITIONAL_ORDER:"conditional-order",TIMELINE_ITEM:"timeline-item",CANDLE:"candle",NOII:"noii",SPRINT:"sprint",LOCATE:"locate"};const f={INSTRUMENT:"instrument",SYMBOL:"symbol",INSTRUMENT_TYPE:"instrument-type",POSITION_AVAILABLE:"position-available",POSITION_AVERAGE:"position-average",TOTAL_AMOUNT:"total-amount",EXTENDED_TOTAL_AMOUNT:"extended-total-amount",BEST_BID:"best-bid",BEST_ASK:"best-ask",LAST_PRICE:"last-price",LAST_PRICE_ABSOLUTE_CHANGE:"last-price-absolute-change",LAST_PRICE_RELATIVE_CHANGE:"last-price-relative-change",EXTENDED_LAST_PRICE:"extended-last-price",EXTENDED_LAST_PRICE_ABSOLUTE_CHANGE:"extended-last-price-absolute-change",EXTENDED_LAST_PRICE_RELATIVE_CHANGE:"extended-last-price-relative-change",PL_ABSOLUTE:"pl-absolute",PL_RELATIVE:"pl-relative",EXTENDED_PL_ABSOLUTE:"extended-pl-absolute",EXTENDED_PL_RELATIVE:"extended-pl-relative",DAY_VOLUME:"day-volume",TRADING_STATUS:"trading-status",FORMATTED_VALUE:"formatted-value"};const p={ORDER:"order",SCALPING_BUTTONS:"scalping-buttons",ACTIVE_ORDERS:"active-orders",LIGHT_CHART:"light-chart",ORDERBOOK:"orderbook",TIME_AND_SALES:"time-and-sales",PORTFOLIO:"portfolio",BALANCES:"balances",LIST:"list",TIMELINE:"timeline",CLOCK:"clock",MARQUEE:"marquee",TCC:"tcc",FRAME:"frame",NOII:"noii",MIGRATION:"migration",OTHER:"other"};let I;(function(e){e[e["OPERATION_TYPE_UNSPECIFIED"]=0]="OPERATION_TYPE_UNSPECIFIED";e[e["OPERATION_TYPE_INPUT"]=1]="OPERATION_TYPE_INPUT";e[e["OPERATION_TYPE_BOND_TAX"]=2]="OPERATION_TYPE_BOND_TAX";e[e["OPERATION_TYPE_OUTPUT_SECURITIES"]=3]="OPERATION_TYPE_OUTPUT_SECURITIES";e[e["OPERATION_TYPE_OVERNIGHT"]=4]="OPERATION_TYPE_OVERNIGHT";e[e["OPERATION_TYPE_TAX"]=5]="OPERATION_TYPE_TAX";e[e["OPERATION_TYPE_BOND_REPAYMENT_FULL"]=6]="OPERATION_TYPE_BOND_REPAYMENT_FULL";e[e["OPERATION_TYPE_SELL_CARD"]=7]="OPERATION_TYPE_SELL_CARD";e[e["OPERATION_TYPE_DIVIDEND_TAX"]=8]="OPERATION_TYPE_DIVIDEND_TAX";e[e["OPERATION_TYPE_OUTPUT"]=9]="OPERATION_TYPE_OUTPUT";e[e["OPERATION_TYPE_BOND_REPAYMENT"]=10]="OPERATION_TYPE_BOND_REPAYMENT";e[e["OPERATION_TYPE_TAX_CORRECTION"]=11]="OPERATION_TYPE_TAX_CORRECTION";e[e["OPERATION_TYPE_SERVICE_FEE"]=12]="OPERATION_TYPE_SERVICE_FEE";e[e["OPERATION_TYPE_BENEFIT_TAX"]=13]="OPERATION_TYPE_BENEFIT_TAX";e[e["OPERATION_TYPE_MARGIN_FEE"]=14]="OPERATION_TYPE_MARGIN_FEE";e[e["OPERATION_TYPE_BUY"]=15]="OPERATION_TYPE_BUY";e[e["OPERATION_TYPE_BUY_CARD"]=16]="OPERATION_TYPE_BUY_CARD";e[e["OPERATION_TYPE_INPUT_SECURITIES"]=17]="OPERATION_TYPE_INPUT_SECURITIES";e[e["OPERATION_TYPE_SELL_MARGIN"]=18]="OPERATION_TYPE_SELL_MARGIN";e[e["OPERATION_TYPE_BROKER_FEE"]=19]="OPERATION_TYPE_BROKER_FEE";e[e["OPERATION_TYPE_BUY_MARGIN"]=20]="OPERATION_TYPE_BUY_MARGIN";e[e["OPERATION_TYPE_DIVIDEND"]=21]="OPERATION_TYPE_DIVIDEND";e[e["OPERATION_TYPE_SELL"]=22]="OPERATION_TYPE_SELL";e[e["OPERATION_TYPE_COUPON"]=23]="OPERATION_TYPE_COUPON";e[e["OPERATION_TYPE_SUCCESS_FEE"]=24]="OPERATION_TYPE_SUCCESS_FEE";e[e["OPERATION_TYPE_DIVIDEND_TRANSFER"]=25]="OPERATION_TYPE_DIVIDEND_TRANSFER";e[e["OPERATION_TYPE_ACCRUING_VARMARGIN"]=26]="OPERATION_TYPE_ACCRUING_VARMARGIN";e[e["OPERATION_TYPE_WRITING_OFF_VARMARGIN"]=27]="OPERATION_TYPE_WRITING_OFF_VARMARGIN";e[e["OPERATION_TYPE_DELIVERY_BUY"]=28]="OPERATION_TYPE_DELIVERY_BUY";e[e["OPERATION_TYPE_DELIVERY_SELL"]=29]="OPERATION_TYPE_DELIVERY_SELL";e[e["OPERATION_TYPE_TRACK_MFEE"]=30]="OPERATION_TYPE_TRACK_MFEE";e[e["OPERATION_TYPE_TRACK_PFEE"]=31]="OPERATION_TYPE_TRACK_PFEE";e[e["OPERATION_TYPE_TAX_PROGRESSIVE"]=32]="OPERATION_TYPE_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_BOND_TAX_PROGRESSIVE"]=33]="OPERATION_TYPE_BOND_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_DIVIDEND_TAX_PROGRESSIVE"]=34]="OPERATION_TYPE_DIVIDEND_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_BENEFIT_TAX_PROGRESSIVE"]=35]="OPERATION_TYPE_BENEFIT_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_CORRECTION_PROGRESSIVE"]=36]="OPERATION_TYPE_TAX_CORRECTION_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO_PROGRESSIVE"]=37]="OPERATION_TYPE_TAX_REPO_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO"]=38]="OPERATION_TYPE_TAX_REPO";e[e["OPERATION_TYPE_TAX_REPO_HOLD"]=39]="OPERATION_TYPE_TAX_REPO_HOLD";e[e["OPERATION_TYPE_TAX_REPO_REFUND"]=40]="OPERATION_TYPE_TAX_REPO_REFUND";e[e["OPERATION_TYPE_TAX_REPO_HOLD_PROGRESSIVE"]=41]="OPERATION_TYPE_TAX_REPO_HOLD_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO_REFUND_PROGRESSIVE"]=42]="OPERATION_TYPE_TAX_REPO_REFUND_PROGRESSIVE";e[e["OPERATION_TYPE_DIV_EXT"]=43]="OPERATION_TYPE_DIV_EXT";e[e["OPERATION_TYPE_TAX_CORRECTION_COUPON"]=44]="OPERATION_TYPE_TAX_CORRECTION_COUPON";e[e["OPERATION_TYPE_CASH_FEE"]=45]="OPERATION_TYPE_CASH_FEE";e[e["OPERATION_TYPE_OUT_FEE"]=46]="OPERATION_TYPE_OUT_FEE";e[e["OPERATION_TYPE_OUT_STAMP_DUTY"]=47]="OPERATION_TYPE_OUT_STAMP_DUTY";e[e["OPERATION_TYPE_OUTPUT_SWIFT"]=50]="OPERATION_TYPE_OUTPUT_SWIFT";e[e["OPERATION_TYPE_INPUT_SWIFT"]=51]="OPERATION_TYPE_INPUT_SWIFT";e[e["OPERATION_TYPE_OUTPUT_ACQUIRING"]=53]="OPERATION_TYPE_OUTPUT_ACQUIRING";e[e["OPERATION_TYPE_INPUT_ACQUIRING"]=54]="OPERATION_TYPE_INPUT_ACQUIRING";e[e["OPERATION_TYPE_OUTPUT_PENALTY"]=55]="OPERATION_TYPE_OUTPUT_PENALTY";e[e["OPERATION_TYPE_ADVICE_FEE"]=56]="OPERATION_TYPE_ADVICE_FEE";e[e["OPERATION_TYPE_TRANS_IIS_BS"]=57]="OPERATION_TYPE_TRANS_IIS_BS";e[e["OPERATION_TYPE_TRANS_BS_BS"]=58]="OPERATION_TYPE_TRANS_BS_BS";e[e["OPERATION_TYPE_OUT_MULTI"]=59]="OPERATION_TYPE_OUT_MULTI";e[e["OPERATION_TYPE_INP_MULTI"]=60]="OPERATION_TYPE_INP_MULTI";e[e["OPERATION_TYPE_OVER_PLACEMENT"]=61]="OPERATION_TYPE_OVER_PLACEMENT";e[e["OPERATION_TYPE_OVER_COM"]=62]="OPERATION_TYPE_OVER_COM";e[e["OPERATION_TYPE_OVER_INCOME"]=63]="OPERATION_TYPE_OVER_INCOME";e[e["OPERATION_TYPE_OPTION_EXPIRATION"]=64]="OPERATION_TYPE_OPTION_EXPIRATION";e[e["OPERATION_TYPE_LOCATE_FEE"]=800]="OPERATION_TYPE_LOCATE_FEE";e[e["UNRECOGNIZED"]=-1]="UNRECOGNIZED"})(I||(I={}));const _={UNSPECIFIED:"UNSPECIFIED",NOT_AVAILABLE_FOR_TRADING:"NOT_AVAILABLE_FOR_TRADING",OPENING_PERIOD:"OPENING_PERIOD",CLOSING_PERIOD:"CLOSING_PERIOD",BREAK_IN_TRADING:"BREAK_IN_TRADING",NORMAL_TRADING:"NORMAL_TRADING",CLOSING_AUCTION:"CLOSING_AUCTION",DARK_POOL_AUCTION:"DARK_POOL_AUCTION",DISCRETE_AUCTION:"DISCRETE_AUCTION",OPENING_AUCTION_PERIOD:"OPENING_AUCTION_PERIOD",TRADING_AT_CLOSING_AUCTION_PRICE:"TRADING_AT_CLOSING_AUCTION_PRICE",SESSION_ASSIGNED:"SESSION_ASSIGNED",SESSION_CLOSE:"SESSION_CLOSE",SESSION_OPEN:"SESSION_OPEN",DEALER_NORMAL_TRADING:"DEALER_NORMAL_TRADING",DEALER_BREAK_IN_TRADING:"DEALER_BREAK_IN_TRADING",DEALER_NOT_AVAILABLE_FOR_TRADING:"DEALER_NOT_AVAILABLE_FOR_TRADING",PREMARKET:"PREMARKET",AFTER_HOURS:"AFTER_HOURS",TRADING_SUSPENDED:"TRADING_SUSPENDED",DELISTED:"DELISTED",IPO_TODAY:"IPO_TODAY",QUOTATION_RESUMPTION:"QUOTATION_RESUMPTION",SHORT_SALE_RESTRICTION:"SHORT_SALE_RESTRICTION",MARKET_IMBALANCE:"MARKET_IMBALANCE",MARKET_CLOSE_IMBALANCE:"MARKET_CLOSE_IMBALANCE",PRICE_INDICATION:"PRICE_INDICATION",TRADING_RANGE_INDICATION:"TRADING_RANGE_INDICATION"};function isPredefinedWidgetType(e){return[p.ORDER,p.SCALPING_BUTTONS,p.ACTIVE_ORDERS,p.LIGHT_CHART,p.ORDERBOOK,p.TIME_AND_SALES,p.PORTFOLIO,p.BALANCES,p.LIST,p.TIMELINE,p.CLOCK,p.MARQUEE,p.TCC].includes(e)}function getInstrumentDictionaryMeta(e){let t;let r;let s;switch(e){case T.BYBIT_LINEAR:t=c.BYBIT_LINEAR;r=l.BYBIT;s=[c.BYBIT_LINEAR];break;case T.BYBIT_SPOT:t=c.BYBIT_SPOT;r=l.BYBIT;s=[c.BYBIT_SPOT];break;case T.BINANCE:t=c.BINANCE;r=l.BINANCE;s=[c.BINANCE];break;case T.UTEX_MARGIN_STOCKS:t=c.UTEX_MARGIN_STOCKS;r=l.UTEX;s=[c.UTEX_MARGIN_STOCKS];break;case T.ALPACA:t=c.US;r=l.ALPACA;s=[c.ALPACA];break;case T.IB:t=c.CUSTOM;r=l.IB;s=[c.US];break;case T.PSINA_US_STOCKS:t=c.US;r=l.PSINA;s=[c.US];break;case T.ALOR_SPBX:t=c.SPBX;r=l.ALOR;s=[c.SPBX];break;case T.ALOR_MOEX_SECURITIES:t=c.MOEX_SECURITIES;r=l.ALOR;s=[c.MOEX];break;case T.ALOR_MOEX_FX_METALS:t=c.MOEX_FX_METALS;r=l.ALOR;s=[c.MOEX];break;case T.ALOR_FORTS:t=c.MOEX_FORTS;r=l.ALOR;s=[c.MOEX];break;case T.TINKOFF:t=c.RUS;r=l.TINKOFF;s=[c.MOEX,c.SPBX];break;case T.FINAM:t=c.CUSTOM;r=l.FINAM;s=[c.MOEX,c.US,c.SPBX];break;case T.CAPITALCOM:t=c.CAPITALCOM;r=l.CAPITALCOM;s=[c.CAPITALCOM];break}return{exchange:t,broker:r,exchangeList:s}}if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.ppp??={i18nLocale:"en-US"}}const h=null&&["EUR","AMD","KZT","KGS","UZS","USD","CNY","TJS","BYN","HKD","XAU","TRY","XAG","RUB"];function stringToFloat(e){if(typeof e==="number"){return e}if(!e){return 0}if(e.includes(",")&&e.includes(".")){e=e.replaceAll(/,/gi,"")}return parseFloat(e.replace(",",".").replace(/\s/g,"").replace(/[^\x20-\x7E]/g,""))}function decimalSeparator(){const e=1.1;return Intl.NumberFormat(ppp.i18nLocale).formatToParts(e).find((e=>e.type==="decimal")).value}const A=decimalSeparator();function getInstrumentMinPriceIncrement(e,t,r){if(!e)return 0;if(typeof t!=="number"||isNaN(t))return e.minPriceIncrement||.01;t=stringToFloat(t);let s=e.minPriceIncrement;if(!s||r){s=t<1?1e-4:.01}return s}function getInstrumentPrecision(e,t,r){if(!e)return 0;if(e.type==="currency"){return 4}if(t===0||t==="0"){return 2}const s=getInstrumentMinPriceIncrement(e,t,r);const[n,i]=s.toString().split(".");return i?i.length:0}function getInstrumentQuantityPrecision(e){if(!e)return 0;const[t,r]=(e.minQuantityIncrement??0).toString().split(".");return r?r.length:0}function formatDateWithOptions(e,t={}){if(!e)return"—";return new Intl.DateTimeFormat(ppp.i18nLocale,Object.assign({hour12:false},t)).format(new Date(e))}function formatDate(e){if(!e)return"—";return new Intl.DateTimeFormat(ppp.i18nLocale,{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:false}).format(new Date(e))}function formatDuration(e=0,t={}){if(typeof e!=="number")return"—";return new Date(e*1e3).toLocaleTimeString(ppp.i18nLocale,Object.assign({timeZone:"Etc/UTC",hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"},t))}function formatPrice(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";if(!t.currency)return"—";const s=getInstrumentPrecision(t,e);if(t.type==="future"||t.type==="index"){return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s}).format(e)+" pt."}if(!h.includes(t?.currency)){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s},r)).format(e)+(t.currency==="N/A"?"":` ${t.currency}`)}return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",currency:t.currency,minimumFractionDigits:s,maximumFractionDigits:s},r)).format(e)+` ${priceCurrencySymbol(t)}`}function formatPriceWithoutCurrency(e,t,r){if(typeof t==="undefined"){return(e||"").toString().replace(".",A)}if(typeof e!=="number"||isNaN(e))return"—";const s=getInstrumentPrecision(t,e,r);return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s}).format(e)}function formatCommission(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";if(!t.currency)return"—";if(h.indexOf(t?.currency)===-1){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:2,maximumFractionDigits:3},r)).format(e)+` ${t.currency}`}return new Intl.NumberFormat(ppp.i18nLocale,{style:"currency",currency:t.currency,minimumFractionDigits:2,maximumFractionDigits:3}).format(e)}function formatAmount(e,t={},r={}){const s=t.currency??t.quoteCryptoAsset;if(!s||typeof e!=="number"||isNaN(e))return"—";if(t.type==="future"){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal"},r)).format(e)+" пт."}if(!h.includes(s)){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:0},r)).format(e)+` ${s}`}return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"currency",minimumFractionDigits:0,currency:s},r)).format(e)}function formatAbsoluteChange(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:2,maximumFractionDigits:Math.max(2,getInstrumentPrecision(t,e)),signDisplay:"always"},r)).format(e)}function formatRelativeChange(e,t={}){if(typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"percent",minimumFractionDigits:2,maximumFractionDigits:2,signDisplay:"always"},t)).format(e)}function formatPercentage(e){if(typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,{style:"percent",maximumFractionDigits:3}).format(e)}function formatQuantity(e,t){if(typeof e!=="number"||isNaN(e))return"—";let r=0;if(typeof t?.minQuantityIncrement==="number"){const[e,s]=t.minQuantityIncrement.toString().split(".");r=s?.length??0}return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:r,maximumFractionDigits:r}).format(e)}function cyrillicToLatin(e){if(/^\p{Script=Cyrillic}+$/u.test(e)){const t='QWERTYUIOP{}ASDFGHJKL:"ZXCVBNM<>~';const r="ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁ";const s={};for(let e=0;e<r.length;e++){s[r[e]]=t[e]}return e.split("").map((e=>s[e.toUpperCase()])).join("")}else{return e}}function latinToCyrillic(e){if(/[a-z]+/i.test(e)){const t="QWERTYUIOP{}ASDFGHJKL:\"ZXCVBNM<>~,.`'[];";const r="ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁБЮЁЭХЪЖ";const s={};for(let e=0;e<r.length;e++){s[t[e]]=r[e]}return e.split("").map((e=>s[e.toUpperCase()])).join("")}else{return e}}function priceCurrencySymbol(e){if(e?.type==="future"||e?.type==="index")return"pt.";if(e?.type==="cryptocurrency")return e.quoteCryptoAsset;if(e?.currency==="USDT")return"USDT";if(e?.currency&&e.currency!=="N/A"){return(0).toLocaleString(ppp.i18nLocale,{style:"currency",currency:e.currency,minimumFractionDigits:0,maximumFractionDigits:0}).replace(/\d/g,"").trim()}else return""}function currencyName(e){if(h.indexOf(e)===-1){return e}if(!e)return"—";const t=new Intl.DisplayNames([ppp.i18nLocale],{type:"currency"});return t.of(e)}function isDST(){const e=new Date;const t=e.getFullYear();const r=new Date(t,2,1);const s=(7-r.getDay())%7;const n=r.getDate()+s+7;const i=new Date(t,2,n);const o=new Date(t,10,1);const a=(7-o.getDay())%7;const c=o.getDate()+a;const u=new Date(t,10,c);return e.getTime()<=u.getTime()&&e.getTime()>=i.getTime()}function formatFileSize(e,{si:t=true,dp:r=1,useIntl:s=false}={}){if(s){return new Intl.NumberFormat(ppp.i18nLocale,{style:"unit",unit:"byte",notation:"compact",unitDisplay:"narrow"}).format(e)}const n=t?1e3:1024;if(Math.abs(e)<n){return e+" B"}const i=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];let o=-1;const a=10**r;do{e/=n;++o}while(Math.round(Math.abs(e)*a)/a>=n&&o<i.length-1);return e.toFixed(r)+" "+i[o]}function formatNumber(e,t={}){return new Intl.NumberFormat(ppp.i18nLocale,t).format(e)}function formatVolume(e,t={}){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",notation:"compact",minimumFractionDigits:1,maximumFractionDigits:2},t)).format(e)}function parseDistance(e=""){let t="";e=e.trim();if(e.endsWith("%")){t="%"}else if(e.endsWith("+")){t="+"}e=e.replace(",",".").replace(/\s/g,"").replace(/[^\x20-\x7E]/g,"");let r=parseFloat(e);if(t==="+"){r=Math.trunc(r)}if(isNaN(r)){return{}}return{value:r,unit:t}}function distanceToString({value:e,unit:t}={}){if(typeof e==="undefined"){return""}if(t==="%"){return new Intl.NumberFormat(ppp.i18nLocale,{style:"percent",maximumFractionDigits:2}).format(e/100)}else if(t==="+"){return`${Math.trunc(e)} +`}else{return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal"}).format(e)}}class ConflictError extends Error{constructor({message:e="Conflict.",href:t,status:r=409,pppMessage:s}={}){super(e);this.name=this.constructor.name;this.status=r;this.href=t;this.pppMessage=s}}class AllocationNotFoundError extends Error{constructor({message:e}={}){super(e);this.name=this.constructor.name}}class DocumentNotFoundError extends Error{constructor({message:e,documentId:t}={}){super(e);this.name=this.constructor.name;this.documentId=t}}class ValidationError extends Error{constructor({message:e,status:t=422,element:r}={}){super(e);this.name="ValidationError";this.element=r;this.status=t}}class FetchError extends Error{constructor({message:e="Fetch failed.",status:t=400,pppMessage:r}={}){super(e);this.name=this.constructor.name;this.status=t;this.pppMessage=r}}async function maybeFetchError(e,t){let r,s;if(typeof e==="function"){const t=await e();r=t.ok;s=t.response}else{r=e.ok;s=e}if(!r){throw new FetchError({...s,...{message:await s.text(),pppMessage:t}})}else return s}class TradingError extends Error{constructor({message:e="Trading error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}serialize(){return{name:this.name,args:{message:this.message,details:this.details}}}}class RemoteTraderError extends Error{constructor({message:e="Trader error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}serialize(){return{name:this.name,args:{message:this.message,details:this.details}}}}class AuthorizationError extends Error{constructor({message:e="Authorization error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class ConnectionLimitExceededError extends Error{constructor({message:e="Connection limit exceeded."}={}){super(e);this.name=this.constructor.name}}class TraderTrinityError extends Error{constructor({message:e="Trader trinity error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class ConnectionError extends Error{constructor({message:e="Connection error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class UTEXBlockError extends Error{constructor({message:e="UTEX block error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class NoInstrumentsError extends Error{constructor({message:e="No instruments.",trader:t,currentCacheVersion:r,lastCacheVersion:s}={}){super(e);this.name=this.constructor.name;this.trader=t;this.currentCacheVersion=r;this.lastCacheVersion=s}}class StaleInstrumentCacheError extends Error{constructor({message:e="Stale instrument cache.",trader:t,currentCacheVersion:r,lastCacheVersion:s}={}){super(e);this.name=this.constructor.name;this.trader=t;this.currentCacheVersion=r;this.lastCacheVersion=s}}class EventBus{#e={};isValidType(e){return typeof e==="string"}isValidHandler(e){return typeof e==="function"}on(e,t){if(!e||!t)return false;if(!this.isValidType(e))return false;if(!this.isValidHandler(t))return false;let r=this.#e[e];if(!r)r=this.#e[e]=[];if(r.indexOf(t)>=0)return false;t._once=false;r.push(t);return true}once(e,t){if(!e||!t)return false;if(!this.isValidType(e))return false;if(!this.isValidHandler(t))return false;const r=this.on(e,t);if(r){t._once=true}return r}off(e,t){if(!e)return this.offAll();if(!t){this.#e[e]=[];return}if(!this.isValidType(e))return;if(!this.isValidHandler(t))return;const r=this.#e[e];if(!r||!r.length)return;for(let e=0;e<r.length;e++){const s=r[e];if(s===t){r.splice(e,1);break}}}offAll(){this.#e={}}emit(e,t){if(!e||!this.isValidType(e))return;const r=this.#e[e];if(!r||!r.length)return;const s=this.createEvent(e,t);for(const t of r){if(!this.isValidHandler(t))continue;if(t._once)s.once=true;t(s);if(s.once)this.off(e,t)}}has(e,t){if(!e||!this.isValidType(e))return false;const r=this.#e[e];if(!r||!r.length)return false;if(!t||!this.isValidHandler(t))return true;return r.indexOf(t)>=0}getHandlers(e){if(!e||!this.isValidType(e))return[];return this.#e[e]||[]}createEvent(e,t,r=false){const s={type:e,detail:t,timestamp:Date.now(),once:r};return s}}function $throttle(e,t){let r=false,s,n;function wrapper(){if(r){s=arguments;n=this;return}e.apply(this,arguments);r=true;setTimeout((function(){r=false;if(s){wrapper.apply(n,s);s=n=null}}),t)}return wrapper}function $debounce(e,t){let r;return function(){clearTimeout(r);r=setTimeout((()=>e.apply(this,arguments)),t)}}function throttle(e=0){return(t,r,s)=>{if(!s||typeof s.value!=="function"){throw new Error("throttle can only decorate functions.")}const n=s.value;s.value=$throttle(n,e);Object.defineProperty(t,r,s)}}function debounce(e=0){return(t,r,s)=>{if(!s||typeof s.value!=="function"){throw new Error("debounce can only decorate functions.")}const n=s.value;s.value=$debounce(n,e);Object.defineProperty(t,r,s)}}async function later(e){return new Promise((function(t){setTimeout(t,e)}))}function unsupportedInstrument(e=""){return{symbol:e,fullName:"Инструмент не поддерживается",notSupported:true}}class TraderDatum{sources={};refs=new Map;values=new Map;#t=new Map;trader;doNotSaveValue;constructor(e){this.trader=e}filter(e,t,r,s,n){return true}hasSource(e){for(const t in this.sources){if(this.sources[t].has(e)){return true}}return false}dataArrived(e,t,r={}){if(!t){return}if(this.doNotSaveValue!==true&&r.doNotSaveValue!==true){const s=this.trader.getSymbol(t);if(typeof r.saveSlot==="undefined"){this.values.set(s,e)}else if(r.saveSlot>=0){const t=this.values.get(s)??[];t[r.saveSlot]=e;this.values.set(s,t)}}for(const s in this.sources){for(const[n,i]of this.sources[s]){if(this.trader.instrumentsAreEqual(n.instrument,t)&&this.filter(e,t,n,s,r)){this.trader.assignSourceField(n,i,this[s]?.(e,t,{source:n,options:r})??this.emptyValue(s)??"—")}}}}emptyValue(e){switch(e){case O.CANDLE:case O.MARKET_PRINT:case O.ORDERBOOK:case O.NOII:return{};case O.TRADING_STATUS:case O.STATUS:return""}return"—"}async subscribe(e,t,r){if(!this.#t.has(e)&&e.canChangeInstrument){const listener=async({detail:e})=>{const{source:t,oldValue:r}=e;for(const e of Object.keys(this.sources)){if(this.sources[e].has(t)){const s=this.sources[e].get(t);if(r){await this.unsubscribe(t,r)}await this.subscribe(t,s,e)}}};e.addEventListener("instrumentchange",listener);this.#t.set(e,listener)}if(!e.instrument){return}const s=this.trader.getSymbol(e.instrument);const n=this.refs.get(s)??0;if(n===0){this.refs.set(s,1);return this.firstReferenceAdded?.(e,s,r)}else{this.refs.set(s,n+1);const i=this.values.get(s);if(!Array.isArray(i)||this.slotted===false){if(typeof i!=="undefined"){if(this.filter(i,e.instrument,e,r,{origin:"datum"})){if(e.instrument){this.trader.assignSourceField(e,t,this[r]?.(i,e.instrument,{source:e,origin:"datum"})??this.emptyValue(r)??"—")}else{this.trader.assignSourceField(e,t,this.emptyValue(r)??"—")}}}}else{for(const s of i){if(this.filter(s,e.instrument,e,r,{origin:"datum"})){if(e.instrument&&typeof s!=="undefined"){this.trader.assignSourceField(e,t,this[r]?.(s,e.instrument,{source:e,origin:"datum"})??this.emptyValue(r)??"—")}else{this.trader.assignSourceField(e,t,this.emptyValue(r)??"—")}}}}}}async unsubscribe(e,t){if(!this.hasSource(e)&&e.canChangeInstrument){const t=this.#t.get(e);if(t){e.removeEventListener("instrumentchange",t);this.#t.delete(e)}}if(!t&&!e.instrument){return}const r=this.trader.getSymbol(t??e.instrument);const s=this.refs.get(r)??0;if(s===1){this.refs.delete(r);if(this.doNotClearValue!==true){this.values.delete(r)}return this.lastReferenceRemoved?.(e,r)}else if(s>1){this.refs.set(r,Math.max(0,s-1))}}}class GlobalTraderDatum{sources={};refCount=0;trader;value=new Map;#t=new Map;doNotSaveValue;doNotClearValue;manualAssignment;constructor(e){this.trader=e}filter(e,t,r,s,n){return true}dataArrived(e,t={}){const r=this.valueKeyForData(e);if(typeof r!=="undefined"){if(this.doNotSaveValue!==true&&t.doNotSaveValue!==true){this.value.set(r,e)}for(const s in this.sources){for(const[n,i]of this.sources[s]){if(this.filter(e,n,r,s,t)){if(this.manualAssignment!==true){this.trader.assignSourceField(n,i,this[s]?.(e,n,{key:r,field:i,origin:t.origin})??this.emptyValue(s)??"—")}else{this[s]?.(e,n,{key:r,field:i,origin:t.origin})}}}}}else{this.trader.$$debug("no key for data: %o",e)}}emptyValue(e){switch(e){case O.POSITION_SIZE:return 0;case O.POSITION_AVERAGE:return 0;case O.POSITION:case O.ACTIVE_ORDER:case O.TIMELINE_ITEM:case O.TRADER:return{}}return"—"}valueKeyForData(e){return e?.symbol}async subscribe(e,t,r){if(!this.#t.has(e)&&e.canChangeInstrument){const listener=async({detail:e})=>{const{source:t}=e;for(const e of Object.keys(this.sources)){if(this.sources[e].has(t)){const r=this.sources[e].get(t);this.trader.assignSourceField(t,r,this.emptyValue(e));for(const[s,n]of this.value){if(this.filter(n,t,s,e,{origin:"datum"})){if(this.manualAssignment!==true){this.trader.assignSourceField(t,r,this[e]?.(n,t,{key:s,field:r,origin:"datum"})??this.emptyValue(e)??"—")}else{this[e]?.(n,t,{key:s,field:r,origin:"datum"})}}}}}};e.addEventListener("instrumentchange",listener);this.#t.set(e,listener)}if(this.refCount===0){this.refCount=1;return this.firstReferenceAdded?.(e,t,r)}else{this.refCount++;for(const[s,n]of this.value){if(this.filter(n,e,s,r,{origin:"datum"})){if(this.manualAssignment!==true){this.trader.assignSourceField(e,t,this[r]?.(n,e,{key:s,field:t,origin:"datum"})??this.emptyValue(r)??"—")}else{this[r]?.(n,e,{key:s,field:t,origin:"datum"})}}}}}async unsubscribe(e,t,r){if(!this.hasSource(e)&&e.canChangeInstrument){const t=this.#t.get(e);if(t){e.removeEventListener("instrumentchange",t);this.#t.delete(e)}}if(this.refCount===1){this.refCount=0;if(this.doNotClearValue!==true){this.value.clear()}return this.lastReferenceRemoved?.(e,t,r)}else if(this.refCount>1){this.refCount--}}}class TraderEventDatum extends(null&&GlobalTraderDatum){}class ConditionalOrderDatum extends GlobalTraderDatum{async firstReferenceAdded(){for(const e of await this.trader.conditionalOrders()){this.dataArrived(e,{origin:"datum"})}}valueKeyForData(e){return e?.orderId}[O.CONDITIONAL_ORDER](e){return e}}GlobalTraderDatum.prototype.hasSource=TraderDatum.prototype.hasSource;class Trader{datums={};document={};#r=new Map;get instruments(){return this.#r}#s=[];#n=[];createdAt=(new Date).toISOString();constructor(e,t=[]){this.document=e;t.forEach((({type:e,datums:t})=>{const r=new(this.getRealDatumType(e))(this);t.forEach((e=>{r.sources[e]=new Map;this.datums[e]=r}));this.#s.push(r)}))}conditionalOrderIdCounter=0;nextConditionalOrderId(){return`${Date.now()}:${this.conditionalOrderIdCounter++}`}getRealDatumType(e){return e}call(e){return e}serialize(){return{createdAt:this.createdAt,document:this.document,broker:this.getBroker(),dictionary:this.getDictionary(),exchange:this.getExchange(),observedAttributes:this.getObservedAttributes()}}#i(e,t,r){if(e==="global"){return this.#n.find((e=>e.payload.orderId===t))}else if(e==="instrument"){return this.#n.find((e=>e.payload.orderId===t&&this.instrumentsAreEqual(e.instrument,r)))}}async placeConditionalOrder({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i}){if(!r?.orderId){throw new TradingError({message:"Missing payload.orderId.",details:{instrument:e,direction:t,payload:r}})}const o=r.order.singleton;const a=r.order.oneOff===true;let c;if(typeof s==="string"){c=this.#i(o,r.orderId,e);if(!c){const{default:e}=await __nccwpck_require__(930)(`${s}?t=${Date.now()}`);c=new e(this);c.factory=e;!a&&this.#n.push(c)}}else if(typeof n==="string"&&typeof process!=="undefined"&&process.release.name==="node"){c=this.#i(o,r.orderId,e);if(!c){let s;globalThis.pppOrderInstanceForWorkerRecv=e=>s=e;try{globalThis.vm.runInThisContext(n,{filename:r.orderId})}finally{globalThis.pppOrderInstanceForWorkerRecv=null}if(!s){throw new TradingError({message:"Missing pppOrderInstanceForWorkerRecv.",details:{instrument:e,direction:t,payload:r}})}c=new s(this);c.factory=s;!a&&this.#n.push(c)}}else if(typeof i==="function"){c=this.#i(o,r.orderId,e);if(!c){c=new i(this);c.factory=i;!a&&this.#n.push(c)}}if(c){return c.place({instrument:e,direction:t,payload:r})}else{throw new TradingError({message:"Missing orderInstance.",details:{instrument:e,direction:t,payload:r}})}}async pco({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i}){return this.placeConditionalOrder({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i})}conditionalOrders(){const e=[];for(const t of this.#n){if(typeof t.serialize==="function"){e.push(t.serialize())}}return e}async performConditionalOrderAction(e,t,r={}){const s=this.#n.find((t=>t.orderId===e));if(typeof s[t]==="function"){return s[t](r)}}async pcoa(e,t,r={}){return this.performConditionalOrderAction(e,t,r)}async cancelConditionalOrder(e,t={}){const r=this.#n.find((t=>t.orderId===e));if(r){this.#n.splice(this.#n.indexOf(r),1);if(typeof r.cancel==="function"){return r.cancel(t)}}}async cco(e,t={}){return this.cancelConditionalOrder(e,t)}async cancelAllConditionalOrders({instrument:e,filter:t,payload:r={}}={}){const s=[];for(const e of this.#n){s.push({orderId:e.orderId,instrument:e.instrument,side:e.side})}for(const n of s){if(e&&!this.instrumentsAreEqual(n.instrument,e)){continue}if(t==="buy"&&n.side!=="buy"){continue}if(t==="sell"&&n.side!=="sell"){continue}void this.cancelConditionalOrder(n.orderId,r)}}async instrumentsArrived(e){this.#r=e}async subscribeField({source:e,field:t,datum:r}){const s=this.datums[r];if(typeof s!=="undefined"){if(!s.sources[r].has(e)){s.sources[r].set(e,t);return s.subscribe(e,t,r)}}}async subscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){if(typeof s==="string"){await this.subscribeField({source:e,field:r,datum:s})}else if(typeof s==="object"){await this.subscribeField({source:e,field:r,datum:s.datum})}}}async unsubscribeField({source:e,datum:t}){const r=this.datums[t];if(typeof r!=="undefined"){if(r.sources[t].has(e)){r.sources[t].delete(e);return r.unsubscribe(e)}}}async unsubscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){await this.unsubscribeField({source:e,field:r,datum:s})}}async resubscribe(e=[]){const t=[];for(const r of this.#s){for(const s of Object.keys(r.sources)){for(const[n,i]of r.sources[s]){if(!e.length||e.includes(s)){t.push({source:n,field:i,datum:s})}}}}for(const{source:e,field:r,datum:s}of t){await this.unsubscribeField({source:e,field:r,datum:s})}for(const{source:e,field:r,datum:s}of t){await this.subscribeField({source:e,field:r,datum:s})}}async estimate(){return{}}async redisCommand(e,t=[]){if(globalThis.ppp?.runtime?.redis){return globalThis.ppp?.runtime?.redis.call(e,...t)}else{return null}}getEnvVar(e){if(typeof process!=="undefined"&&typeof process.env!=="undefined"){return process.env[e]}}assignSourceField(e,t,r){switch(this.document.runtime){case"main-thread":e[t]=r;break;case"shared-worker":if(e.mainTrader&&e.mainTrader.document._id===self.pppTrader.document._id){e[t]=r;return}e.port.postMessage({type:"assign",sourceID:e.sourceID,field:t,value:r});break;case"url":if(e.mainTrader===this){e[t]=r;return}!e.ws.closed&&e.ws.send(JSON.stringify([{T:"assign",sourceID:e.sourceID,field:t,value:r}]));break}}traderEvent(e={}){if(this.datums[O.TRADER]){for(const[t,r]of this.datums[O.TRADER].sources[O.TRADER]){this.assignSourceField(t,r,e)}}}relativeBondPriceToPrice(e,t){return this.fixPrice(t,e*t.nominal/100)}bondPriceToRelativeBondPrice(e,t){return+(e*100/t.nominal).toFixed(2)}caps(){return this.document.caps??[]}hasCap(e){const t=this.caps();if(typeof e==="string")return t.indexOf(e)>-1;else if(Array.isArray(e))return e.every((e=>t.indexOf(e)>-1));else return false}fixPrice(e,t){t=stringToFloat(t);const r=getInstrumentPrecision(e,t);if(!t||isNaN(t))t=0;const s=getInstrumentMinPriceIncrement(e,t);t=Math.round(t/s)*s;return+t.toFixed(r)}calcDistantPrice(e,t,r,s="down"){if(s!=="down"&&s!=="up"){s="down"}if(!e){return 0}t=stringToFloat(t);if(!t||isNaN(t)){return 0}let n=0;if(r.value>0){if(r.unit==="+"){const i=getInstrumentMinPriceIncrement(e,t)*r.value;n=s==="down"?t-i:t+i}else if(r.unit==="%"){n=s==="down"?t-t*r.value/100:t+t*r.value/100}else{n=Math.max(0,s==="down"?t-r.value:t+r.value)}if(n>0){return this.fixPrice(e,n)}else{return 0}}else{return t}}getSymbol(e={}){let t=e.symbol;if(!t)return"";if(/~/gi.test(t))t=t.split("~")[0];return t}symbolToCanonical(e=""){return e.replace("."," ").replace("-"," ").replace("/"," ")}adoptInstrument(e={},t={}){const r=this.#r.get(e.symbol)??{};let s=e.symbol===r.symbol;if(e.exchange===c.MOEX&&r.exchange!==c.MOEX){s=false}if(r.exchange===c.MOEX&&e.exchange!==c.MOEX){s=false}if(s){return r}else{return unsupportedInstrument(e.symbol)}}instrumentsAreEqual(e,t){const r=this.adoptInstrument(e);const s=this.adoptInstrument(t);return r.symbol===s.symbol&&r.exchange===s.exchange}getBroker(){return"*"}getDictionary(){return null}getExchange(){return"*"}getObservedAttributes(){return[]}getInstrumentIconUrl(e){if(!e||e?.symbol==="PRN"){return"static/instruments/unknown.svg"}if(e?.type==="currency"){return`static/currency/${e.symbol.slice(0,3)}.svg`}let t=e?.symbol;if(t==="TCS"&&e.exchange===c.SPBX){return"static/instruments/stocks/rus/TCSG.svg"}if((e.symbol==="GOLD"||e.symbol==="GOLD~MOEX")&&e.exchange===c.MOEX){return"static/instruments/etfs/rus/GOLD.svg"}if(typeof t==="string"){t=t.split("/")[0].split("-")[0].split("-RM")[0];if(t.endsWith("@GS")||t.endsWith("@DE")||t.endsWith("@GR")||t.endsWith("@UR")||t.endsWith("@KT")){return"static/instruments/unknown.svg"}t=t.split("@US")[0]}if(e?.currency==="HKD"){return`static/instruments/stocks/hk/${t.replace(" ","-")}.svg`}if(e?.currency==="CNY"){return`static/instruments/${e?.type}s/cny/${t.replace(" ","-")}.svg`}const r=e?.symbol?.endsWith("-RM");if(!r){if(e?.exchange===c.MOEX||e?.currency==="RUB"){return`static/instruments/${e?.type}s/rus/${t.replace(" ","-")}.svg`}}if((e?.exchange===c.SPBX||r)&&t!=="TCS"){return`static/instruments/stocks/us/${t.replace(" ","-")}.svg`}if(e?.exchange===c.US){return`static/instruments/stocks/us/${t.replace(" ","-").split("~")[0]}.svg`}return"static/instruments/unknown.svg"}search(e=""){let t=null;const r=[];const s=[];const n=[];const i=[];const o=e.trim().replaceAll(/[^~a-z0-9\.\s\u0400-\u04FF]/gi,"").toUpperCase();const a=cyrillicToLatin(o);const c=latinToCyrillic(o);if(typeof this.instrumentsSearchIndex==="undefined"){this.instrumentsSearchIndex=[];for(const[e,t]of this.instruments){if(e){const e=this.getSymbol(t);const r=e.length;this.instrumentsSearchIndex[r]??={};this.instrumentsSearchIndex[r][e]??=[];this.instrumentsSearchIndex[r][e].push(t)}}}if(o.length){for(const e of this.instrumentsSearchIndex){if(e){for(const u in e){for(const l of e[u]){if(l.removed)continue;let e=l.symbol.replaceAll(/[^~a-z0-9\s\u0400-\u04FF]/gi,"").toUpperCase();const u=this.getSymbol(l);const d=l.fullName.toUpperCase();if((e===o||u===o)&&t===null){t=l}if(r.length<10&&(e.startsWith(o)||e.startsWith(a)||e.startsWith(c))){r.push(l)}if(n.length<10&&(d.startsWith(o)||d.startsWith(a)||d.startsWith(c))){n.push(l)}if(s.length<10&&(new RegExp(o,"ig").test(e)||new RegExp(a,"ig").test(e)||new RegExp(c,"ig").test(e))){s.push(l)}if(d&&i.length<10&&(new RegExp(o,"ig").test(d)||new RegExp(a,"ig").test(d)||new RegExp(c,"ig").test(d))){i.push(l)}}}}}}return{exactSymbolMatch:t,startsWithSymbolMatches:r,regexSymbolMatches:s.sort(((e,t)=>e.fullName.localeCompare(t.fullName))),startsWithFullNameMatches:n.sort(((e,t)=>e.fullName.localeCompare(t.fullName))),regexFullNameMatches:i.sort(((e,t)=>e.fullName.localeCompare(t.fullName)))}}}class USTrader extends Trader{adoptInstrument(e={}){if(![c.SPBX,c.US,c.UTEX_MARGIN_STOCKS].includes(e.exchange)){return unsupportedInstrument(e.symbol)}if(e.symbol==="SPB@US"){return this.instruments.get("SPB")}if(e.symbol==="TCS"&&e.exchange===c.SPBX){return unsupportedInstrument(e.symbol)}let t=true;["FIVE","CARM","ASTR","GOLD"].forEach((r=>{if(this.getSymbol(e)===r&&e.exchange===c.MOEX){t=false}}));if(!t){return unsupportedInstrument(e.symbol)}if(e.symbol?.endsWith("~US")){return super.adoptInstrument({...e,...{symbol:e.symbol.replace("~US","")}})}return super.adoptInstrument(e)}getInstrumentIconUrl(e){if(!e){return"static/instruments/unknown.svg"}if(e.symbol==="PRN"){return"static/instruments/stocks/us/PRN@US.svg"}if(e.currency==="USD"||e.currency==="USDT"){return`static/instruments/stocks/us/${e.symbol.replace(" ","-").replace("/","-")}.svg`}return super.getInstrumentIconUrl(e)}}function pppTraderInstanceForWorkerIs(e){if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.pppTraderInstance??=e}else if(typeof process!=="undefined"&&process.release.name==="node"){globalThis.pppTraderInstanceForWorkerRecv?.(e)}}class RemoteSource{bus=new EventBus;port;sourceID;canChangeInstrument;constructor(e,t,r){this.sourceID=e;this.canChangeInstrument=!!t;this.port=r}instrument;attributes=new Map;getAttribute(e){return this.attributes.get(e)}addEventListener(e,t){return this.bus.on(e,t)}removeEventListener(e,t){return this.bus.off(e,t)}}class RemoteTraderRuntime{document;#o;#a;#c;#u;#l;#d;#T=new Map;get worker(){return this.#c}constructor(e){this.document=e;if(this.document.runtime==="url"){const e=new URL(this.document.runtimeUrl);if(e.protocol==="http:"){e.protocol="ws:"}else{e.protocol="wss:"}this.#d=new URL(e).toString()}}#E(){if(typeof this.#l==="undefined"){this.#l=100}else{this.#l+=100;if(this.#l>500){this.#l=500}}return this.#l}#m(e){if(this.#u?.readyState===WebSocket.OPEN){return this.#u}else if(this.#a&&!e){return this.#a}else{this.#a=new Promise((e=>{this.#u=new WebSocket(this.#d);this.#u.onclose=async()=>{await later(this.#E());e(this.#m(true))};this.#u.onerror=()=>this.#u.close();this.#u.onmessage=({data:t})=>{const r=JSON.parse(t);if(Array.isArray(r)){for(const t of r){if(t.T==="ready"){return e(this.#u)}else if(t.T==="success"&&t.msg==="connected"){return this.#u.send(JSON.stringify({T:"connack",_id:this.document._id}))}else if(t.T==="assign"){const e=this.#T.get(t.sourceID);if(e?.sourceID===t.sourceID){e[t.field]=t.value}}}}}}));return this.#a}}async subscribeField({source:e,field:t,datum:r}){if(this.document.runtime==="shared-worker"){const s=new MessageChannel;s.port1.onmessage=({data:t})=>{if(t?.type==="assign"){if(e.sourceID===t.sourceID){e[t.field]=t.value}}};self.pppPorts[0].postMessage({type:"shared-worker-subscribe-field",document:this.document,port2:s.port2,sourceID:e.sourceID,instrument:e.instrument,canChangeInstrument:e.canChangeInstrument,field:t,datum:r},[s.port2])}else if(this.document.runtime==="url"){await this.#m();this.#u.send(JSON.stringify({T:"source-changed",sourceID:e.sourceID,reason:"instrument",oldValue:null,newValue:e.instrument,canChangeInstrument:e.canChangeInstrument,doNotFire:true}));this.#T.set(e.sourceID,e);return this.#u.send(JSON.stringify({T:"subscribe-field",sourceID:e.sourceID,field:t,datum:r,canChangeInstrument:e.canChangeInstrument}))}}async subscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){if(typeof s==="string"){await this.subscribeField({source:e,field:r,datum:s})}else if(typeof s==="object"){await this.subscribeField({source:e,field:r,datum:s.datum})}}}async unsubscribeField({source:e,field:t,datum:r}){if(this.document.runtime==="shared-worker"){return self.pppPorts[0].postMessage({type:"shared-worker-unsubscribe-field",document:this.document,sourceID:e.sourceID,field:t,datum:r})}else if(this.document.runtime==="url"){await this.#m();return this.#u.send(JSON.stringify({T:"unsubscribe-field",sourceID:e.sourceID,field:t,datum:r}))}}async unsubscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){await this.unsubscribeField({source:e,field:r,datum:s})}}async resubscribe(e=[]){if(this.document.runtime==="shared-worker"){return self.pppPorts[0].postMessage({type:"shared-worker-resubscribe",document:this.document,onlyForDatums:e})}else if(this.document.runtime==="url"){await this.#m();return this.#u.send(JSON.stringify({T:"resubscribe",onlyForDatums:e}))}}async loadSharedOrRemoteTrader(){if(this.#o){return this.#o}else{switch(this.document.runtime){case"main-thread":return null;case"shared-worker":if(this.document._id===self.pppTrader?.document?._id){return self.pppTrader}return this.#o=new Promise((e=>{const t=new MessageChannel;const r=setTimeout((()=>e(null)),5e3);t.port1.onmessage=({data:t})=>{if(t.type==="shared-worker-created"){clearTimeout(r);e(this)}};self.pppPorts[0].postMessage({type:"shared-worker-needed",document:this.document,port2:t.port2},[t.port2])}));case"url":await this.#m();return this}}}}class RemoteTradersFromSharedWorker{runtimes=new Map;async getOrCreateTrader(e){if(e){if(e.runtime==="main-thread"){return null}if(!this.runtimes.has(e._id)){this.runtimes.set(e._id,new RemoteTraderRuntime(e))}return this.runtimes.get(e._id).loadSharedOrRemoteTrader()}}}if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.ppp=new class{traders=new RemoteTradersFromSharedWorker;async getOrCreateTrader(e){return this.traders.getOrCreateTrader(e)}async fetch(e,t={},r=[]){const s=self.globalProxyUrl;if(s){const n=new URL(e);t.headers??={};t.headers["X-Host"]=n.hostname;for(const e of Object.keys(t.headers)){const t=e.toLowerCase();if(t==="x-host"){continue}if(!r.includes(t)){r.push(e)}}t.headers["X-Allowed-Headers"]=r.join(",");n.hostname=new URL(s).hostname;return fetch(n.toString(),t)}else{return fetch(e,t)}}};self.sessionStorage=new class{#O=new Map;getItem(e){return this.#O.get(e)}setItem(e,t){this.#O.set(e,t)}removeItem(e){this.#O.delete(e)}};self.pppSources=new Map;self.pppPortSources=new WeakMap;self.pppPorts=[];self.onconnect=e=>{const t=e.ports[0];self.pppPortSources.set(t,new Set);const multiPurposeEventListener=async({data:e})=>{if(e?.type==="close"){const e=self.pppPorts.indexOf(t);if(e>-1){self.pppPorts.splice(e,1)}t.removeEventListener("message",multiPurposeEventListener);if(self.pppPortSources.has(t)){for(const e of self.pppPortSources.get(t)){for(const t in self.pppTrader.datums){const r=self.pppTrader.datums[t].sources[t];if(r.has(e)){await self.pppTrader.unsubscribeField({source:e,datum:t})}}}self.pppPortSources.delete(t)}}else if(e?.type==="connack"){if(typeof self.pppTrader==="undefined"){self.pppTrader=new self.pppTraderInstance(e.document);self.globalProxyUrl=e.globalProxyUrl;self.rootUrl=e.rootUrl;await __nccwpck_require__(723)(`${self.rootUrl}/lib/debug.js`);self.pppTrader.$$debug??=globalThis.ppp.$debug(e.document._id);self.pppTrader.$$connection??=self.pppTrader.$$debug.extend("connection");if(typeof self.pppTrader.oneTimeInitializationCallback==="function"){await self.pppTrader.oneTimeInitializationCallback()}}t.postMessage({type:"init"})}else if(e?.type==="instruments"){if(typeof self.pppTrader!=="undefined"){await(self.pppTrader.instrumentsArrived?.(e.instruments));t.postMessage({type:"ready"})}}else if(e?.type==="rpc"){try{t.postMessage({type:`rpc-${e.rid}`,response:await self.pppTrader[e.method](...e.args)})}catch(r){t.postMessage({type:`rpc-${e.rid}`,exception:r.serialize?.()??{name:r.name??"RemoteTraderError",args:{details:r.name,message:r.message}}})}}else if(e?.type==="source-changed"){if(!self.pppSources.has(e.sourceID)){self.pppSources.set(e.sourceID,new RemoteSource(e.sourceID,e.canChangeInstrument,e.port2??t));if(!e.port2){self.pppPortSources.get(t).add(self.pppSources.get(e.sourceID))}}const r=self.pppSources.get(e.sourceID);switch(e.reason){case"attribute":r.attributes.set(e.attribute,e.value);break;case"instrument":r.instrument=e.newValue;if(!e.doNotFire){r.bus.emit("instrumentchange",{source:r,oldValue:e.oldValue,newValue:e.newValue})}break}}else if(e?.type==="subscribe-field"){const r=self.pppSources.get(e.sourceID);if(r){try{await self.pppTrader.subscribeField({source:r,field:e.field,datum:e.datum})}catch(r){console.error(r);t.postMessage({type:"subscription-exception",sourceKey:`${e.sourceID}:${e.field}`,exception:r.serialize?.()??{name:r.name??"RemoteTraderError",args:{details:r.name,message:r.message}}})}}}else if(e?.type==="unsubscribe-field"){const t=self.pppSources.get(e.sourceID);if(t){self.pppTrader.unsubscribeField({source:t,field:e.field,datum:e.datum})}}else if(e?.type==="resubscribe"){self.pppTrader.resubscribe(e.onlyForDatums??[])}else if(e?.type==="terminate"){t.removeEventListener("message",multiPurposeEventListener);self.close()}};t.addEventListener("message",multiPurposeEventListener);!self.pppPorts.includes(t)&&self.pppPorts.push(t);t.start();t.postMessage({type:"conn"})}}let P;(function(e){e[e["Disconnected"]=0]="Disconnected";e[e["Connecting"]=1]="Connecting";e[e["Connected"]=2]="Connected"})(P||(P={}));let R;(function(e){e["STK"]="STK";e["OPT"]="OPT";e["FUT"]="FUT";e["IND"]="IND";e["FOP"]="FOP";e["CFD"]="CFD";e["CASH"]="CASH";e["BAG"]="BAG";e["WAR"]="WAR";e["BOND"]="BOND";e["CMDTY"]="CMDTY";e["NEWS"]="NEWS";e["FUND"]="FUND";e["CRYPTO"]="CRYPTO "})(R||(R={}));let S;(function(e){e["BUY"]="BUY";e["SELL"]="SELL"})(S||(S={}));let N;(function(e){e["ApiPending"]="ApiPending";e["ApiCancelled"]="ApiCancelled";e["PreSubmitted"]="PreSubmitted";e["PendingCancel"]="PendingCancel";e["Cancelled"]="Cancelled";e["Submitted"]="Submitted";e["Filled"]="Filled";e["Inactive"]="Inactive";e["PendingSubmit"]="PendingSubmit";e["Unknown"]="Unknown"})(N||(N={}));let y;(function(e){e["None"]="";e["MKT"]="MKT";e["LMT"]="LMT";e["STP"]="STP";e["STP_LMT"]="STP LMT";e["REL"]="REL";e["TRAIL"]="TRAIL";e["BOX_TOP"]="BOX TOP";e["FIX_PEGGED"]="FIX PEGGED";e["LIT"]="LIT";e["LMT_PLUS_MKT"]="LMT + MKT";e["LOC"]="LOC";e["MIT"]="MIT";e["MKT_PRT"]="MKT PRT";e["MOC"]="MOC";e["MTL"]="MTL";e["PASSV_REL"]="PASSV REL";e["PEG_BENCH"]="PEG BENCH";e["PEG_MID"]="PEG MID";e["PEG_MKT"]="PEG MKT";e["PEG_PRIM"]="PEG PRIM";e["PEG_STK"]="PEG STK";e["REL_PLUS_LMT"]="REL + LMT";e["REL_PLUS_MKT"]="REL + MKT";e["SNAP_MID"]="SNAP MID";e["SNAP_MKT"]="SNAP MKT";e["SNAP_PRIM"]="SNAP PRIM";e["STP_PRT"]="STP PRT";e["TRAIL_LIMIT"]="TRAIL LIMIT";e["TRAIL_LIT"]="TRAIL LIT";e["TRAIL_LMT_PLUS_MKT"]="TRAIL LMT + MKT";e["TRAIL_MIT"]="TRAIL MIT";e["TRAIL_REL_PLUS_MKT"]="TRAIL REL + MKT";e["VOL"]="VOL";e["VWAP"]="VWAP";e["QUOTE"]="QUOTE";e["PEG_PRIM_VOL"]="PPV";e["PEG_MID_VOL"]="PDV";e["PEG_MKT_VOL"]="PMV";e["PEG_SRF_VOL"]="PSV"})(y||(y={}));class IbTraderGlobalDatum extends GlobalTraderDatum{async subscribe(e,t,r){await this.trader.establishWebSocketConnection();return super.subscribe(e,t,r)}}class PositionDatum extends IbTraderGlobalDatum{doNotClearValue=true;firstReferenceAdded(e,t,r){if(this.value.size){for(const[s,n]of this.value){if(this.filter(n,e,s,r)){this.trader.assignSourceField(e,t,this[r](n,e,s)??this.emptyValue(r)??"—")}}}}filter(e,t,r,s){if(s!==O.POSITION){if(e.isBalance){return e.position.currency===t.getAttribute("balance")}return e.position.contract.symbol===this.trader.getSymbol(t.instrument)}else{return true}}valueKeyForData(e){if(e.isBalance){return e.position.currency}else{return e.position.contract.conId}}[O.POSITION](e){if(e.isBalance){return{symbol:e.position.currency,lot:1,exchange:c.CUSTOM,isCurrency:true,isBalance:true,size:e.position.size,accountId:this.trader.document.account}}else{const t=this.trader.instruments.get(e.position.contract.symbol);if(t){return{instrument:t,symbol:t.symbol,lot:t.lot,exchange:t.exchange,averagePrice:e.position.avgCost,isCurrency:false,isBalance:false,size:e.position.pos,accountId:e.position.account}}}}[O.POSITION_SIZE](e){if(e.isBalance){return e.position.size}else{return e.position.pos}}[O.POSITION_AVERAGE](e){if(!e.isBalance){return e.position.avgCost}}}class ActiveOrderDatum extends IbTraderGlobalDatum{#f;#p=false;orders=new Map;firstReferenceAdded(){this.orders.clear();clearTimeout(this.#f);this.#p=true;return this.#I()}lastReferenceRemoved(){this.orders.clear();clearTimeout(this.#f);this.#p=false}valueKeyForData(e){return e.orderId}async#I(){if(this.#p){try{const e=await this.trader.getAllOpenOrders();const t=new Set;for(const r of e){if(r.order.orderType!==y.LMT&&r.order.orderType!==y.MKT||r.contract.secType!==R.STK){continue}t.add(`${r.orderId}|${r.order.lmtPrice}|${r.orderStatus.filled}|${r.order.totalQuantity}`);if(!this.orders.has(r.orderId)){this.orders.set(r.orderId,r);this.dataArrived(r)}}for(const[e,r]of this.orders){if(!t.has(`${e}|${r.order.lmtPrice}|${r.orderStatus.filled}|${r.order.totalQuantity}`)){r.orderStatus.status=N.Unknown;this.dataArrived(r);this.orders.delete(e)}}this.#f=setTimeout((()=>{this.#I()}),500)}catch(e){console.error(e);this.#f=setTimeout((()=>{this.#I()}),500)}}}[O.ACTIVE_ORDER](e){const t=this.trader.instruments.get(e.contract.symbol);if(t){return{instrument:t,orderId:e.orderId,symbol:e.contract.symbol,exchange:t.exchange,tif:e.order.tif,destination:e.contract.exchange,orderType:e.order.orderType===y.LMT?"limit":e.order.orderType===y.MKT?"market":"other",side:e.order.action===S.BUY?"buy":"sell",status:this.trader.getOrderStatus(e),placedAt:(new Date).toISOString(),endsAt:null,quantity:e.order.totalQuantity,filled:e.orderStatus.filled,price:e.order.lmtPrice??0}}}}class TimelineDatum extends IbTraderGlobalDatum{#_=[];#f;#p=false;async#h(){if(this.#p){try{const e=new Map;const t=await this.trader.getCommissionReport({acctCode:this.trader.document.account});if(t.ok){for(const r of t.result){e.set(r.execId,r.commission)}}if(!this.#_.length){this.#_=await this.trader.getExecutions();for(const t of this.#_){t.commission=e.get(t.execution.execId)??0;this.dataArrived(t)}}else{const t=await this.trader.getExecutions();const r=[];for(const e of t){if(e?.execution?.execId&&e.execution.execId!==this.#_[0]?.execution?.execId){r.push(e)}else{break}}this.#_.unshift(...r);for(const t of r){t.commission=e.get(t.execution.execId)??0;this.dataArrived(t)}}this.#f=setTimeout((()=>{this.#h()}),500)}catch(e){console.error(e);this.#f=setTimeout((()=>{this.#h()}),500)}}}firstReferenceAdded(){this.#_=[];clearTimeout(this.#f);this.#p=true;return this.#h()}lastReferenceRemoved(){this.#_=[];clearTimeout(this.#f);this.#p=false}valueKeyForData(e){return e.execution.execId}#A(e){const[t,r,s]=e.split(/\s+/).map((e=>e.trim()));const n=t.slice(0,4);const i=t.slice(4,6);const o=t.slice(6,8);const a=new Date;a.setMilliseconds(0);try{const e=(Date.parse(new Intl.DateTimeFormat("en",{dateStyle:"short",timeStyle:"medium",hour12:false,timeZone:s}).format(a))-a.valueOf())/36e5;const t=new Date(`${n}-${i}-${o}T${r}`);t.setHours(t.getHours()-e);return t.toISOString()}catch(e){return`${n}-${i}-${o}T${r}.000Z`}}[O.TIMELINE_ITEM](e){return{instrument:this.trader.instruments.get(e.contract.symbol),operationId:e.execution.execId,accruedInterest:0,commission:e.commission??0,parentId:e.execution.permId,destination:e.execution.exchange,symbol:e.contract.symbol,type:e.execution.side==="BOT"?I.OPERATION_TYPE_BUY:I.OPERATION_TYPE_SELL,exchange:e.execution.exchange,quantity:e.execution.shares,price:e.execution.price,createdAt:this.#A(e.execution.time)}}}class IbTrader extends USTrader{#P;#R;connection;#S=P.Disconnected;constructor(e){super(e,[{type:PositionDatum,datums:[O.POSITION,O.POSITION_SIZE,O.POSITION_AVERAGE]},{type:ActiveOrderDatum,datums:[O.ACTIVE_ORDER]},{type:TimelineDatum,datums:[O.TIMELINE_ITEM]},{type:ConditionalOrderDatum,datums:[O.CONDITIONAL_ORDER]}]);this.#P=`${this.document.broker.twsHost}:${this.document.broker.twsPort}`;this.gatewayUrl=e.broker.ibGatewayUrl;const t=new URL(this.gatewayUrl);t.protocol=t.protocol==="http:"?"ws:":"wss:";this.wsUrl=t.toString()}async establishWebSocketConnection(e){if(this.connection?.readyState===WebSocket.OPEN){return this.connection}else if(this.#R&&!e){return this.#R}else{this.#R=new Promise(((t,r)=>{this.connection=new WebSocket(this.wsUrl);this.connection.onopen=async()=>{if(e){await this.resubscribe()}this.connection.send(this.#P)};this.connection.onclose=async()=>{await later(1e3);t(this.establishWebSocketConnection(true))};this.connection.onerror=()=>this.connection.close();this.connection.onmessage=({data:e})=>{const{message:s,payload:n}=JSON.parse(e);if(s==="subscription"){if(n.subscribed){fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"connect",key:this.#P,body:{host:this.document.broker.twsHost,port:this.document.broker.twsPort}})})}}else if(s==="connection"){if(n.state===P.Disconnected&&this.#S===P.Connecting){r(new ConnectionError({details:n}))}else if(n.state===P.Connected){this.#S=n.state;t(this.connection)}else if(n.state===P.Disconnected&&this.#S===P.Connected){if(this.connection.readyState===WebSocket.OPEN){this.connection.close()}}this.#S=n.state}else if(s==="summary"){const e=n[this.document.account]??{};if(e.AvailableFunds){for(const t in e.AvailableFunds){this.datums[O.POSITION].dataArrived({isBalance:true,position:{currency:t,size:parseFloat(e.AvailableFunds[t].value)}})}}}else if(s==="positions"){const e=n[this.document.account]??[];for(const t of e){this.datums[O.POSITION].dataArrived({isBalance:false,position:t})}}}}));return this.#R}}async ensureTwsIsConnected(){await this.establishWebSocketConnection()}getOrderStatus(e={}){switch(e.orderStatus.status){case N.ApiCancelled:case N.Cancelled:return"canceled";case N.ApiPending:case N.PendingCancel:case N.PendingSubmit:case N.PreSubmitted:case N.Submitted:return"working";case N.Filled:return"filled";case N.Inactive:return"inactive";case N.Unknown:return"unspecified"}}getBroker(){return l.IB}getDictionary(){return T.IB}getExchange(){return c.CUSTOM}getObservedAttributes(){return["balance"]}getDestinationList(){return[{label:"SMART",value:"SMART"},{label:"AMEX",value:"AMEX"},{label:"ARCA",value:"ARCA"},{label:"BATS",value:"BATS"},{label:"BEX",value:"BEX"},{label:"BYX",value:"BYX"},{label:"CBOE",value:"CBOE"},{label:"CHX",value:"CHX"},{label:"DRCTEDGE",value:"DRCTEDGE"},{label:"EDGEA",value:"EDGEA"},{label:"EDGX",value:"EDGX"},{label:"IBKRATS",value:"IBKRATS"},{label:"IEX",value:"IEX"},{label:"ISE",value:"ISE"},{label:"NASDAQ",value:"NASDAQ"},{label:"LTSE",value:"LTSE"},{label:"MEMX",value:"MEMX"},{label:"NYSE",value:"NYSE"},{label:"NYSENAT",value:"NYSENAT"},{label:"OVERNIGHT",value:"OVERNIGHT"},{label:"PEARL",value:"PEARL"},{label:"PHLX",value:"PHLX"},{label:"PSX",value:"PSX"},{label:"TPLUS1",value:"TPLUS1"}]}getTIFList(){return[{label:"DAY",value:"DAY"},{label:"GTC",value:"GTC"},{label:"IOC",value:"IOC"},{label:"OPG",value:"OPG"},{label:"FOK",value:"FOK"}]}async getAllOpenOrders(){const e=await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"getAllOpenOrders",key:this.#P})});const t=await e.json();return t.result??[]}async getCommissionReport(){const e=await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"getCommissionReport",key:this.#P})});return e.json()}async getExecutions(){const e=await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"getExecutionDetails",key:this.#P})});const t=await e.json();return t.result?.reverse()??[]}async modifyRealOrders({instrument:e,side:t,value:r}){await this.ensureTwsIsConnected();const s=this.datums[O.ACTIVE_ORDER].orders;for(const[,n]of s){const s=this.getOrderStatus(n);const i=this.instruments.get(n.contract.symbol);if(s==="working"&&(n.order.action.toLowerCase()===t||t==="all")){if(e&&!this.instrumentsAreEqual(e,i))continue;if(i?.minPriceIncrement>=0){const e=+n.order.lmtPrice<1?1e-4:.01;const t=this.fixPrice(i,+n.order.lmtPrice+e*r);await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"modifyOrder",key:this.#P,body:{id:n.orderId,contract:{symbol:n.contract.symbol,exchange:n.contract.exchange,currency:n.contract.currency,secType:n.contract.secType},order:{orderType:n.order.orderType,action:n.order.action,lmtPrice:t,totalQuantity:(+n.order.totalQuantity-+n.orderStatus.filled)/i.lot,account:n.order.account,tif:n.order.tif,outsideRth:n.order.outsideRth,transmit:true}}})})}}}}async cancelAllRealOrders({instrument:e,filter:t}={}){await this.ensureTwsIsConnected();const r=this.datums[O.ACTIVE_ORDER].orders;for(const[,s]of r){const r=this.getOrderStatus(s);const n=this.instruments.get(s.contract.symbol);if(n&&r==="working"){if(e&&!this.instrumentsAreEqual(e,n))continue;if(t==="buy"&&s.order.action!==S.BUY){continue}if(t==="sell"&&s.order.action!==S.SELL){continue}await this.cancelRealOrder(s)}}}async cancelRealOrder(e){await this.ensureTwsIsConnected();const t=await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"cancelOrder",key:this.#P,body:{id:e.orderId}})});const r=await t.json();if(t.ok){return{orderId:r.result}}else{throw new TradingError({message:r.result})}}async placeLimitOrder({instrument:e,price:t,quantity:r,direction:s,destination:n="SMART",tif:i="GTC",displaySize:o}){await this.ensureTwsIsConnected();if(this.connection.readyState===WebSocket.OPEN){if(typeof o!=="number"||o>r||o%100!==0){o=void 0}return new Promise((async(a,c)=>{try{const u=await fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"getNextValidOrderId",key:this.#P})});const{result:l}=await u.json();const temporaryListener=({data:e})=>{const t=JSON.parse(e);if(t.message==="orderStatus"){if(t.reqId===l&&(t.status===N.Submitted||t.status===N.PreSubmitted||t.status===N.Filled)){this.connection.removeEventListener("message",temporaryListener);a({orderId:t.reqId})}}else if(t.message==="error"){c(new TradingError({message:t.payload.message,details:{code:t.payload.code,reqId:t.payload.reqId}}));this.connection.removeEventListener("message",temporaryListener)}};this.connection.addEventListener("message",temporaryListener);const d={orderType:t?y.LMT:y.MKT,action:s==="buy"?S.BUY:S.SELL,totalQuantity:r,account:this.document.account,tif:i,displaySize:o,outsideRth:true,transmit:true};if(t){d.lmtPrice=this.fixPrice(e,t)}return fetch(`${this.gatewayUrl}call`,{method:"POST",body:JSON.stringify({method:"placeOrder",key:this.#P,body:{id:l,contract:{symbol:this.getSymbol(e),exchange:n,currency:e.currency,secType:R.STK},order:d}})})}catch(e){c(e)}}))}else{throw new TradingError({message:"Нет соединения с шлюзом TWS."})}}async placeMarketOrder({instrument:e,quantity:t,direction:r,destination:s,tif:n,displaySize:i}){return this.placeLimitOrder({instrument:e,quantity:t,direction:r,destination:s,tif:n,displaySize:i})}getErrorI18nKey({error:e}){const t=e.message;if(/is not available for short sale/i.test(t))return"E_NOT_AVAILABLE_FOR_SHORT";if(/The size value cannot be zero/i.test(t))return"E_SIZE_CANT_BE_ZERO"}}pppTraderInstanceForWorkerIs(IbTrader);const g=IbTrader})();module.exports=r})();