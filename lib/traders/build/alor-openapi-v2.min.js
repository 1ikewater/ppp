(()=>{var e={723:e=>{function webpackEmptyAsyncContext(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}))}webpackEmptyAsyncContext.keys=()=>[];webpackEmptyAsyncContext.resolve=webpackEmptyAsyncContext;webpackEmptyAsyncContext.id=723;e.exports=webpackEmptyAsyncContext},930:e=>{function webpackEmptyAsyncContext(e){return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}))}webpackEmptyAsyncContext.keys=()=>[];webpackEmptyAsyncContext.resolve=webpackEmptyAsyncContext;webpackEmptyAsyncContext.id=930;e.exports=webpackEmptyAsyncContext}};var t={};function __nccwpck_require__(r){var s=t[r];if(s!==undefined){return s.exports}var n=t[r]={exports:{}};var i=true;try{e[r](n,n.exports,__nccwpck_require__);i=false}finally{if(i)delete t[r]}return n.exports}(()=>{__nccwpck_require__.d=(e,t)=>{for(var r in t){if(__nccwpck_require__.o(t,r)&&!__nccwpck_require__.o(e,r)){Object.defineProperty(e,r,{enumerable:true,get:t[r]})}}}})();(()=>{__nccwpck_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();(()=>{__nccwpck_require__.r=e=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})}})();if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r={};(()=>{"use strict";__nccwpck_require__.r(r);__nccwpck_require__.d(r,{default:()=>R});const e={NOT_READY:"not-ready",READY:"ready",OPERATION_STARTED:"operation-started",OPERATION_ENDED:"operation-ended",OPERATION_FAILED:"operation-failed"};const t={OK:"ok",OLD:"old",OFF:"off"};const s={PASSWORD:"password",KEY:"key"};const n={OK:"ok",FAILED:"failed"};const i={SUPABASE:"supabase",PUSHER:"pusher",ASTRADB:"astradb",SEATABLE:"seatable",NORTHFLANK:"northflank",RENDER:"render",REDIS:"redis",CLOUDFLARE:"cloudflare",POSTGRESQL:"postgresql",BITIO:"bitio",YC:"yc"};const o={PPP_ASPIRANT_WORKER:"ppp-aspirant-worker",CLOUDFLARE_WORKER:"cloudflare-worker",CLOUD_PPP_ASPIRANT:"cloud-ppp-aspirant",DEPLOYED_PPP_ASPIRANT:"deployed-ppp-aspirant",SYSTEMD_PPP_ASPIRANT:"systemd-ppp-aspirant",SUPABASE_PARSER:"supabase-parser",NYSE_NSDQ_HALTS:"nyse-nsdq-halts"};const a={ACTIVE:"active",STOPPED:"stopped",FAILED:"failed"};const c={BINANCE:"BINANCE",BYBIT_LINEAR:"BYBIT_LINEAR",BYBIT_SPOT:"BYBIT_SPOT",MOEX:"MOEX",SPBX:"SPBX",US:"US",UTEX_MARGIN_STOCKS:"UTEX_MARGIN_STOCKS",RUS:"RUS",CUSTOM:"CUSTOM",MOEX_SECURITIES:"MOEX_SECURITIES",MOEX_FX_METALS:"MOEX_FX_METALS",MOEX_FORTS:"MOEX_FORTS",CAPITALCOM:"CAPITALCOM"};const u=[c.BINANCE,c.BYBIT_SPOT,c.BYBIT_LINEAR];const d={ALPACA:"alpaca",ALOR:"alor",TINKOFF:"tinkoff",UTEX:"utex",PSINA:"psina",BINANCE:"binance",HUOBI:"huobi",BYBIT:"bybit",MEXC:"mexc",FINAM:"finam",IB:"ib",CAPITALCOM:"capitalcom",UNKNOWN:"unknown"};const l={MARKET_DATA_RECORDER:"market-data-recorder",STOP_LOSS_TAKE_PROFIT:"stop-loss-take-profit",CUSTOM:"custom"};const m={BINANCE:"BINANCE",BYBIT_LINEAR:"BYBIT_LINEAR",BYBIT_SPOT:"BYBIT_SPOT",UTEX_MARGIN_STOCKS:"UTEX_MARGIN_STOCKS",PSINA_US_STOCKS:"PSINA_US_STOCKS",ALOR_SPBX:"ALOR_SPBX",ALOR_MOEX_SECURITIES:"ALOR_MOEX_SECURITIES",ALOR_MOEX_FX_METALS:"ALOR_MOEX_FX_METALS",ALOR_FORTS:"ALOR_FORTS",TINKOFF:"TINKOFF",FINAM:"FINAM",ALPACA:"ALPACA",IB:"IB",CAPITALCOM:"CAPITALCOM"};const E={ALOR_OPENAPI_V2:"alor-openapi-v2",ALPACA_V2_PLUS:"alpaca-v2-plus",TINKOFF_GRPC_WEB:"tinkoff-grpc-web",IB:"ib",CAPITALCOM:"capitalcom",UTEX_MARGIN_STOCKS:"utex-margin-stocks",BINANCE_V3:"binance-v3",MEXC_V3:"mexc-v3",BYBIT_V5:"bybit-v5",FINAM_TRADE_API:"finam-trade-api",PAPER_TRADE:"paper-trade",COMBINED_L1:"combined-l1",COMBINED_ORDERBOOK:"combined-orderbook",CUSTOM:"custom"};const T={CAPS_LIMIT_ORDERS:"caps-limit-orders",CAPS_MARKET_ORDERS:"caps-marker-orders",CAPS_ACTIVE_ORDERS:"caps-active-orders",CAPS_CONDITIONAL_ORDERS:"caps-conditional-orders",CAPS_ORDERBOOK:"caps-orderbook",CAPS_CANDLES:"caps-candles",CAPS_TIME_AND_SALES:"caps-time-and-sales",CAPS_POSITIONS:"caps-positions",CAPS_TIMELINE:"caps-timeline",CAPS_LEVEL1:"caps-level1",CAPS_EXTENDED_LEVEL1:"caps-extended-level1",CAPS_CHARTS:"caps-charts",CAPS_MIC:"caps-mic",CAPS_ORDER_DESTINATION:"caps-order-destination",CAPS_ORDER_TIF:"caps-order-tif",CAPS_ORDER_DISPLAY_SIZE:"caps-order-display-size",CAPS_US_NBBO:"caps-us-nbbo",CAPS_NSDQ_TOTALVIEW:"caps-nsdq-totalview",CAPS_ARCABOOK:"caps-arcabook",CAPS_BLUEATS:"caps-blueats",CAPS_NYSE_OPENBOOK:"caps-nyse-openbook",CAPS_DIRECTEDGE_BOOK:"caps-directedge-book",CAPS_BZX_BOOK:"caps-bzx-book",CAPS_NOII:"caps-noii",CAPS_PAPER:"caps-paper"};const f={TRADER:"trader",DAY_VOLUME:"day-volume",STATUS:"status",TRADING_STATUS:"trading-status",LAST_PRICE:"last-price",LAST_PRICE_ABSOLUTE_CHANGE:"last-price-absolute-change",LAST_PRICE_RELATIVE_CHANGE:"last-price-relative-change",EXTENDED_LAST_PRICE:"extended-last-price",EXTENDED_LAST_PRICE_ABSOLUTE_CHANGE:"extended-last-price-absolute-change",EXTENDED_LAST_PRICE_RELATIVE_CHANGE:"extended-last-price-relative-change",BEST_BID:"best-bid",BEST_ASK:"best-ask",MIDPOINT:"midpoint",ORDERBOOK:"orderbook",MARKET_PRINT:"market-print",POSITION:"position",POSITION_SIZE:"position-size",POSITION_AVERAGE:"position-average",REAL_ORDER:"real-order",CONDITIONAL_ORDER:"conditional-order",TIMELINE_ITEM:"timeline-item",CANDLE:"candle",NOII:"noii",SPRINT:"sprint",LOCATE:"locate"};const p={INSTRUMENT:"instrument",SYMBOL:"symbol",INSTRUMENT_TYPE:"instrument-type",POSITION_AVAILABLE:"position-available",POSITION_AVERAGE:"position-average",TOTAL_AMOUNT:"total-amount",EXTENDED_TOTAL_AMOUNT:"extended-total-amount",BEST_BID:"best-bid",BEST_ASK:"best-ask",LAST_PRICE:"last-price",LAST_PRICE_ABSOLUTE_CHANGE:"last-price-absolute-change",LAST_PRICE_RELATIVE_CHANGE:"last-price-relative-change",EXTENDED_LAST_PRICE:"extended-last-price",EXTENDED_LAST_PRICE_ABSOLUTE_CHANGE:"extended-last-price-absolute-change",EXTENDED_LAST_PRICE_RELATIVE_CHANGE:"extended-last-price-relative-change",PL_ABSOLUTE:"pl-absolute",PL_RELATIVE:"pl-relative",EXTENDED_PL_ABSOLUTE:"extended-pl-absolute",EXTENDED_PL_RELATIVE:"extended-pl-relative",DAY_VOLUME:"day-volume",TRADING_STATUS:"trading-status",FORMATTED_VALUE:"formatted-value"};const h={ORDER:"order",SCALPING_BUTTONS:"scalping-buttons",ACTIVE_ORDERS:"active-orders",LIGHT_CHART:"light-chart",ORDERBOOK:"orderbook",TIME_AND_SALES:"time-and-sales",PORTFOLIO:"portfolio",BALANCES:"balances",LIST:"list",TIMELINE:"timeline",CLOCK:"clock",MARQUEE:"marquee",TCC:"tcc",FRAME:"frame",NOII:"noii",MIGRATION:"migration",OTHER:"other"};let _;(function(e){e[e["OPERATION_TYPE_UNSPECIFIED"]=0]="OPERATION_TYPE_UNSPECIFIED";e[e["OPERATION_TYPE_INPUT"]=1]="OPERATION_TYPE_INPUT";e[e["OPERATION_TYPE_BOND_TAX"]=2]="OPERATION_TYPE_BOND_TAX";e[e["OPERATION_TYPE_OUTPUT_SECURITIES"]=3]="OPERATION_TYPE_OUTPUT_SECURITIES";e[e["OPERATION_TYPE_OVERNIGHT"]=4]="OPERATION_TYPE_OVERNIGHT";e[e["OPERATION_TYPE_TAX"]=5]="OPERATION_TYPE_TAX";e[e["OPERATION_TYPE_BOND_REPAYMENT_FULL"]=6]="OPERATION_TYPE_BOND_REPAYMENT_FULL";e[e["OPERATION_TYPE_SELL_CARD"]=7]="OPERATION_TYPE_SELL_CARD";e[e["OPERATION_TYPE_DIVIDEND_TAX"]=8]="OPERATION_TYPE_DIVIDEND_TAX";e[e["OPERATION_TYPE_OUTPUT"]=9]="OPERATION_TYPE_OUTPUT";e[e["OPERATION_TYPE_BOND_REPAYMENT"]=10]="OPERATION_TYPE_BOND_REPAYMENT";e[e["OPERATION_TYPE_TAX_CORRECTION"]=11]="OPERATION_TYPE_TAX_CORRECTION";e[e["OPERATION_TYPE_SERVICE_FEE"]=12]="OPERATION_TYPE_SERVICE_FEE";e[e["OPERATION_TYPE_BENEFIT_TAX"]=13]="OPERATION_TYPE_BENEFIT_TAX";e[e["OPERATION_TYPE_MARGIN_FEE"]=14]="OPERATION_TYPE_MARGIN_FEE";e[e["OPERATION_TYPE_BUY"]=15]="OPERATION_TYPE_BUY";e[e["OPERATION_TYPE_BUY_CARD"]=16]="OPERATION_TYPE_BUY_CARD";e[e["OPERATION_TYPE_INPUT_SECURITIES"]=17]="OPERATION_TYPE_INPUT_SECURITIES";e[e["OPERATION_TYPE_SELL_MARGIN"]=18]="OPERATION_TYPE_SELL_MARGIN";e[e["OPERATION_TYPE_BROKER_FEE"]=19]="OPERATION_TYPE_BROKER_FEE";e[e["OPERATION_TYPE_BUY_MARGIN"]=20]="OPERATION_TYPE_BUY_MARGIN";e[e["OPERATION_TYPE_DIVIDEND"]=21]="OPERATION_TYPE_DIVIDEND";e[e["OPERATION_TYPE_SELL"]=22]="OPERATION_TYPE_SELL";e[e["OPERATION_TYPE_COUPON"]=23]="OPERATION_TYPE_COUPON";e[e["OPERATION_TYPE_SUCCESS_FEE"]=24]="OPERATION_TYPE_SUCCESS_FEE";e[e["OPERATION_TYPE_DIVIDEND_TRANSFER"]=25]="OPERATION_TYPE_DIVIDEND_TRANSFER";e[e["OPERATION_TYPE_ACCRUING_VARMARGIN"]=26]="OPERATION_TYPE_ACCRUING_VARMARGIN";e[e["OPERATION_TYPE_WRITING_OFF_VARMARGIN"]=27]="OPERATION_TYPE_WRITING_OFF_VARMARGIN";e[e["OPERATION_TYPE_DELIVERY_BUY"]=28]="OPERATION_TYPE_DELIVERY_BUY";e[e["OPERATION_TYPE_DELIVERY_SELL"]=29]="OPERATION_TYPE_DELIVERY_SELL";e[e["OPERATION_TYPE_TRACK_MFEE"]=30]="OPERATION_TYPE_TRACK_MFEE";e[e["OPERATION_TYPE_TRACK_PFEE"]=31]="OPERATION_TYPE_TRACK_PFEE";e[e["OPERATION_TYPE_TAX_PROGRESSIVE"]=32]="OPERATION_TYPE_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_BOND_TAX_PROGRESSIVE"]=33]="OPERATION_TYPE_BOND_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_DIVIDEND_TAX_PROGRESSIVE"]=34]="OPERATION_TYPE_DIVIDEND_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_BENEFIT_TAX_PROGRESSIVE"]=35]="OPERATION_TYPE_BENEFIT_TAX_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_CORRECTION_PROGRESSIVE"]=36]="OPERATION_TYPE_TAX_CORRECTION_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO_PROGRESSIVE"]=37]="OPERATION_TYPE_TAX_REPO_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO"]=38]="OPERATION_TYPE_TAX_REPO";e[e["OPERATION_TYPE_TAX_REPO_HOLD"]=39]="OPERATION_TYPE_TAX_REPO_HOLD";e[e["OPERATION_TYPE_TAX_REPO_REFUND"]=40]="OPERATION_TYPE_TAX_REPO_REFUND";e[e["OPERATION_TYPE_TAX_REPO_HOLD_PROGRESSIVE"]=41]="OPERATION_TYPE_TAX_REPO_HOLD_PROGRESSIVE";e[e["OPERATION_TYPE_TAX_REPO_REFUND_PROGRESSIVE"]=42]="OPERATION_TYPE_TAX_REPO_REFUND_PROGRESSIVE";e[e["OPERATION_TYPE_DIV_EXT"]=43]="OPERATION_TYPE_DIV_EXT";e[e["OPERATION_TYPE_TAX_CORRECTION_COUPON"]=44]="OPERATION_TYPE_TAX_CORRECTION_COUPON";e[e["OPERATION_TYPE_CASH_FEE"]=45]="OPERATION_TYPE_CASH_FEE";e[e["OPERATION_TYPE_OUT_FEE"]=46]="OPERATION_TYPE_OUT_FEE";e[e["OPERATION_TYPE_OUT_STAMP_DUTY"]=47]="OPERATION_TYPE_OUT_STAMP_DUTY";e[e["OPERATION_TYPE_OUTPUT_SWIFT"]=50]="OPERATION_TYPE_OUTPUT_SWIFT";e[e["OPERATION_TYPE_INPUT_SWIFT"]=51]="OPERATION_TYPE_INPUT_SWIFT";e[e["OPERATION_TYPE_OUTPUT_ACQUIRING"]=53]="OPERATION_TYPE_OUTPUT_ACQUIRING";e[e["OPERATION_TYPE_INPUT_ACQUIRING"]=54]="OPERATION_TYPE_INPUT_ACQUIRING";e[e["OPERATION_TYPE_OUTPUT_PENALTY"]=55]="OPERATION_TYPE_OUTPUT_PENALTY";e[e["OPERATION_TYPE_ADVICE_FEE"]=56]="OPERATION_TYPE_ADVICE_FEE";e[e["OPERATION_TYPE_TRANS_IIS_BS"]=57]="OPERATION_TYPE_TRANS_IIS_BS";e[e["OPERATION_TYPE_TRANS_BS_BS"]=58]="OPERATION_TYPE_TRANS_BS_BS";e[e["OPERATION_TYPE_OUT_MULTI"]=59]="OPERATION_TYPE_OUT_MULTI";e[e["OPERATION_TYPE_INP_MULTI"]=60]="OPERATION_TYPE_INP_MULTI";e[e["OPERATION_TYPE_OVER_PLACEMENT"]=61]="OPERATION_TYPE_OVER_PLACEMENT";e[e["OPERATION_TYPE_OVER_COM"]=62]="OPERATION_TYPE_OVER_COM";e[e["OPERATION_TYPE_OVER_INCOME"]=63]="OPERATION_TYPE_OVER_INCOME";e[e["OPERATION_TYPE_OPTION_EXPIRATION"]=64]="OPERATION_TYPE_OPTION_EXPIRATION";e[e["OPERATION_TYPE_LOCATE_FEE"]=800]="OPERATION_TYPE_LOCATE_FEE";e[e["UNRECOGNIZED"]=-1]="UNRECOGNIZED"})(_||(_={}));const O={UNSPECIFIED:"UNSPECIFIED",NOT_AVAILABLE_FOR_TRADING:"NOT_AVAILABLE_FOR_TRADING",OPENING_PERIOD:"OPENING_PERIOD",CLOSING_PERIOD:"CLOSING_PERIOD",BREAK_IN_TRADING:"BREAK_IN_TRADING",NORMAL_TRADING:"NORMAL_TRADING",CLOSING_AUCTION:"CLOSING_AUCTION",DARK_POOL_AUCTION:"DARK_POOL_AUCTION",DISCRETE_AUCTION:"DISCRETE_AUCTION",OPENING_AUCTION_PERIOD:"OPENING_AUCTION_PERIOD",TRADING_AT_CLOSING_AUCTION_PRICE:"TRADING_AT_CLOSING_AUCTION_PRICE",SESSION_ASSIGNED:"SESSION_ASSIGNED",SESSION_CLOSE:"SESSION_CLOSE",SESSION_OPEN:"SESSION_OPEN",DEALER_NORMAL_TRADING:"DEALER_NORMAL_TRADING",DEALER_BREAK_IN_TRADING:"DEALER_BREAK_IN_TRADING",DEALER_NOT_AVAILABLE_FOR_TRADING:"DEALER_NOT_AVAILABLE_FOR_TRADING",PREMARKET:"PREMARKET",AFTER_HOURS:"AFTER_HOURS",TRADING_SUSPENDED:"TRADING_SUSPENDED",DELISTED:"DELISTED",IPO_TODAY:"IPO_TODAY",QUOTATION_RESUMPTION:"QUOTATION_RESUMPTION",SHORT_SALE_RESTRICTION:"SHORT_SALE_RESTRICTION",MARKET_IMBALANCE:"MARKET_IMBALANCE",MARKET_CLOSE_IMBALANCE:"MARKET_CLOSE_IMBALANCE",PRICE_INDICATION:"PRICE_INDICATION",TRADING_RANGE_INDICATION:"TRADING_RANGE_INDICATION"};function isPredefinedWidgetType(e){return[h.ORDER,h.SCALPING_BUTTONS,h.ACTIVE_ORDERS,h.LIGHT_CHART,h.ORDERBOOK,h.TIME_AND_SALES,h.PORTFOLIO,h.BALANCES,h.LIST,h.TIMELINE,h.CLOCK,h.MARQUEE,h.TCC].includes(e)}function getInstrumentDictionaryMeta(e){let t;let r;let s;switch(e){case m.BYBIT_LINEAR:t=c.BYBIT_LINEAR;r=d.BYBIT;s=[c.BYBIT_LINEAR];break;case m.BYBIT_SPOT:t=c.BYBIT_SPOT;r=d.BYBIT;s=[c.BYBIT_SPOT];break;case m.BINANCE:t=c.BINANCE;r=d.BINANCE;s=[c.BINANCE];break;case m.UTEX_MARGIN_STOCKS:t=c.UTEX_MARGIN_STOCKS;r=d.UTEX;s=[c.UTEX_MARGIN_STOCKS];break;case m.ALPACA:t=c.US;r=d.ALPACA;s=[c.ALPACA];break;case m.IB:t=c.CUSTOM;r=d.IB;s=[c.US];break;case m.PSINA_US_STOCKS:t=c.US;r=d.PSINA;s=[c.US];break;case m.ALOR_SPBX:t=c.SPBX;r=d.ALOR;s=[c.SPBX];break;case m.ALOR_MOEX_SECURITIES:t=c.MOEX_SECURITIES;r=d.ALOR;s=[c.MOEX];break;case m.ALOR_MOEX_FX_METALS:t=c.MOEX_FX_METALS;r=d.ALOR;s=[c.MOEX];break;case m.ALOR_FORTS:t=c.MOEX_FORTS;r=d.ALOR;s=[c.MOEX];break;case m.TINKOFF:t=c.RUS;r=d.TINKOFF;s=[c.MOEX,c.SPBX];break;case m.FINAM:t=c.CUSTOM;r=d.FINAM;s=[c.MOEX,c.US,c.SPBX];break;case m.CAPITALCOM:t=c.CAPITALCOM;r=d.CAPITALCOM;s=[c.CAPITALCOM];break}return{exchange:t,broker:r,exchangeList:s}}if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.ppp??={i18nLocale:"en-US"}}const I=["EUR","AMD","KZT","KGS","UZS","USD","CNY","TJS","BYN","HKD","XAU","TRY","XAG","RUB"];function stringToFloat(e){if(typeof e==="number"){return e}if(!e){return 0}if(e.includes(",")&&e.includes(".")){e=e.replaceAll(/,/gi,"")}return parseFloat(e.replace(",",".").replace(/\s/g,"").replace(/[^\x20-\x7E]/g,""))}function decimalSeparator(){const e=1.1;return Intl.NumberFormat(ppp.i18nLocale).formatToParts(e).find((e=>e.type==="decimal")).value}const A=decimalSeparator();function getInstrumentMinPriceIncrement(e,t,r){if(!e)return 0;if(typeof t!=="number"||isNaN(t))return e.minPriceIncrement||.01;t=stringToFloat(t);let s=e.minPriceIncrement;if(!s||r){s=t<1?1e-4:.01}return s}function getInstrumentPrecision(e,t,r){if(!e)return 0;if(e.type==="currency"){return 4}if(t===0||t==="0"){return 2}const s=getInstrumentMinPriceIncrement(e,t,r);const[n,i]=s.toString().split(".");return i?i.length:0}function getInstrumentQuantityPrecision(e){if(!e)return 0;const[t,r]=(e.minQuantityIncrement??1).toString().split(".");return r?r.length:0}function formatDateWithOptions(e,t={}){if(!e)return"—";return new Intl.DateTimeFormat(ppp.i18nLocale,Object.assign({hour12:false},t)).format(new Date(e))}function formatDate(e){if(!e)return"—";return new Intl.DateTimeFormat(ppp.i18nLocale,{month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:false}).format(new Date(e))}function formatDuration(e=0,t={}){if(typeof e!=="number")return"—";return new Date(e*1e3).toLocaleTimeString(ppp.i18nLocale,Object.assign({timeZone:"Etc/UTC",hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"},t))}function formatPrice(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";if(!t.currency)return"—";const s=getInstrumentPrecision(t,e);if(t.type==="future"||t.type==="index"){return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s}).format(e)+" pt."}if(!I.includes(t?.currency)){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s},r)).format(e)+(t.currency==="N/A"?"":` ${t.currency}`)}return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",currency:t.currency,minimumFractionDigits:s,maximumFractionDigits:s},r)).format(e)+` ${priceCurrencySymbol(t)}`}function formatPriceWithoutCurrency(e,t,r){if(typeof t==="undefined"){return(e||"").toString().replace(".",A)}if(typeof e!=="number"||isNaN(e))return"—";const s=getInstrumentPrecision(t,e,r);return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:s,maximumFractionDigits:s}).format(e)}function formatCommission(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";if(!t.currency)return"—";if(I.indexOf(t?.currency)===-1){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:2,maximumFractionDigits:3},r)).format(e)+` ${t.currency}`}return new Intl.NumberFormat(ppp.i18nLocale,{style:"currency",currency:t.currency,minimumFractionDigits:2,maximumFractionDigits:3}).format(e)}function formatAmount(e,t={},r={}){const s=t.currency??t.quoteCryptoAsset;if(!s||typeof e!=="number"||isNaN(e))return"—";if(t.type==="future"){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal"},r)).format(e)+" пт."}if(!I.includes(s)){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:0},r)).format(e)+` ${s}`}return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"currency",minimumFractionDigits:0,currency:s},r)).format(e)}function formatAbsoluteChange(e,t,r={}){if(!t||typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",minimumFractionDigits:2,maximumFractionDigits:Math.max(2,getInstrumentPrecision(t,e)),signDisplay:"always"},r)).format(e)}function formatRelativeChange(e,t={}){if(typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"percent",minimumFractionDigits:2,maximumFractionDigits:2,signDisplay:"always"},t)).format(e)}function formatPercentage(e){if(typeof e!=="number"||isNaN(e))return"—";return new Intl.NumberFormat(ppp.i18nLocale,{style:"percent",maximumFractionDigits:3}).format(e)}function formatQuantity(e,t){if(typeof e!=="number"||isNaN(e))return"—";let r=0;if(typeof t?.minQuantityIncrement==="number"){const[e,s]=t.minQuantityIncrement.toString().split(".");r=s?.length??0}return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal",minimumFractionDigits:r,maximumFractionDigits:r}).format(e)}function cyrillicToLatin(e){if(/^\p{Script=Cyrillic}+$/u.test(e)){const t='QWERTYUIOP{}ASDFGHJKL:"ZXCVBNM<>~';const r="ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁ";const s={};for(let e=0;e<r.length;e++){s[r[e]]=t[e]}return e.split("").map((e=>s[e.toUpperCase()])).join("")}else{return e}}function latinToCyrillic(e){if(/[a-z]+/i.test(e)){const t="QWERTYUIOP{}ASDFGHJKL:\"ZXCVBNM<>~,.`'[];";const r="ЙЦУКЕНГШЩЗХЪФЫВАПРОЛДЖЭЯЧСМИТЬБЮЁБЮЁЭХЪЖ";const s={};for(let e=0;e<r.length;e++){s[t[e]]=r[e]}return e.split("").map((e=>s[e.toUpperCase()])).join("")}else{return e}}function priceCurrencySymbol(e){if(e?.type==="future"||e?.type==="index")return"pt.";if(e?.type==="cryptocurrency")return e.quoteCryptoAsset;if(e?.currency==="USDT")return"USDT";if(e?.currency&&e.currency!=="N/A"){return(0).toLocaleString(ppp.i18nLocale,{style:"currency",currency:e.currency,minimumFractionDigits:0,maximumFractionDigits:0}).replace(/\d/g,"").trim()}else return""}function currencyName(e){if(I.indexOf(e)===-1){return e}if(!e)return"—";const t=new Intl.DisplayNames([ppp.i18nLocale],{type:"currency"});return t.of(e)}function isDST(e=new Date){const t=e.getFullYear();const r=new Date(t,2,1);const s=(7-r.getDay())%7;const n=r.getDate()+s+7;const i=new Date(t,2,n);const o=new Date(t,10,1);const a=(7-o.getDay())%7;const c=o.getDate()+a;const u=new Date(t,10,c);return e.getTime()<=u.getTime()&&e.getTime()>=i.getTime()}function formatFileSize(e,{si:t=true,dp:r=1,useIntl:s=false}={}){if(s){return new Intl.NumberFormat(ppp.i18nLocale,{style:"unit",unit:"byte",notation:"compact",unitDisplay:"narrow"}).format(e)}const n=t?1e3:1024;if(Math.abs(e)<n){return e+" B"}const i=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];let o=-1;const a=10**r;do{e/=n;++o}while(Math.round(Math.abs(e)*a)/a>=n&&o<i.length-1);return e.toFixed(r)+" "+i[o]}function formatNumber(e,t={}){return new Intl.NumberFormat(ppp.i18nLocale,t).format(e)}function formatVolume(e,t={}){return new Intl.NumberFormat(ppp.i18nLocale,Object.assign({style:"decimal",notation:"compact",minimumFractionDigits:1,maximumFractionDigits:2},t)).format(e)}function parseDistance(e=""){let t="";e=e.trim();if(e.endsWith("%")){t="%"}else if(e.endsWith("+")){t="+"}e=e.replace(",",".").replace(/\s/g,"").replace(/[^\x20-\x7E]/g,"");let r=parseFloat(e);if(t==="+"){r=Math.trunc(r)}if(isNaN(r)){return{}}return{value:r,unit:t}}function distanceToString({value:e,unit:t}={}){if(typeof e==="undefined"){return""}if(t==="%"){return new Intl.NumberFormat(ppp.i18nLocale,{style:"percent",maximumFractionDigits:2}).format(e/100)}else if(t==="+"){return`${Math.trunc(e)} +`}else{return new Intl.NumberFormat(ppp.i18nLocale,{style:"decimal"}).format(e)}}class ConflictError extends Error{constructor({message:e="Conflict.",href:t,status:r=409,pppMessage:s}={}){super(e);this.name=this.constructor.name;this.status=r;this.href=t;this.pppMessage=s}}class AllocationNotFoundError extends Error{constructor({message:e}={}){super(e);this.name=this.constructor.name}}class DocumentNotFoundError extends Error{constructor({message:e,documentId:t}={}){super(e);this.name=this.constructor.name;this.documentId=t}}class ValidationError extends Error{constructor({message:e,status:t=422,element:r}={}){super(e);this.name="ValidationError";this.element=r;this.status=t}}class FetchError extends Error{constructor({message:e="Fetch failed.",status:t=400,pppMessage:r}={}){super(e);this.name=this.constructor.name;this.status=t;this.pppMessage=r}}async function maybeFetchError(e,t){let r;let s;if(typeof e==="function"){const t=await e();r=t.ok;s=t.response}else{r=e.ok;s=e}if(!r){throw new FetchError({...s,...{message:await s.text(),pppMessage:t}})}else return s}class TradingError extends Error{constructor({message:e="Trading error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}serialize(){return{name:this.name,args:{message:this.message,details:this.details}}}}class RemoteTraderError extends Error{constructor({message:e="Trader error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}serialize(){return{name:this.name,args:{message:this.message,details:this.details}}}}class AuthorizationError extends Error{constructor({message:e="Authorization error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class ConnectionLimitExceededError extends Error{constructor({message:e="Connection limit exceeded."}={}){super(e);this.name=this.constructor.name}}class TraderTrinityError extends Error{constructor({message:e="Trader trinity error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class ConnectionError extends Error{constructor({message:e="Connection error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class UTEXBlockError extends Error{constructor({message:e="UTEX block error.",details:t}={}){super(e);this.name=this.constructor.name;this.details=t}}class NoInstrumentsError extends Error{constructor({message:e="No instruments.",trader:t,currentCacheVersion:r,lastCacheVersion:s}={}){super(e);this.name=this.constructor.name;this.trader=t;this.currentCacheVersion=r;this.lastCacheVersion=s}}class StaleInstrumentCacheError extends Error{constructor({message:e="Stale instrument cache.",trader:t,currentCacheVersion:r,lastCacheVersion:s}={}){super(e);this.name=this.constructor.name;this.trader=t;this.currentCacheVersion=r;this.lastCacheVersion=s}}class EventBus{#e={};isValidType(e){return typeof e==="string"}isValidHandler(e){return typeof e==="function"}on(e,t){if(!e||!t)return false;if(!this.isValidType(e))return false;if(!this.isValidHandler(t))return false;let r=this.#e[e];if(!r)r=this.#e[e]=[];if(r.indexOf(t)>=0)return false;t._once=false;r.push(t);return true}once(e,t){if(!e||!t)return false;if(!this.isValidType(e))return false;if(!this.isValidHandler(t))return false;const r=this.on(e,t);if(r){t._once=true}return r}off(e,t){if(!e)return this.offAll();if(!t){this.#e[e]=[];return}if(!this.isValidType(e))return;if(!this.isValidHandler(t))return;const r=this.#e[e];if(!r||!r.length)return;for(let e=0;e<r.length;e++){const s=r[e];if(s===t){r.splice(e,1);break}}}offAll(){this.#e={}}emit(e,t){if(!e||!this.isValidType(e))return;const r=this.#e[e];if(!r||!r.length)return;const s=this.createEvent(e,t);for(const t of r){if(!this.isValidHandler(t))continue;if(t._once)s.once=true;t(s);if(s.once)this.off(e,t)}}has(e,t){if(!e||!this.isValidType(e))return false;const r=this.#e[e];if(!r||!r.length)return false;if(!t||!this.isValidHandler(t))return true;return r.indexOf(t)>=0}getHandlers(e){if(!e||!this.isValidType(e))return[];return this.#e[e]||[]}createEvent(e,t,r=false){const s={type:e,detail:t,timestamp:Date.now(),once:r};return s}}function $throttle(e,t){let r=false,s,n;function wrapper(){if(r){s=arguments;n=this;return}e.apply(this,arguments);r=true;setTimeout((function(){r=false;if(s){wrapper.apply(n,s);s=n=null}}),t)}return wrapper}function $debounce(e,t){let r;return function(){clearTimeout(r);r=setTimeout((()=>e.apply(this,arguments)),t)}}function throttle(e=0){return(t,r,s)=>{if(!s||typeof s.value!=="function"){throw new Error("throttle can only decorate functions.")}const n=s.value;s.value=$throttle(n,e);Object.defineProperty(t,r,s)}}function debounce(e=0){return(t,r,s)=>{if(!s||typeof s.value!=="function"){throw new Error("debounce can only decorate functions.")}const n=s.value;s.value=$debounce(n,e);Object.defineProperty(t,r,s)}}async function later(e){return new Promise((function(t){setTimeout(t,e)}))}function unsupportedInstrument(e=""){return{symbol:e,notSupported:true}}class TraderDatum{sources={};refs=new Map;values=new Map;#t=new Map;trader;doNotSaveValue;constructor(e){this.trader=e}filter(e,t,r,s,n){return true}hasSource(e){for(const t in this.sources){if(this.sources[t].has(e)){return true}}return false}dataArrived(e,t,r={}){if(!t){return}if(this.doNotSaveValue!==true&&r.doNotSaveValue!==true){const s=this.trader.getSymbol(t);if(typeof r.saveSlot==="undefined"){this.values.set(s,e)}else if(r.saveSlot>=0){const t=this.values.get(s)??[];t[r.saveSlot]=e;this.values.set(s,t)}}for(const s in this.sources){for(const[n,i]of this.sources[s]){if(this.trader.instrumentsAreEqual(n.instrument,t)&&this.filter(e,t,n,s,r)){this.trader.assignSourceField(n,i,this[s]?.(e,t,{source:n,options:r})??this.emptyValue(s)??"—")}}}}emptyValue(e){switch(e){case f.CANDLE:case f.MARKET_PRINT:case f.ORDERBOOK:case f.NOII:return{};case f.TRADING_STATUS:case f.STATUS:return""}return"—"}async subscribe(e,t,r){if(!this.#t.has(e)&&e.canChangeInstrument){const listener=async({detail:e})=>{const{source:t,oldValue:r}=e;for(const e of Object.keys(this.sources)){if(this.sources[e].has(t)){const s=this.sources[e].get(t);if(r){await this.unsubscribe(t,r)}await this.subscribe(t,s,e)}}};e.addEventListener("instrumentchange",listener);this.#t.set(e,listener)}if(!e.instrument){return}const s=this.trader.getSymbol(e.instrument);const n=this.refs.get(s)??0;if(n===0){this.refs.set(s,1);return this.firstReferenceAdded?.(e,s,r)}else{this.refs.set(s,n+1);const i=this.values.get(s);if(!Array.isArray(i)||this.slotted===false){if(typeof i!=="undefined"){if(this.filter(i,e.instrument,e,r,{origin:"datum"})){if(e.instrument){this.trader.assignSourceField(e,t,this[r]?.(i,e.instrument,{source:e,origin:"datum"})??this.emptyValue(r)??"—")}else{this.trader.assignSourceField(e,t,this.emptyValue(r)??"—")}}}}else{for(const s of i){if(this.filter(s,e.instrument,e,r,{origin:"datum"})){if(e.instrument&&typeof s!=="undefined"){this.trader.assignSourceField(e,t,this[r]?.(s,e.instrument,{source:e,origin:"datum"})??this.emptyValue(r)??"—")}else{this.trader.assignSourceField(e,t,this.emptyValue(r)??"—")}}}}}}async unsubscribe(e,t){if(!this.hasSource(e)&&e.canChangeInstrument){const t=this.#t.get(e);if(t){e.removeEventListener("instrumentchange",t);this.#t.delete(e)}}if(!t&&!e.instrument){return}const r=this.trader.getSymbol(t??e.instrument);const s=this.refs.get(r)??0;if(s===1){this.refs.delete(r);if(this.doNotClearValue!==true){this.values.delete(r)}return this.lastReferenceRemoved?.(e,r)}else if(s>1){this.refs.set(r,Math.max(0,s-1))}}}class GlobalTraderDatum{sources={};refCount=0;trader;value=new Map;#t=new Map;doNotSaveValue;doNotClearValue;manualAssignment;constructor(e){this.trader=e}filter(e,t,r,s,n){return true}dataArrived(e,t={}){const r=this.valueKeyForData(e);if(typeof r!=="undefined"){if(this.doNotSaveValue!==true&&t.doNotSaveValue!==true){this.value.set(r,e)}for(const s in this.sources){for(const[n,i]of this.sources[s]){if(this.filter(e,n,r,s,t)){if(this.manualAssignment!==true){this.trader.assignSourceField(n,i,this[s]?.(e,n,{key:r,field:i,origin:t.origin})??this.emptyValue(s)??"—")}else{this[s]?.(e,n,{key:r,field:i,origin:t.origin})}}}}}else{this.trader.$$debug("no key for data: %o",e)}}emptyValue(e){switch(e){case f.POSITION_SIZE:return 0;case f.POSITION_AVERAGE:return 0;case f.POSITION:case f.REAL_ORDER:case f.TIMELINE_ITEM:case f.TRADER:return{}}return"—"}valueKeyForData(e){return e?.symbol}async subscribe(e,t,r){if(!this.#t.has(e)&&e?.canChangeInstrument){const listener=async({detail:e})=>{const{source:t}=e;for(const e of Object.keys(this.sources)){if(this.sources[e].has(t)){const r=this.sources[e].get(t);this.trader.assignSourceField(t,r,this.emptyValue(e));for(const[s,n]of this.value){if(this.filter(n,t,s,e,{origin:"datum"})){if(this.manualAssignment!==true){this.trader.assignSourceField(t,r,this[e]?.(n,t,{key:s,field:r,origin:"datum"})??this.emptyValue(e)??"—")}else{this[e]?.(n,t,{key:s,field:r,origin:"datum"})}}}}}};e.addEventListener("instrumentchange",listener);this.#t.set(e,listener)}if(this.refCount===0){this.refCount=1;return this.firstReferenceAdded?.(e,t,r)}else{this.refCount++;for(const[s,n]of this.value){if(this.filter(n,e,s,r,{origin:"datum"})){if(this.manualAssignment!==true){this.trader.assignSourceField(e,t,this[r]?.(n,e,{key:s,field:t,origin:"datum"})??this.emptyValue(r)??"—")}else{this[r]?.(n,e,{key:s,field:t,origin:"datum"})}}}}}async unsubscribe(e,t,r){if(!this.hasSource(e)&&e.canChangeInstrument){const t=this.#t.get(e);if(t){e.removeEventListener("instrumentchange",t);this.#t.delete(e)}}if(this.refCount===1){this.refCount=0;if(this.doNotClearValue!==true){this.value.clear()}return this.lastReferenceRemoved?.(e,t,r)}else if(this.refCount>1){this.refCount--}}}class TraderEventDatum extends GlobalTraderDatum{}class ConditionalOrderDatum extends GlobalTraderDatum{async firstReferenceAdded(){for(const e of await this.trader.conditionalOrders()){this.dataArrived(e,{origin:"datum"})}}valueKeyForData(e){return e?.orderId}[f.CONDITIONAL_ORDER](e){return e}}GlobalTraderDatum.prototype.hasSource=TraderDatum.prototype.hasSource;class Trader{bus=new EventBus;datums={};document={};#r=new Map;get instruments(){return this.#r}#s=[];#n=[];get rawConditionalOrders(){return this.#n??[]}createdAt=(new Date).toISOString();constructor(e,t=[]){this.document=e;t.forEach((({type:e,datums:t})=>{const r=new(this.getRealDatumType(e))(this);t.forEach((e=>{r.sources[e]=new Map;this.datums[e]=r}));this.#s.push(r)}))}formatException(e={}){return{name:e.name??"TradingError",message:e.message??"Unknown trader error occurred.",details:e.details??{},stack:e.stack??""}}conditionalOrderIdCounter=0;nextConditionalOrderId(){return`${Date.now()}:${this.conditionalOrderIdCounter++}`}getRealDatumType(e){return e}call(e){return e}serialize(){return{createdAt:this.createdAt,document:this.document,broker:this.getBroker(),dictionary:this.getDictionary(),exchange:this.getExchange(),observedAttributes:this.getObservedAttributes()}}#i(e,t,r){if(e==="global"){return this.#n.find((e=>e.payload.orderId===t))}else if(e==="instrument"){return this.#n.find((e=>e.payload.orderId===t&&this.instrumentsAreEqual(e.instrument,r)))}}async placeConditionalOrder({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i}){if(!r?.orderId){throw new TradingError({message:"Missing payload.orderId.",details:{instrument:e,direction:t,payload:r}})}const o=r.order.singleton;const a=r.order.oneOff===true;let c;if(typeof s==="string"){c=this.#i(o,r.orderId,e);if(!c){const{default:e}=await __nccwpck_require__(930)(`${s}?t=${Date.now()}`);c=new e(this);c.factory=e;!a&&this.#n.push(c)}}else if(typeof n==="string"&&typeof process!=="undefined"&&process.release.name==="node"){c=this.#i(o,r.orderId,e);if(!c){if(!n){throw new TradingError({message:"E_MISSING_ORDER_CODE",details:{instrument:e,direction:t,payload:r}})}let s;globalThis.pppOrderInstanceForWorkerRecv=e=>s=e;try{globalThis.vm.runInThisContext(n,{filename:r.orderId})}finally{globalThis.pppOrderInstanceForWorkerRecv=null}if(!s){throw new TradingError({message:"Missing pppOrderInstanceForWorkerRecv.",details:{instrument:e,direction:t,payload:r}})}c=new s(this);c.factory=s;!a&&this.#n.push(c)}}else if(typeof i==="function"){c=this.#i(o,r.orderId,e);if(!c){c=new i(this);c.factory=i;!a&&this.#n.push(c)}}if(c){return c.place({instrument:e,direction:t,payload:r})}else{throw new TradingError({message:"Missing orderInstance.",details:{instrument:e,direction:t,payload:r}})}}async pco({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i}){return this.placeConditionalOrder({instrument:e,direction:t,payload:r,implUrl:s,code:n,instance:i})}conditionalOrders(e=false){const t=[];for(const r of this.#n){if(e){t.push(r)}else if(typeof r.serialize==="function"){t.push(r.serialize())}}return t}async performConditionalOrderAction(e,t,r={}){const s=this.#n.find((t=>t.orderId===e));if(typeof s?.[t]==="function"){return s?.[t](r)}}async pcoa(e,t,r={}){return this.performConditionalOrderAction(e,t,r)}async cancelConditionalOrder(e,t={}){const r=this.#n.find((t=>t.orderId===e));if(r){this.#n.splice(this.#n.indexOf(r),1);if(typeof r.cancel==="function"){return r.cancel(t)}}}async cco(e,t={}){return this.cancelConditionalOrder(e,t)}async cancelAllConditionalOrders({instrument:e,filter:t,payload:r={}}={}){const s=[];for(const e of this.#n){s.push({orderId:e.orderId,instrument:e.instrument,side:e.side})}for(const n of s){if(e&&!this.instrumentsAreEqual(n.instrument,e)){continue}if(t==="buy"&&n.side!=="buy"){continue}if(t==="sell"&&n.side!=="sell"){continue}void this.cancelConditionalOrder(n.orderId,r)}}async instrumentsArrived(e){this.#r=e}async subscribeField({source:e,field:t,datum:r}){const s=this.datums[r];if(typeof s!=="undefined"){if(!s.sources[r].has(e)){s.sources[r].set(e,t);return s.subscribe(e,t,r)}}}async subscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){if(typeof s==="string"){await this.subscribeField({source:e,field:r,datum:s})}else if(typeof s==="object"){await this.subscribeField({source:e,field:r,datum:s.datum})}}}async unsubscribeField({source:e,datum:t}){const r=this.datums[t];if(typeof r!=="undefined"){if(r.sources[t].has(e)){r.sources[t].delete(e);return r.unsubscribe(e)}}}async unsubscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){await this.unsubscribeField({source:e,field:r,datum:s})}}async resubscribe(e=[]){const t=[];for(const r of this.#s){for(const s of Object.keys(r.sources)){for(const[n,i]of r.sources[s]){if(!e.length||e.includes(s)){t.push({source:n,field:i,datum:s})}}}}for(const{source:e,field:r,datum:s}of t){await this.unsubscribeField({source:e,field:r,datum:s})}for(const{source:e,field:r,datum:s}of t){await this.subscribeField({source:e,field:r,datum:s})}}async estimate(){return{}}async redisCommand(e,t=[]){if(globalThis.ppp?.runtime?.redis){return globalThis.ppp?.runtime?.redis.call(e,...t)}else{return null}}getEnvVar(e){if(typeof process!=="undefined"&&typeof process.env!=="undefined"){return process.env[e]}}estimateCommission(e,t,r,s){return 0}assignSourceField(e,t,r){switch(this.document.runtime){case"main-thread":e[t]=r;break;case"shared-worker":if(e.mainTrader&&e.mainTrader.document._id===self.pppTrader.document._id){e[t]=r;return}e.port.postMessage({type:"assign",sourceID:e.sourceID,field:t,value:r});break;case"url":if(e.mainTrader===this){e[t]=r;return}if(typeof e.ws==="undefined"){return this.$$debug("no ws in URL source: %o",e)}!e.ws.closed&&e.ws.send(JSON.stringify([{T:"assign",sourceID:e.sourceID,field:t,value:r}]));break}}traderEvent(e={}){if(this.datums[f.TRADER]){for(const[t,r]of this.datums[f.TRADER].sources[f.TRADER]){this.assignSourceField(t,r,e)}}}relativeBondPriceToPrice(e,t){return this.fixPrice(t,e*t.nominal/100)}bondPriceToRelativeBondPrice(e,t){return+(e*100/t.nominal).toFixed(2)}caps(){return this.document.caps??[]}hasCap(e){const t=this.caps();if(typeof e==="string")return t.indexOf(e)>-1;else if(Array.isArray(e))return e.every((e=>t.indexOf(e)>-1));else return false}fixPrice(e,t){t=stringToFloat(t);const r=getInstrumentPrecision(e,t);if(!t||isNaN(t))t=0;const s=getInstrumentMinPriceIncrement(e,t);t=Math.round(t/s)*s;return+t.toFixed(r)}fixQuantity(e,t){t=stringToFloat(t);const r=getInstrumentQuantityPrecision(e,t);if(!t||isNaN(t))t=0;const s=e.minQuantityIncrement??1;t=Math.round(t/s)*s;return+t.toFixed(r)}calcDistantPrice(e,t,r,s="down"){if(s!=="down"&&s!=="up"){s="down"}if(!e){return 0}t=stringToFloat(t);if(!t||isNaN(t)){return 0}let n=0;if(r.value>0){if(r.unit==="+"){const i=getInstrumentMinPriceIncrement(e,t)*r.value;n=s==="down"?t-i:t+i}else if(r.unit==="%"){n=s==="down"?t-t*r.value/100:t+t*r.value/100}else{n=Math.max(0,s==="down"?t-r.value:t+r.value)}if(n>0){return this.fixPrice(e,n)}else{return 0}}else{return t}}getSymbol(e={}){let t=e.symbol;if(!t)return"";if(/~/gi.test(t))t=t.split("~")[0];return t}symbolToCanonical(e=""){return e.replace("."," ").replace("-"," ").replace("/"," ")}adoptInstrument(e={}){const t=this.#r.get(e.symbol)??{};let r=e.symbol===t.symbol;if(e.exchange===c.MOEX&&t.exchange!==c.MOEX){r=false}if(t.exchange===c.MOEX&&e.exchange!==c.MOEX){r=false}if(r){return t}else{return unsupportedInstrument(e.symbol)}}instrumentsAreEqual(e,t){const r=this.adoptInstrument(e);const s=this.adoptInstrument(t);return r.symbol===s.symbol&&r.exchange===s.exchange}getBroker(){return"*"}getDictionary(){return null}getExchange(){return"*"}getObservedAttributes(){return[]}getInstrumentIconUrl(e){if(!e||e?.symbol==="PRN"){return"static/instruments/unknown.svg"}if(e?.type==="currency"){return`static/currency/${e.symbol.slice(0,3)}.svg`}let t=e?.symbol;if(t==="TCS"&&e.exchange===c.SPBX){return"static/instruments/stocks/rus/TCSG.svg"}if((e.symbol==="GOLD"||e.symbol==="GOLD~MOEX")&&e.exchange===c.MOEX){return"static/instruments/etfs/rus/GOLD.svg"}if(typeof t==="string"){t=t.split("/")[0].split("-")[0].split("-RM")[0];if(t.endsWith("@GS")||t.endsWith("@DE")||t.endsWith("@GR")||t.endsWith("@UR")||t.endsWith("@KT")){return"static/instruments/unknown.svg"}t=t.split("@US")[0]}if(e?.currency==="HKD"){return`static/instruments/stocks/hk/${t.replace(" ","-")}.svg`}if(e?.currency==="CNY"){return`static/instruments/${e?.type}s/cny/${t.replace(" ","-")}.svg`}const r=e?.symbol?.endsWith("-RM");if(!r){if(e?.exchange===c.MOEX||e?.currency==="RUB"){return`static/instruments/${e?.type}s/rus/${t.replace(" ","-")}.svg`}}if((e?.exchange===c.SPBX||r)&&t!=="TCS"){return`static/instruments/stocks/us/${t.replace(" ","-")}.svg`}if(e?.exchange===c.US){return`static/instruments/stocks/us/${t.replace(" ","-").split("~")[0]}.svg`}return"static/instruments/unknown.svg"}search(e=""){let t=null;const r=[];const s=[];const n=[];const i=[];const o=e.trim().replaceAll(/[^~a-z0-9\.\s\u0400-\u04FF]/gi,"").toUpperCase();const a=cyrillicToLatin(o);const c=latinToCyrillic(o);if(typeof this.instrumentsSearchIndex==="undefined"){this.instrumentsSearchIndex=[];for(const[e,t]of this.instruments){if(e){const e=this.getSymbol(t);const r=e.length;this.instrumentsSearchIndex[r]??={};this.instrumentsSearchIndex[r][e]??=[];this.instrumentsSearchIndex[r][e].push(t)}}}if(o.length){for(const e of this.instrumentsSearchIndex){if(e){for(const u in e){for(const d of e[u]){if(d.removed)continue;const e=d.symbol.replaceAll(/[^~a-z0-9\s\u0400-\u04FF]/gi,"").toUpperCase();const u=this.getSymbol(d);const l=d.fullName.toUpperCase();if((e===o||u===o)&&t===null){t=d}if(r.length<10&&(e.startsWith(o)||e.startsWith(a)||e.startsWith(c))){r.push(d)}if(n.length<10&&(l.startsWith(o)||l.startsWith(a)||l.startsWith(c))){n.push(d)}if(s.length<10&&(new RegExp(o,"ig").test(e)||new RegExp(a,"ig").test(e)||new RegExp(c,"ig").test(e))){s.push(d)}if(l&&i.length<10&&(new RegExp(o,"ig").test(l)||new RegExp(a,"ig").test(l)||new RegExp(c,"ig").test(l))){i.push(d)}}}}}}return{exactSymbolMatch:t,startsWithSymbolMatches:r,regexSymbolMatches:s.sort(((e,t)=>e.fullName.localeCompare(t.fullName))),startsWithFullNameMatches:n.sort(((e,t)=>e.fullName.localeCompare(t.fullName))),regexFullNameMatches:i.sort(((e,t)=>e.fullName.localeCompare(t.fullName)))}}}class USTrader extends(null&&Trader){adoptInstrument(e={}){if(![EXCHANGE.SPBX,EXCHANGE.US,EXCHANGE.UTEX_MARGIN_STOCKS].includes(e.exchange)){return unsupportedInstrument(e.symbol)}if(e.symbol==="SPB@US"){return this.instruments.get("SPB")}if(e.symbol==="TCS"&&e.exchange===EXCHANGE.SPBX){return unsupportedInstrument(e.symbol)}let t=true;["FIVE","CARM","ASTR","GOLD"].forEach((r=>{if(this.getSymbol(e)===r&&e.exchange===EXCHANGE.MOEX){t=false}}));if(!t){return unsupportedInstrument(e.symbol)}if(e.symbol?.endsWith("~US")){return super.adoptInstrument({...e,...{symbol:e.symbol.replace("~US","")}})}return super.adoptInstrument(e)}getInstrumentIconUrl(e){if(!e){return"static/instruments/unknown.svg"}if(e.symbol==="PRN"){return"static/instruments/stocks/us/PRN@US.svg"}if(e.currency==="USD"||e.currency==="USDT"){return`static/instruments/stocks/us/${e.symbol.replace(" ","-").replace("/","-")}.svg`}return super.getInstrumentIconUrl(e)}}function pppTraderInstanceForWorkerIs(e){if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.pppTraderInstance??=e}else if(typeof process!=="undefined"&&process.release.name==="node"){globalThis.pppTraderInstanceForWorkerRecv?.(e)}}class RemoteSource{bus=new EventBus;port;sourceID;canChangeInstrument;constructor(e,t,r){this.sourceID=e;this.canChangeInstrument=!!t;this.port=r}instrument;attributes=new Map;getAttribute(e){return this.attributes.get(e)}addEventListener(e,t){return this.bus.on(e,t)}removeEventListener(e,t){return this.bus.off(e,t)}}class RemoteTraderRuntime{document;#o;#a;#c;#u;#d;#l;#m=new Map;get worker(){return this.#c}constructor(e){this.document=e;if(this.document.runtime==="url"){const e=new URL(this.document.runtimeUrl);if(e.protocol==="http:"){e.protocol="ws:"}else{e.protocol="wss:"}this.#l=new URL(e).toString()}}#E(){if(typeof this.#d==="undefined"){this.#d=100}else{this.#d+=100;if(this.#d>500){this.#d=500}}return this.#d}#T(e){if(this.#u?.readyState===WebSocket.OPEN){return this.#u}else if(this.#a&&!e){return this.#a}else{this.#a=new Promise((e=>{this.#u=new WebSocket(this.#l);this.#u.onclose=async()=>{await later(this.#E());e(this.#T(true))};this.#u.onerror=()=>this.#u.close();this.#u.onmessage=({data:t})=>{const r=JSON.parse(t);if(Array.isArray(r)){for(const t of r){if(t.T==="ready"){return e(this.#u)}else if(t.T==="success"&&t.msg==="connected"){return this.#u.send(JSON.stringify({T:"connack",_id:this.document._id}))}else if(t.T==="assign"){const e=this.#m.get(t.sourceID);if(e?.sourceID===t.sourceID){e[t.field]=t.value}}}}}}));return this.#a}}async subscribeField({source:e,field:t,datum:r}){if(this.document.runtime==="shared-worker"){const s=new MessageChannel;s.port1.onmessage=({data:t})=>{if(t?.type==="assign"){if(e.sourceID===t.sourceID){e[t.field]=t.value}}};self.pppPorts[0].postMessage({type:"shared-worker-subscribe-field",document:this.document,port2:s.port2,sourceID:e.sourceID,instrument:e.instrument,canChangeInstrument:e.canChangeInstrument,field:t,datum:r},[s.port2])}else if(this.document.runtime==="url"){await this.#T();this.#u.send(JSON.stringify({T:"source-changed",sourceID:e.sourceID,reason:"instrument",oldValue:null,newValue:e.instrument,canChangeInstrument:e.canChangeInstrument,doNotFire:true}));this.#m.set(e.sourceID,e);return this.#u.send(JSON.stringify({T:"subscribe-field",sourceID:e.sourceID,field:t,datum:r,canChangeInstrument:e.canChangeInstrument}))}}async subscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){if(typeof s==="string"){await this.subscribeField({source:e,field:r,datum:s})}else if(typeof s==="object"){await this.subscribeField({source:e,field:r,datum:s.datum})}}}async unsubscribeField({source:e,field:t,datum:r}){if(this.document.runtime==="shared-worker"){return self.pppPorts[0].postMessage({type:"shared-worker-unsubscribe-field",document:this.document,sourceID:e.sourceID,field:t,datum:r})}else if(this.document.runtime==="url"){await this.#T();return this.#u.send(JSON.stringify({T:"unsubscribe-field",sourceID:e.sourceID,field:t,datum:r}))}}async unsubscribeFields({source:e,fieldDatumPairs:t={}}){for(const[r,s]of Object.entries(t)){await this.unsubscribeField({source:e,field:r,datum:s})}}async resubscribe(e=[]){if(this.document.runtime==="shared-worker"){return self.pppPorts[0].postMessage({type:"shared-worker-resubscribe",document:this.document,onlyForDatums:e})}else if(this.document.runtime==="url"){await this.#T();return this.#u.send(JSON.stringify({T:"resubscribe",onlyForDatums:e}))}}async loadSharedOrRemoteTrader(){if(this.#o){return this.#o}else{switch(this.document.runtime){case"main-thread":return null;case"shared-worker":if(this.document._id===self.pppTrader?.document?._id){return self.pppTrader}return this.#o=new Promise((e=>{const t=new MessageChannel;const r=setTimeout((()=>e(null)),5e3);t.port1.onmessage=({data:t})=>{if(t.type==="shared-worker-created"){clearTimeout(r);e(this)}};self.pppPorts[0].postMessage({type:"shared-worker-needed",document:this.document,port2:t.port2},[t.port2])}));case"url":await this.#T();return this}}}}class RemoteTradersFromSharedWorker{runtimes=new Map;async getOrCreateTrader(e){if(e){if(e.runtime==="main-thread"){return null}if(!this.runtimes.has(e._id)){this.runtimes.set(e._id,new RemoteTraderRuntime(e))}return this.runtimes.get(e._id).loadSharedOrRemoteTrader()}}}if(typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope){self.ppp=new class{traders=new RemoteTradersFromSharedWorker;async getOrCreateTrader(e){return this.traders.getOrCreateTrader(e)}async fetch(e,t={},r=[]){const s=self.globalProxyUrl;if(s){const n=new URL(e);t.headers??={};t.headers["X-Host"]=n.hostname;for(const e of Object.keys(t.headers)){const t=e.toLowerCase();if(t==="x-host"){continue}if(!r.includes(t)){r.push(e)}}t.headers["X-Allowed-Headers"]=r.join(",");n.hostname=new URL(s).hostname;return fetch(n.toString(),t)}else{return fetch(e,t)}}};self.sessionStorage=new class{#f=new Map;getItem(e){return this.#f.get(e)}setItem(e,t){this.#f.set(e,t)}removeItem(e){this.#f.delete(e)}};self.pppSources=new Map;self.pppPortSources=new WeakMap;self.pppPorts=[];self.onconnect=e=>{const t=e.ports[0];self.pppPortSources.set(t,new Set);const multiPurposeEventListener=async({data:e})=>{if(e?.type==="close"){const e=self.pppPorts.indexOf(t);if(e>-1){self.pppPorts.splice(e,1)}t.removeEventListener("message",multiPurposeEventListener);if(self.pppPortSources.has(t)){for(const e of self.pppPortSources.get(t)){for(const t in self.pppTrader.datums){const r=self.pppTrader.datums[t].sources[t];if(r.has(e)){await self.pppTrader.unsubscribeField({source:e,datum:t})}}}self.pppPortSources.delete(t)}}else if(e?.type==="connack"){if(typeof self.pppTrader==="undefined"){self.pppTrader=new self.pppTraderInstance(e.document);self.globalProxyUrl=e.globalProxyUrl;self.rootUrl=e.rootUrl;await __nccwpck_require__(723)(`${self.rootUrl}/lib/debug.js`);self.pppTrader.$$debug??=globalThis.ppp.$debug(e.document._id);self.pppTrader.$$connection??=self.pppTrader.$$debug.extend("connection");if(typeof self.pppTrader.oneTimeInitializationCallback==="function"){await self.pppTrader.oneTimeInitializationCallback()}}t.postMessage({type:"init"})}else if(e?.type==="instruments"){if(typeof self.pppTrader!=="undefined"){await(self.pppTrader.instrumentsArrived?.(e.instruments));t.postMessage({type:"ready"})}}else if(e?.type==="rpc"){try{t.postMessage({type:`rpc-${e.rid}`,response:await self.pppTrader[e.method](...e.args)})}catch(r){t.postMessage({type:`rpc-${e.rid}`,exception:r.serialize?.()??{name:r.name??"RemoteTraderError",args:{details:r.name,message:r.message}}})}}else if(e?.type==="source-changed"){if(!self.pppSources.has(e.sourceID)){self.pppSources.set(e.sourceID,new RemoteSource(e.sourceID,e.canChangeInstrument,e.port2??t));if(!e.port2){self.pppPortSources.get(t).add(self.pppSources.get(e.sourceID))}}const r=self.pppSources.get(e.sourceID);switch(e.reason){case"attribute":r.attributes.set(e.attribute,e.value);break;case"instrument":r.instrument=e.newValue;if(!e.doNotFire){r.bus.emit("instrumentchange",{source:r,oldValue:e.oldValue,newValue:e.newValue})}break}}else if(e?.type==="subscribe-field"){const r=self.pppSources.get(e.sourceID);if(r){try{await self.pppTrader.subscribeField({source:r,field:e.field,datum:e.datum})}catch(r){console.error(r);t.postMessage({type:"subscription-exception",sourceKey:`${e.sourceID}:${e.field}`,exception:r.serialize?.()??{name:r.name??"RemoteTraderError",args:{details:r.name,message:r.message}}})}}}else if(e?.type==="unsubscribe-field"){const t=self.pppSources.get(e.sourceID);if(t){self.pppTrader.unsubscribeField({source:t,field:e.field,datum:e.datum})}}else if(e?.type==="resubscribe"){self.pppTrader.resubscribe(e.onlyForDatums??[])}else if(e?.type==="terminate"){t.removeEventListener("message",multiPurposeEventListener);self.close()}};t.addEventListener("message",multiPurposeEventListener);!self.pppPorts.includes(t)&&self.pppPorts.push(t);t.start();t.postMessage({type:"conn"})}}function parseJwt(e){const[,t]=e.split(".");return JSON.parse(typeof Buffer!=="undefined"?Buffer.from(t,"base64"):atob(t))}function isJWTTokenExpired(e){if(e){try{const{exp:t}=parseJwt(e);if(typeof t==="number"){return Date.now()+1e3>=t*1e3}}catch{return true}}return true}function stringToBuffer(e){const t=typeof Buffer!=="undefined"?Buffer.from(e,"base64").toString("binary"):globalThis.atob(e);const r=new ArrayBuffer(t.length);const s=new Uint8Array(r);for(let e=0;e<t.length;e++){s[e]=t.charCodeAt(e)}return r}function bufferToString(e){const t=String.fromCharCode.apply(null,new Uint8Array(e));return typeof Buffer!=="undefined"?Buffer.from(e).toString("base64"):globalThis.btoa(t)}function generateIV(){return globalThis.crypto.getRandomValues(new Uint8Array(12))}function uuidv4(){return globalThis.crypto.randomUUID()}async function sha256(e){const t=(new TextEncoder).encode(e);const r=await globalThis.crypto.subtle.digest("SHA-256",t);const s=Array.from(new Uint8Array(r));return s.map((e=>e.toString(16).padStart(2,"0"))).join("")}async function HMAC(e,t,r={}){let s=e;const n=new TextEncoder;const i=n.encode(t);if(typeof e==="string"){s=n.encode(e)}const o=await globalThis.crypto.subtle.importKey("raw",s,{name:"HMAC",hash:r.algorithm??"SHA-256"},false,["sign"]);const a=await globalThis.crypto.subtle.sign("HMAC",o,i);if(r?.format==="hex"){const e=Array.from(new Uint8Array(a));const t=e.map((e=>e.toString(16).padStart(2,"0"))).join("");return t}else{return a}}async function generateAWSSigningKey({ycStaticKeySecret:e,date:t,region:r}){const s=await HMAC(`AWS4${e}`,t);const n=await HMAC(s,r);const i=await HMAC(n,"s3");return HMAC(i,"aws4_request")}class AlorTraderDatum extends TraderDatum{guids=new Map;filter(e,t,r,s){if([f.LAST_PRICE,f.LAST_PRICE_RELATIVE_CHANGE,f.LAST_PRICE_ABSOLUTE_CHANGE,f.BEST_BID,f.BEST_ASK,f.EXTENDED_LAST_PRICE,f.EXTENDED_LAST_PRICE_ABSOLUTE_CHANGE,f.EXTENDED_LAST_PRICE_RELATIVE_CHANGE,f.DAY_VOLUME].includes(s)){return r?.instrument?.exchange===this.trader.document.exchange}else if(this.trader.document.exchange===c.SPBX){return[c.SPBX,c.US,c.UTEX_MARGIN_STOCKS].includes(r?.instrument?.exchange)}else if(this.trader.document.exchange===c.MOEX){return r?.instrument?.exchange===c.MOEX}}async subscribe(e,t,r){await this.trader.establishWebSocketConnection();return super.subscribe(e,t,r)}firstReferenceAdded(e,t){const r=this.trader.generateRequestId(t);this.guids.set(t,r);this.trader.guidToDatum.set(r,this);return r}async lastReferenceRemoved(e,t){const r=this.guids.get(t);if(this.trader.connection.readyState===WebSocket.OPEN){await this.trader.ensureAccessTokenIsOk();this.trader.connection.readyState===WebSocket.OPEN&&this.trader.connection.send(JSON.stringify({opcode:"unsubscribe",token:this.trader.accessToken,guid:r}))}this.guids.delete(t);this.trader.guidToDatum.delete(r)}}class QuotesDatum extends AlorTraderDatum{firstReferenceAdded(e,t){if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"QuotesSubscribe",code:t,exchange:this.trader.document.exchange,format:"Simple",token:this.trader.accessToken,guid:super.firstReferenceAdded(e,t)}))}}[f.LAST_PRICE](e,t){if(t.type==="bond"){return this.trader.relativeBondPriceToPrice(e.last_price,t)}else{return e.last_price}}[f.LAST_PRICE_RELATIVE_CHANGE](e){return e.change_percent}[f.LAST_PRICE_ABSOLUTE_CHANGE](e,t){if(t.type==="bond"){return this.trader.relativeBondPriceToPrice(e.change,t)}else{return e.change}}[f.BEST_BID](e,t){if(t.type==="bond"){return this.trader.relativeBondPriceToPrice(e.bid,t)}else{return e.bid}}[f.BEST_ASK](e,t){if(t.type==="bond"){return this.trader.relativeBondPriceToPrice(e.ask,t)}else{return e.ask}}[f.DAY_VOLUME](e,t){return e.volume}}class TimeAndSalesDatum extends AlorTraderDatum{doNotSaveValue=true;firstReferenceAdded(e,t){if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"AllTradesGetAndSubscribe",code:t,exchange:this.trader.document.exchange,depth:0,format:"Simple",token:this.trader.accessToken,guid:super.firstReferenceAdded(e,t)}))}}[f.MARKET_PRINT](e,t){return{tradeId:e.id,side:e.side,timestamp:e.timestamp,symbol:e.symbol,price:t.type==="bond"?this.trader.relativeBondPriceToPrice(e.price,t):e.price,volume:e.qty,pool:this.trader.document.exchange}}}class OrderbookDatum extends AlorTraderDatum{firstReferenceAdded(e,t){if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"OrderBookGetAndSubscribe",code:t,exchange:this.trader.document.exchange,depth:this.trader.document.orderbookDepth||20,format:"Simple",token:this.trader.accessToken,guid:super.firstReferenceAdded(e,t)}))}}[f.ORDERBOOK](e,t){e.bids=e.bids.map((e=>{if(e.pool){return e}return{price:t.type==="bond"?this.trader.relativeBondPriceToPrice(e.price,t):e.price,volume:e.volume,pool:this.trader.document.exchange}}));e.asks=e.asks.map((e=>{if(e.pool){return e}return{price:t.type==="bond"?this.trader.relativeBondPriceToPrice(e.price,t):e.price,volume:e.volume,pool:this.trader.document.exchange}}));return{bids:e.bids,asks:e.asks}}}class AlorTraderGlobalDatum extends GlobalTraderDatum{guid;async subscribe(e,t,r){await this.trader.establishWebSocketConnection();return super.subscribe(e,t,r)}firstReferenceAdded(){this.guid=this.trader.generateRequestId();this.trader.guidToDatum.set(this.guid,this);return this.guid}async lastReferenceRemoved(){const e=this.guid;this.trader.guidToDatum.delete(e);this.guid=null;if(this.trader.connection.readyState===WebSocket.OPEN){await this.trader.ensureAccessTokenIsOk();this.trader.connection.readyState===WebSocket.OPEN&&this.trader.connection.send(JSON.stringify({opcode:"unsubscribe",token:this.trader.accessToken,guid:e}))}}}class PositionsDatum extends AlorTraderGlobalDatum{valueKeyForData(e){if(typeof e.balanceMoney!=="undefined"){return e.portfolio}return super.valueKeyForData(e)}filter(e,t,r,s){if(s!==f.POSITION){const r=e.isCurrency;if(r){if(this.trader.document.portfolioType==="futures"){return false}return e.symbol===t.getAttribute("balance")}return e.symbol===this.trader.getSymbol(t.instrument)}else{if(this.trader.document.portfolioType==="futures"&&e.isCurrency){return false}return true}}firstReferenceAdded(){const e=super.firstReferenceAdded();if(this.trader.document.portfolioType==="futures"&&this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"SpectraRisksGetAndSubscribe",portfolio:this.trader.document.portfolio,exchange:this.trader.document.exchange,format:"Simple",token:this.trader.accessToken,guid:`${e};FORTS`}))}if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"PositionsGetAndSubscribeV2",portfolio:this.trader.document.portfolio,exchange:this.trader.document.exchange,format:"Simple",token:this.trader.accessToken,guid:e}))}}async lastReferenceRemoved(){if(this.trader.connection.readyState===WebSocket.OPEN){if(this.trader.document.portfolioType==="futures"){await this.trader.ensureAccessTokenIsOk();this.trader.connection.readyState===WebSocket.OPEN&&this.trader.connection.send(JSON.stringify({opcode:"unsubscribe",token:this.trader.accessToken,guid:`${this.guid};FORTS`}))}}return super.lastReferenceRemoved()}[f.POSITION](e){if(typeof e.balanceMoney!=="undefined"){return{symbol:"RUB",lot:1,exchange:c.MOEX,averagePrice:null,isCurrency:true,isBalance:true,size:e.balanceMoney,accountId:this.trader.document.portfolio}}const t=e.isCurrency;const r={symbol:e.symbol,lot:e.lotSize,exchange:e.exchange,averagePrice:e.avgPrice,isCurrency:e.isCurrency,isBalance:t,size:e.qty,accountId:e.portfolio};if(t){this.trader.traderEvent({event:"estimate"});return r}else{if(this.trader.document.portfolioType==="futures"){r.instrument=this.trader.futures.get(e.symbol.toUpperCase())}else{r.instrument=this.trader.instruments.get(e.symbol)}if(r.instrument?.type==="bond"){r.averagePrice=this.trader.relativeBondPriceToPrice(r.averagePrice,r.instrument)}return r}}[f.POSITION_SIZE](e){if(typeof e.balanceMoney!=="undefined"){return e.balanceMoney}return e.qty}[f.POSITION_AVERAGE](e,t){if(typeof e.balanceMoney!=="undefined"){return}const r=e.isCurrency;if(r){return}if(t.instrument?.type==="bond"){return this.trader.relativeBondPriceToPrice(e.avgPrice,t.instrument)}else return e.avgPrice}}class TimelineDatum extends AlorTraderGlobalDatum{firstReferenceAdded(){if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"TradesGetAndSubscribeV2",portfolio:this.trader.document.portfolio,exchange:this.trader.document.exchange,format:"Simple",token:this.trader.accessToken,guid:super.firstReferenceAdded()}))}}valueKeyForData(e){return e?.id}[f.TIMELINE_ITEM](e){const t={operationId:e.id,accruedInterest:e.accruedInt??0,commission:e.commission,parentId:e.orderno,symbol:e.symbol,type:e.side==="buy"?_.OPERATION_TYPE_BUY:_.OPERATION_TYPE_SELL,exchange:e.exchange,quantity:e.qty,price:e.price,createdAt:e.date};if(this.trader.document.portfolioType==="futures"){t.instrument=this.trader.futures.get(e.symbol.toUpperCase())}else{t.instrument=this.trader.instruments.get(e.symbol)}if(t.instrument?.type==="bond"){t.price=this.trader.relativeBondPriceToPrice(t.price,t.instrument)}return t}}class RealOrderDatum extends AlorTraderGlobalDatum{firstReferenceAdded(){if(this.trader.connection.readyState===WebSocket.OPEN){this.trader.connection.send(JSON.stringify({opcode:"OrdersGetAndSubscribeV2",portfolio:this.trader.document.portfolio,exchange:this.trader.document.exchange,format:"Simple",token:this.trader.accessToken,guid:super.firstReferenceAdded()}))}}valueKeyForData(e){return e?.id}[f.REAL_ORDER](e){const t={orderId:e.id,symbol:e.symbol,exchange:e.exchange,orderType:e.type,side:e.side,status:e.status,placedAt:e.transTime,endsAt:e.endTime,quantity:e.qty,filled:e.filled,price:e.price};if(this.trader.document.portfolioType==="futures"){t.instrument=this.trader.futures.get(e.symbol.toUpperCase())}else{t.instrument=this.trader.instruments.get(e.symbol)}if(t.instrument?.type==="bond"){t.price=this.trader.relativeBondPriceToPrice(t.price,t.instrument)}return t}}class AlorOpenAPIV2Trader extends Trader{#p=new Map;get futures(){return this.#p}#h;accessToken;#_;connection;#O=uuidv4().split("-")[0];#I=Date.now();guidToDatum=new Map;constructor(e){super(e,[{type:QuotesDatum,datums:[f.LAST_PRICE,f.LAST_PRICE_RELATIVE_CHANGE,f.LAST_PRICE_ABSOLUTE_CHANGE,f.BEST_BID,f.BEST_ASK,f.DAY_VOLUME]},{type:TimeAndSalesDatum,datums:[f.MARKET_PRINT]},{type:OrderbookDatum,datums:[f.ORDERBOOK]},{type:PositionsDatum,datums:[f.POSITION,f.POSITION_SIZE,f.POSITION_AVERAGE]},{type:TimelineDatum,datums:[f.TIMELINE_ITEM]},{type:TraderEventDatum,datums:[f.TRADER]},{type:ConditionalOrderDatum,datums:[f.CONDITIONAL_ORDER]},{type:RealOrderDatum,datums:[f.REAL_ORDER]}]);if(!this.document.portfolioType){this.document.portfolioType="stock"}}async oneTimeInitializationCallback(){this.$$orders=this.$$debug.extend("orders");this.$$orders.log=console.log.bind(console);this.$$executions=this.$$debug.extend("executions");this.$$executions.log=console.log.bind(console);this.$$positions=this.$$debug.extend("positions");this.$$positions.log=console.log.bind(console);this.$$auth=this.$$debug.extend("auth");this.$$auth.log=console.log.bind(console)}getTimeframeList(){return[{name:"Sec",values:[1,5,10]},{name:"Min",values:[1,5,15]},{name:"Hour",values:[1,4]},{name:"Day",values:[1]},{name:"Week",values:[1]},{name:"Month",values:[1]}]}async ensureAccessTokenIsOk(){const e=Math.max(this.document.reconnectTimeout??1e3,1e3);try{if(isJWTTokenExpired(this.accessToken))this.accessToken=void 0;if(typeof this.accessToken==="string")return;if(this.#h){await this.#h}else{this.#h=fetch(`https://oauth.alor.ru/refresh?token=${this.document.broker.refreshToken}`,{method:"POST"}).then((e=>e.json())).then((({AccessToken:e,message:t})=>{if(!e&&/token/i.test(t)){this.accessToken=null;throw new AuthorizationError({details:t})}this.accessToken=e;this.#h=void 0})).catch((t=>{this.$$auth("ensureAccessTokenIsOk failed: %o",t);if(t instanceof AuthorizationError){throw t}this.#h=void 0;return new Promise((t=>{setTimeout((async()=>{await this.ensureAccessTokenIsOk();t()}),e)}))}));await this.#h}}catch(t){this.$$auth("ensureAccessTokenIsOk failed: %o",t);if(t instanceof AuthorizationError){throw t}this.#h=void 0;return new Promise((t=>{setTimeout((async()=>{await this.ensureAccessTokenIsOk();t()}),e)}))}}async establishWebSocketConnection(e){await this.ensureAccessTokenIsOk();if(this.connection?.readyState===WebSocket.OPEN){return this.connection}else if(this.#_&&!e&&this.connection?.readyState!==WebSocket.CLOSED){return this.#_}else{this.#_=new Promise((t=>{this.connection=new WebSocket("wss://api.alor.ru/ws",typeof process!=="undefined"&&process.release.name==="node"?{perMessageDeflate:{clientNoContextTakeover:true,serverNoContextTakeover:true,clientMaxWindowBits:10,serverMaxWindowBits:10,concurrencyLimit:10,threshold:1024}}:void 0);this.connection.onopen=async()=>{if(e){await this.resubscribe()}t(this.connection)};this.connection.onclose=async()=>{await later(Math.max(this.document.reconnectTimeout??1e3,1e3));t(this.establishWebSocketConnection(true))};this.connection.onerror=()=>this.connection.close();this.connection.onmessage=({data:e})=>{if(this.connection.readyState!==WebSocket.OPEN){return}const t=JSON.parse(e);if(t?.httpCode>=400){this.connection.close();return}if(t?.data&&t?.guid){const e=this.guidToDatum.get(t.guid);if(e instanceof QuotesDatum||e instanceof TimeAndSalesDatum){let e=this.instruments.get(t.data.symbol);if(this.document.portfolioType==="futures"){e=this.futures.get(t.data.symbol.toUpperCase())}this.guidToDatum.get(t.guid)?.dataArrived?.(t.data,e)}else if(e instanceof OrderbookDatum){const[e]=t.guid.split(":");let r;if(this.document.portfolioType==="futures"){r=this.futures.get(e)}else{r=this.instruments.get(e)}this.guidToDatum.get(t.guid)?.dataArrived?.(t.data,r)}else if(e instanceof PositionsDatum||e instanceof TimelineDatum||e instanceof RealOrderDatum){this.guidToDatum.get(t.guid)?.dataArrived?.(t.data)}else if(t.guid?.endsWith(";FORTS")){this.datums[f.POSITION].dataArrived?.(t.data)}}}}));return this.#_}}generateRequestId(e){if(!e){return`${this.document.portfolio};${this.#O}-${++this.#I}`}else{return`${e}:${this.document.portfolio};${this.#O}-${++this.#I}`}}async placeMarketOrder({instrument:e,quantity:t,direction:r}){await this.ensureAccessTokenIsOk();const s=this.getSymbol(e);const n=await fetch("https://api.alor.ru/commandapi/warptrans/TRADE/v2/client/orders/actions/market",{method:"POST",body:JSON.stringify({instrument:{symbol:s,exchange:this.document.exchange},side:r.toLowerCase(),type:"market",quantity:t,user:{portfolio:this.document.portfolio}}),headers:{"Content-Type":"application/json","X-ALOR-REQID":this.generateRequestId(s),Authorization:`Bearer ${this.accessToken}`}});const i=await n.json();if(i.message==="success"){return{orderId:i.orderNumber}}else{throw new TradingError({message:i.message})}}async placeLimitOrder({instrument:e,price:t,quantity:r,direction:s}){await this.ensureAccessTokenIsOk();const n=this.getSymbol(e);const i=await fetch("https://api.alor.ru/commandapi/warptrans/TRADE/v2/client/orders/actions/limit",{method:"POST",body:JSON.stringify({instrument:{symbol:n,exchange:this.document.exchange},side:s.toLowerCase(),type:"limit",price:e.type==="bond"?this.bondPriceToRelativeBondPrice(this.fixPrice(e,t),e):this.fixPrice(e,t),quantity:r,user:{portfolio:this.document.portfolio}}),headers:{"Content-Type":"application/json","X-ALOR-REQID":this.generateRequestId(n),Authorization:`Bearer ${this.accessToken}`}});const o=await i.json();if(o.message==="success"){return{orderId:o.orderNumber}}else{throw new TradingError({message:o.message})}}async historicalTimeAndSales({instrument:e,depth:t}){await this.ensureAccessTokenIsOk();const r=`format=Simple&take=${parseInt(t)}&descending=true`;const s=await fetch(`https://api.alor.ru/md/v2/Securities/${this.document.exchange}/${encodeURIComponent(this.getSymbol(e))}/alltrades?${r}`,{cache:"no-cache",headers:{Authorization:`Bearer ${this.accessToken}`}});if(s.ok)return(await s.json())?.map((t=>({tradeId:t.id,side:t.side,time:t.time,timestamp:t.timestamp,symbol:t.symbol,price:e.type==="bond"?this.relativeBondPriceToPrice(t.price,e):t.price,volume:t.qty,pool:this.document.exchange})));else{throw new TradingError({message:await s.text()})}}async historicalCandles({instrument:e,unit:t,value:r,cursor:s}){await this.ensureAccessTokenIsOk();let n;const i=s??Math.trunc(Date.now()/1e3);let o;switch(t){case"Sec":n=r;o=i-7*24*3600;break;case"Min":n=r*60;o=i-7*24*3600;break;case"Hour":n=r*3600;o=i-800*3600;break;case"Day":if(r!==1){return{candles:[]}}n="D";o=i-800*3600*24;break;case"Week":if(r!==1){return{candles:[]}}n="W";o=i-800*3600*24*7;break;case"Month":if(r!==1&&r!==12){return{candles:[]}}n="M";o=i-12*3600*24*7*31;if(r===12){n="Y";o=i-12*5*3600*24*7*31}break}const a=await fetch(`https://api.alor.ru/md/v2/history?symbol=${this.getSymbol(e)}&exchange=${this.document.exchange}&tf=${n}&from=${o}&to=${i}`,{cache:"no-cache",headers:{Authorization:`Bearer ${this.accessToken}`}});if(!a.ok){return{candles:[]}}const c=await a.json();const u=c.history.map((t=>{if(e.type==="bond"){return{open:this.relativeBondPriceToPrice(t.open,e),high:this.relativeBondPriceToPrice(t.high,e),low:this.relativeBondPriceToPrice(t.low,e),close:this.relativeBondPriceToPrice(t.close,e),time:new Date(t.time*1e3).toISOString(),volume:t.volume}}return{open:+t.open.toFixed(getInstrumentPrecision(e)),high:+t.high.toFixed(getInstrumentPrecision(e)),low:+t.low.toFixed(getInstrumentPrecision(e)),close:+t.close.toFixed(getInstrumentPrecision(e)),time:new Date(t.time*1e3).toISOString(),volume:t.volume}}));return{cursor:c.prev,candles:u}}async estimate(e,t,r){if(this.unsupportedInstrument)return{};await this.ensureAccessTokenIsOk();if(e.type==="future")return{};const s=await fetch("https://api.alor.ru/commandapi/warptrans/TRADE/v2/client/orders/estimate",{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.accessToken}`},body:JSON.stringify({portfolio:this.document.portfolio,ticker:this.getSymbol(e),exchange:this.document.exchange,price:t,lotQuantity:r||1})});if(s.status===200){const n=await s.json();let i=n.commission;const o=this.document?.flatCommissionRate??void 0;if(typeof o!=="undefined"){i=t*r*e.lot*o/100}return{marginSellingPowerQuantity:n.quantityToSell,marginBuyingPowerQuantity:n.quantityToBuy,sellingPowerQuantity:n.notMarginQuantityToSell,buyingPowerQuantity:n.notMarginQuantityToBuy,commission:i}}else{throw new TradingError({message:await s.text()})}}async modifyRealOrders({instrument:e,side:t,value:r}){await this.ensureAccessTokenIsOk();const s=await fetch(`https://api.alor.ru/md/v2/clients/${this.document.exchange}/${this.document.portfolio}/orders?format=Simple`,{headers:{Authorization:`Bearer ${this.accessToken}`}});if(s.status===200){const n=await s.json();for(const s of n){if(s.status==="working"&&(s.side===t||t==="all")){if(e&&s.symbol!==this.getSymbol(e))continue;let t;if(this.document.portfolioType==="futures"){t=this.futures.get(s.symbol.toUpperCase())}else{t=this.instruments.get(s.symbol)}if(t?.minPriceIncrement>0){let e=this.fixPrice(t,s.price+t.minPriceIncrement*r);if(t.type==="bond"){e=+(s.price+.01*r).toFixed(2)}const n=this.getSymbol(t);fetch(`https://api.alor.ru/commandapi/warptrans/TRADE/v2/client/orders/actions/limit/${s.id}`,{method:"PUT",body:JSON.stringify({instrument:{symbol:n,exchange:this.document.exchange},side:s.side,type:"limit",price:e,quantity:s.qty-s.filled,user:{portfolio:this.document.portfolio}}),headers:{"Content-Type":"application/json","X-ALOR-REQID":this.generateRequestId(n),Authorization:`Bearer ${this.accessToken}`}}).then((async e=>{if(!e.ok){this.$$orders("error modifying order: %o",await e.text())}}))}}}}else{throw new TradingError({message:await s.text()})}}async cancelRealOrder(e){if(e.orderType==="limit"){await this.ensureAccessTokenIsOk();const t=`portfolio=${this.document.portfolio}&exchange=${this.document.exchange}&stop=false&format=Simple`;const r=await fetch(`https://api.alor.ru/commandapi/warptrans/TRADE/v2/client/orders/${e.orderId}?${t}`,{method:"DELETE",cache:"no-cache",headers:{Authorization:`Bearer ${this.accessToken}`}});if(r.status===200)return{orderId:e.orderId};else{throw new TradingError({message:await r.text()})}}}async cancelAllRealOrders({instrument:e,filter:t}={}){await this.ensureAccessTokenIsOk();const r=await fetch(`https://api.alor.ru/md/v2/clients/${this.document.exchange}/${this.document.portfolio}/orders?format=Simple`,{headers:{Authorization:`Bearer ${this.accessToken}`}});if(r.status===200){const s=await r.json();for(const r of s){if(r.status==="working"){if(e&&r.symbol!==this.getSymbol(e))continue;if(t==="buy"&&r.side!=="buy"){continue}if(t==="sell"&&r.side!=="sell"){continue}r.orderType=r.type;r.orderId=r.id;this.cancelRealOrder(r)}}}else{throw new TradingError({message:await r.text()})}}async instrumentsArrived(e){if(this.document.portfolioType==="futures"){for(const[,t]of e){this.#p.set(t.fullName.split(/\s+/)[0].toUpperCase(),t)}}return super.instrumentsArrived(e)}getBroker(){return d.ALOR}getDictionary(){if(this.document.exchange===c.SPBX)return m.ALOR_SPBX;switch(this.document.portfolioType){case"stock":return m.ALOR_MOEX_SECURITIES;case"futures":return m.ALOR_FORTS;case"currency":return m.ALOR_MOEX_FX_METALS}}getExchange(){if(this.document.exchange===c.SPBX)return c.SPBX;switch(this.document.portfolioType){case"stock":return c.MOEX_SECURITIES;case"futures":return c.MOEX_FORTS;case"currency":return c.MOEX_FX_METALS}}getObservedAttributes(){return["balance"]}getSymbol(e={}){if(e.type==="future"){return e.fullName.split(/\s+/)[0].toUpperCase()}if(e?.currency==="USD"&&e?.symbol==="SPB"&&this.document.exchange===c.SPBX){return"SPB@US"}let t=e.symbol;if(/~/gi.test(t))t=t.split("~")[0];return t}instrumentsAreEqual(e,t){const r=["SPB","SPB@US"];if(r.includes(e?.symbol)&&r.includes(t?.symbol))return true;return super.instrumentsAreEqual(e,t)}adoptInstrument(e={}){if(this.document.exchange===c.MOEX&&e.exchange!==c.MOEX){return unsupportedInstrument(e.symbol)}if(this.document.exchange===c.MOEX&&e?.exchange===c.MOEX&&this.getSymbol(e)==="ASTR"){return this.instruments.get("ASTR")}if(this.document.exchange===c.MOEX&&e?.exchange===c.MOEX&&this.getSymbol(e)==="FIVE"){return this.instruments.get("FIVE")}if(this.document.exchange===c.MOEX&&e?.exchange===c.MOEX&&this.getSymbol(e)==="GOLD"){return this.instruments.get("GOLD")}if(e.symbol==="SPB"&&(e.currency==="USD"||e.currency==="USDT")&&this.document.exchange===c.SPBX){return this.instruments.get("SPB@US")}let t=true;if(this.getSymbol(e)==="TCS"&&(e.exchange===c.US||e.exchange===c.UTEX_MARGIN_STOCKS)){t=false}if(!t){return unsupportedInstrument(e.symbol)}if(e.symbol?.endsWith("~US")){return super.adoptInstrument({...e,...{symbol:e.symbol.replace("~US","")}})}return super.adoptInstrument(e)}async serialize(){await this.ensureAccessTokenIsOk();return{...super.serialize(),accessToken:this.accessToken}}getErrorI18nKey({instrument:e,error:t}){const r=t.message;if(/Invalid quantity/i.test(r)||/BAD_AMOUNT/i.test(r))return"E_INCORRECT_QUANTITY";if(/Price may not be 0 for a limit order/i.test(r)){return"E_INCORRECT_PRICE"}if(/Нехватка средств по лимитам клиента/i.test(r)||/Заявка приводит к возникновению непокрытого риска/i.test(r)){return"E_INSUFFICIENT_FUNDS"}if(/(HALT_INSTRUMENT|INSTR_NOTRADE)/i.test(r)||/Security is in break period/i.test(r)||/Security is not currently trading/i.test(r))return"E_INSTRUMENT_NOT_TRADEABLE";if(/BAD_FLAGS/i.test(r))return"E_WRONG_ORDER_PARAMETERS";if(/Provided json can't be properly deserialised/i.test(r))return"E_INCORRECT_PRICE_OR_QUANTITY";if(/BAD_PRICE_LIMITS/i.test(r)||/Цена сделки вне лимита/i.test(r))return"E_PRICE_OUT_OF_LIMITS";if(/PROHIBITION_CH/i.test(r))return"E_ORDER_BLOCKED_BY_EXCHANGE.";if(/BAD_INSTRUMENT/i.test(r)||/Неизвестный инструмент в заявке/i.test(r))return"E_UNSUPPORTED_INSTRUMENT";if(/Order was canceled before it was posted/i.test(r))return"E_ORDER_REJECTED_BY_EXCHANGE";if(/Сейчас эта сессия не идет/i.test(r))return"E_INACTIVE_TRADING_SESSION";if(/Command Timeout/i.test(r))return"E_REQUEST_TIMEOUT";if(/Minimum available value of the quantity is: 100 of lots/i.test(r))return{key:"E_QUANTITY_MUST_BE_GE_$VALUE",options:{value:100}};let s=r.match(/can not be less than ([0-9.]+)/i)?.[1];if(s){return{key:"E_PRICE_MUST_BE_GE_$VALUE",options:{value:formatPrice(+s,e)}}}s=r.match(/can not be greater than ([0-9.]+)/i)?.[1];if(s){return{key:"E_PRICE_MUST_BE_LE_$VALUE",options:{value:formatPrice(+s,e)}}}s=r.match(/Minimum price step: ([0-9.]+)/i)?.[1];if(s){return{key:"E_MIN_PRICE_STEP_MUST_BE_$VALUE",value:formatPrice(+s,e)}}}}pppTraderInstanceForWorkerIs(AlorOpenAPIV2Trader);const R=AlorOpenAPIV2Trader})();module.exports=r})();