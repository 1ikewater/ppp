import{createRequire as e}from"module";var t={};(()=>{t.d=(e,n)=>{for(var s in n){if(t.o(n,s)&&!t.o(e,s)){Object.defineProperty(e,s,{enumerable:true,get:n[s]})}}}})();(()=>{t.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)})();if(typeof t!=="undefined")t.ab=new URL(".",import.meta.url).pathname.slice(import.meta.url.match(/^file:\/\/\/\w:/)?1:0,-1)+"/";var n={};t.d(n,{e:()=>Connection});const s=e(import.meta.url)("events");class SafeEventEmitter extends s.EventEmitter{emit(e,...t){try{if(e==="error"&&!this.listenerCount("error"))return false;return super.emit(e,...t)}catch(e){return false}}}let r;(function(e){e.VERSION_MAJOR=3;e.VERSION_MINOR=0;let t;(function(e){e[e["Authentication"]=82]="Authentication";e[e["BackendKeyData"]=75]="BackendKeyData";e[e["BindComplete"]=50]="BindComplete";e[e["CloseComplete"]=51]="CloseComplete";e[e["CommandComplete"]=67]="CommandComplete";e[e["CopyData"]=100]="CopyData";e[e["CopyDone"]=99]="CopyDone";e[e["CopyInResponse"]=103]="CopyInResponse";e[e["CopyOutResponse"]=72]="CopyOutResponse";e[e["CopyBothResponse"]=87]="CopyBothResponse";e[e["DataRow"]=68]="DataRow";e[e["EmptyQueryResponse"]=73]="EmptyQueryResponse";e[e["ErrorResponse"]=69]="ErrorResponse";e[e["FunctionCallResponse"]=86]="FunctionCallResponse";e[e["NegotiateProtocolVersion"]=118]="NegotiateProtocolVersion";e[e["NoData"]=110]="NoData";e[e["NoticeResponse"]=78]="NoticeResponse";e[e["NotificationResponse"]=65]="NotificationResponse";e[e["ParameterDescription"]=116]="ParameterDescription";e[e["ParameterStatus"]=83]="ParameterStatus";e[e["ParseComplete"]=49]="ParseComplete";e[e["PortalSuspended"]=115]="PortalSuspended";e[e["ReadyForQuery"]=90]="ReadyForQuery";e[e["RowDescription"]=84]="RowDescription"})(t=e.BackendMessageCode||(e.BackendMessageCode={}));let n;(function(e){e[e["Bind"]=66]="Bind";e[e["Close"]=67]="Close";e[e["CopyData"]=100]="CopyData";e[e["CopyDone"]=99]="CopyDone";e[e["CopyFail"]=102]="CopyFail";e[e["Describe"]=68]="Describe";e[e["Execute"]=69]="Execute";e[e["Flush"]=72]="Flush";e[e["FunctionCall"]=70]="FunctionCall";e[e["Parse"]=80]="Parse";e[e["PasswordMessage"]=112]="PasswordMessage";e[e["Query"]=81]="Query";e[e["Sync"]=83]="Sync";e[e["Terminate"]=88]="Terminate"})(n=e.FrontendMessageCode||(e.FrontendMessageCode={}));let s;(function(e){e["KerberosV5"]="KerberosV5";e["CleartextPassword"]="CleartextPassword";e["MD5Password"]="MD5Password";e["SCMCredential"]="SCMCredential";e["GSS"]="GSS";e["SSPI"]="SSPI";e["GSSContinue"]="GSSContinue";e["SASL"]="SASL";e["SASLContinue"]="SASLContinue";e["SASLFinal"]="SASLFinal"})(s=e.AuthenticationMessageKind||(e.AuthenticationMessageKind={}));let r;(function(e){e[e["text"]=0]="text";e[e["binary"]=1]="binary"})(r=e.DataFormat||(e.DataFormat={}))})(r||(r={}));const i=r.DataFormat;const o=i.binary;let a;(function(e){e[e["CLOSED"]=0]="CLOSED";e[e["CONNECTING"]=1]="CONNECTING";e[e["AUTHORIZING"]=3]="AUTHORIZING";e[e["READY"]=2]="READY";e[e["CLOSING"]=10]="CLOSING"})(a||(a={}));const c={bool:16,bytea:17,char:18,name:19,int8:20,int2:21,int2vector:22,int4:23,regproc:24,text:25,oid:26,tid:27,xid:28,cid:29,oidvector:30,json:114,xml:142,point:600,lseg:601,path:602,box:603,polygon:604,line:628,cidr:650,float4:700,float8:701,unknown:705,circle:718,macaddr8:774,money:790,macaddr:829,inet:869,bpchar:1042,varchar:1043,date:1082,time:1083,timestamp:1114,timestamptz:1184,interval:1186,timetz:1266,bit:1560,varbit:1562,numeric:1700,refcursor:1790,regprocedure:2202,regoper:2203,regoperator:2204,regclass:2205,regtype:2206,record:2249,cstring:2275,any:2276,anyarray:2277,void:2278,trigger:2279,language_handler:2280,internal:2281,anyelement:2283,anynonarray:2776,uuid:2950,jsonb:3802,anyrange:3831,int4range:3904,numrange:3906,tsrange:3908,rstzrange:3910,daterange:3912,int8range:3926,_xml:143,_json:199,_xid8:271,_line:629,_cidr:651,_circle:719,_macaddr8:775,_money:791,_bool:1e3,_bytea:1001,_char:1002,_name:1003,_int2:1005,_int2vector:1006,_int4:1007,_regproc:1008,_text:1009,_xid:1011,_cid:1012,_oidvector:1013,_bpchar:1014,_varchar:1015,_int8:1016,_point:1017,_lseg:1018,_path:1019,_box:1020,_float4:1021,_float8:1022,_polygon:1027,_oid:1028,_macaddr:1040,_inet:1041,_timestamp:1115,_date:1182,_time:1183,_timestamptz:1185,_interval:1187,_numeric:1231,_cstring:1263,_timetz:1270,_bit:1561,_varbit:1563,_uuid:2951,_jsonb:3807};const u={[c.bool]:"bool",[c.bytea]:"bytea",[c.char]:"char",[c.name]:"name",[c.int8]:"int8",[c.int2]:"int2",[c.int2vector]:"int2vector",[c.int4]:"int4",[c.regproc]:"regproc",[c.text]:"text",[c.oid]:"oid",[c.tid]:"tid",[c.xid]:"xid",[c.cid]:"cid",[c.oidvector]:"oidvector",[c.json]:"json",[c.xml]:"xml",[c.point]:"point",[c.lseg]:"lseg",[c.path]:"path",[c.box]:"box",[c.polygon]:"polygon",[c.line]:"line",[c.cidr]:"cidr",[c.float4]:"float4",[c.float8]:"float8",[c.unknown]:"unknown",[c.circle]:"circle",[c.macaddr8]:"macaddr8",[c.money]:"money",[c.macaddr]:"macaddr",[c.inet]:"inet",[c.bpchar]:"bpchar",[c.varchar]:"varchar",[c.date]:"date",[c.time]:"time",[c.timestamp]:"timestamp",[c.timestamptz]:"timestamptz",[c.interval]:"interval",[c.timetz]:"timetz",[c.bit]:"bit",[c.varbit]:"varbit",[c.numeric]:"numeric",[c.refcursor]:"refcursor",[c.regprocedure]:"regprocedure",[c.regoper]:"regoper",[c.regoperator]:"regoperator",[c.regclass]:"regclass",[c.regtype]:"regtype",[c.record]:"record",[c.cstring]:"cstring",[c.any]:"any",[c.anyarray]:"anyarray",[c.void]:"void",[c.trigger]:"trigger",[c.language_handler]:"language_handler",[c.internal]:"internal",[c.anyelement]:"anyelement",[c.anynonarray]:"anynonarray",[c.uuid]:"uuid",[c.jsonb]:"jsonb",[c.anyrange]:"anyrange",[c.int4range]:"int4range",[c.numrange]:"numrange",[c.tsrange]:"tsrange",[c.rstzrange]:"rstzrange",[c.daterange]:"daterange",[c.int8range]:"int8range",[c._xml]:"_xml",[c._json]:"_json",[c._xid8]:"_xid8",[c._line]:"_line",[c._cidr]:"_cidr",[c._circle]:"_circle",[c._macaddr8]:"_macaddr8",[c._money]:"_money",[c._bool]:"_bool",[c._bytea]:"_bytea",[c._char]:"_char",[c._name]:"_name",[c._int2]:"_int2",[c._int2vector]:"_int2vector",[c._int4]:"_int4",[c._regproc]:"_regproc",[c._text]:"_text",[c._xid]:"_xid",[c._cid]:"_cid",[c._oidvector]:"_oidvector",[c._bpchar]:"_bpchar",[c._varchar]:"_varchar",[c._int8]:"_int8",[c._point]:"_point",[c._lseg]:"_lseg",[c._path]:"_path",[c._box]:"_box",[c._float4]:"_float4",[c._float8]:"_float8",[c._polygon]:"_polygon",[c._oid]:"_oid",[c._macaddr]:"_macaddr",[c._inet]:"_inet",[c._timestamp]:"_timestamp",[c._date]:"_date",[c._time]:"_time",[c._timestamptz]:"_timestamptz",[c._interval]:"_interval",[c._numeric]:"_numeric",[c._cstring]:"_cstring",[c._timetz]:"_timetz",[c._bit]:"_bit",[c._varbit]:"_varbit",[c._uuid]:"_uuid",[c._jsonb]:"_jsonb"};const f={name:"bool",oid:c.bool,jsType:"boolean",parseBinary(e){return!!e.readUInt8()},encodeBinary(e,t){e.writeInt8(t?1:0)},parseText(e){return e==="TRUE"||e==="t"||e==="true"||e==="y"||e==="yes"||e==="on"||e==="1"},isType(e){return typeof e==="boolean"}};const h={...f,name:"_bool",oid:c._bool,elementsOID:c.bool};function fastParseInt(e){if(typeof e==="number")return Math.floor(e);if(typeof e!=="string")return NaN;const t=e.length;let n=0;let s=0;let r=false;if(e.startsWith("-")){r=true;s++}do{const t=e.charCodeAt(s);if(t===46)return n;if(t<48||t>57)return NaN;n*=10;n+=t-48}while(++s<t);return r?-n:n}const l={name:"int2",oid:c.int2,jsType:"number",parseBinary(e){return e.readInt16BE(0)},encodeBinary(e,t){e.writeInt16BE(fastParseInt(t))},parseText:fastParseInt,isType(e){return typeof e==="number"&&Number.isInteger(e)&&e>=-32768&&e<=32767}};const d={...l,name:"_int2",oid:c._int2,elementsOID:c.int2};const m={name:"int4",oid:c.int4,jsType:"number",parseBinary(e){return e.readInt32BE(0)},encodeBinary(e,t){e.writeInt32BE(fastParseInt(t))},parseText:fastParseInt,isType(e){return typeof e==="number"&&Number.isInteger(e)}};const p={...m,name:"_int4",oid:c._int4,elementsOID:c.int4};const g=BigInt(0);const y=BigInt("0xffffffff");const _=BigInt(32);function readBigInt64BE(e,t=0){const n=e[t];const s=e[t+7];if(n===undefined||s===undefined)return g;const r=(n<<24)+e[++t]*2**16+e[++t]*2**8+e[++t];return(BigInt(r)<<_)+BigInt(e[++t]*2**24+e[++t]*2**16+e[++t]*2**8+s)}function writeBigUInt64BE(e,t,n=0){let s=Number(t&y);e[n+7]=s;s=s>>8;e[n+6]=s;s=s>>8;e[n+5]=s;s=s>>8;e[n+4]=s;let r=Number(t>>_&y);e[n+3]=r;r=r>>8;e[n+2]=r;r=r>>8;e[n+1]=r;r=r>>8;e[n]=r;return n+8}const w=BigInt(Number.MAX_SAFE_INTEGER);const C={name:"int8",oid:c.int8,jsType:"BigInt",parseBinary(e){const t=typeof e.readBigInt64BE==="function"?e.readBigInt64BE(0):readBigInt64BE(e);return t>=-w&&t<=w?Number(t):t},encodeBinary(e,t){e.writeBigInt64BE(t)},parseText(e){const t=BigInt(e);return t>=-w&&t<=w?Number(t):t},isType(e){return typeof e==="bigint"||typeof e==="number"&&Number.isInteger(e)}};const b={...C,name:"_int8",oid:c._int8,elementsOID:c.int8};const E={name:"float4",oid:c.float4,jsType:"number",parseBinary(e){return Math.round((e.readFloatBE(0)+Number.EPSILON)*100)/100},encodeBinary(e,t){e.writeFloatBE(typeof t==="number"?t:parseFloat(t))},parseText:parseFloat,isType(e){return typeof e==="number"}};const B={...E,name:"_float4",oid:c._float4,elementsOID:c.float4};const S={name:"float8",oid:c.float8,jsType:"number",parseBinary(e){return e.readDoubleBE(0)},encodeBinary(e,t){e.writeDoubleBE(typeof t==="number"?t:parseFloat(t))},parseText:parseFloat,isType(e){return typeof e==="number"}};const I={...S,name:"_float8",oid:c._float8,elementsOID:c.float8};const T={name:"oid",oid:c.oid,jsType:"number",parseBinary(e){return e.readUInt32BE(0)},encodeBinary(e,t){e.writeUInt32BE(fastParseInt(t))},parseText:fastParseInt,isType(e){return typeof e==="number"&&Number.isInteger(e)&&e>=0}};const D={...T,name:"_oid",oid:c._oid,elementsOID:c.oid};const M=/^(\d{4})-?(0[1-9]|1[012])?-?([123]0|[012][1-9]|31)?(?:[T ]?([01][0-9]|2[0-3]):?([0-5][0-9]):?([0-5][0-9])?(?:\.(\d+))?(?:(Z)|(?:([+-])([01]?[0-9]|2[0-3]):?([0-5][0-9])?))?)?$/;const x=/^-?infinity$/;function parseDateTime(e,t,n,s){let r=e.match(M);if(!r){r=e.match(x);if(r)return Number(e.replace("i","I"));return new Date("invalid")}const i=[1970,0,1,0,0,0,0];const o=t?7:3;for(let e=0;e<o;e++){const t=r[e+1];i[e]=fastParseInt(t)||0}if(i[1]>0)i[1]--;if(n&&t&&r[9]){const e=r[9]==="-"?-1:1;i[3]-=(fastParseInt(r[10])||0)*e;i[4]-=(fastParseInt(r[11])||0)*e;return new Date(Date.UTC(...i))}if(r[8]||s)return new Date(Date.UTC(...i));return new Date(...i)}const k=9466848e5;const v={name:"date",oid:c.date,jsType:"Date",parseBinary(e,t){const n=t.fetchAsString&&t.fetchAsString.includes(c.date);const s=e.readInt32BE();if(s===2147483647)return n?"infinity":Infinity;if(s===-2147483648)return n?"-infinity":-Infinity;let r=new Date(s*1e3*86400+k);if(n||!t.utcDates)r=new Date(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate());return n?dateToDateString(r):r},encodeBinary(e,t,n){if(typeof t==="string")t=parseDateTime(t,false,false,n.utcDates);if(t===Infinity){e.writeInt32BE(2147483647);return}if(t===-Infinity){e.writeInt32BE(-2147483648);return}if(!(t instanceof Date))t=new Date(t);let s=n.utcDates?t.getTime():t.getTime()-t.getTimezoneOffset()*60*1e3;s=(s-k)/1e3/86400;const r=Math.trunc(s+Number.EPSILON);e.writeInt32BE(r)},parseText(e,t){const n=t.fetchAsString&&t.fetchAsString.includes(c.date);if(n)return e;return parseDateTime(e,false,false,t.utcDates)},isType(e){return e instanceof Date}};function padZero(e){return e<9?"0"+e:""+e}function dateToDateString(e){return e.getFullYear()+"-"+padZero(e.getMonth()+1)+"-"+padZero(e.getDate())}const A={...v,name:"_date",oid:c._date,elementsOID:c.date};const R=9466848e5;const P=4294967296;const F={name:"timestamp",oid:c.timestamp,jsType:"Date",parseBinary(e,t){const n=t.fetchAsString&&t.fetchAsString.includes(c.timestamp);const s=e.readInt32BE();const r=e.readUInt32BE(4);if(r===4294967295&&s===2147483647)return n?"infinity":Infinity;if(r===0&&s===-2147483648)return n?"-infinity":-Infinity;let i=new Date((r+s*P)/1e3+R);if(n||!t.utcDates)i=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds());return n?dateToTimestampString(i):i},encodeBinary(e,t,n){if(typeof t==="string")t=parseDateTime(t,true,false,n.utcDates);if(t===Infinity){e.writeInt32BE(2147483647);e.writeUInt32BE(4294967295);return}if(t===-Infinity){e.writeInt32BE(-2147483648);e.writeUInt32BE(0);return}if(!(t instanceof Date))t=new Date(t);let s=n.utcDates?t.getTime():t.getTime()-t.getTimezoneOffset()*60*1e3;s=(s-R)*1e3;const r=Math.floor(s/P);const i=s-r*P;e.writeInt32BE(r);e.writeUInt32BE(i)},parseText(e,t){if(t.fetchAsString&&t.fetchAsString.includes(c.timestamp))return e;return parseDateTime(e,true,false,t.utcDates)},isType(e){return e instanceof Date}};function timestamp_type_padZero(e){return e<9?"0"+e:""+e}function dateToTimestampString(e){return e.getFullYear()+"-"+timestamp_type_padZero(e.getMonth()+1)+"-"+timestamp_type_padZero(e.getDate())+" "+timestamp_type_padZero(e.getHours())+":"+timestamp_type_padZero(e.getMinutes())+":"+timestamp_type_padZero(e.getSeconds())}const O={...F,name:"_timestamp",oid:c._timestamp,elementsOID:c.timestamp};const L=9466848e5;const N=4294967296;const U={name:"timestamptz",oid:c.timestamptz,jsType:"Date",parseBinary(e,t){const n=t.fetchAsString&&t.fetchAsString.includes(c.timestamptz);const s=e.readInt32BE();const r=e.readUInt32BE(4);if(r===4294967295&&s===2147483647)return n?"infinity":Infinity;if(r===0&&s===-2147483648)return n?"-infinity":-Infinity;let i=new Date((r+s*N)/1e3+L);if(n||!t.utcDates)i=new Date(i.getFullYear(),i.getMonth(),i.getDate(),i.getHours(),i.getMinutes(),i.getSeconds(),i.getMilliseconds());return n?dateToTimestamptzString(i):i},encodeBinary(e,t,n){if(typeof t==="string")t=parseDateTime(t,true,true,n.utcDates);if(t===Infinity){e.writeInt32BE(2147483647);e.writeUInt32BE(4294967295);return}if(t===-Infinity){e.writeInt32BE(-2147483648);e.writeUInt32BE(0);return}if(!(t instanceof Date))t=new Date(t);let s=t.getTime();s=(s-L)*1e3;const r=Math.floor(s/N);const i=s-r*N;e.writeInt32BE(r);e.writeUInt32BE(i)},parseText(e,t){const n=parseDateTime(e,true,true,t.utcDates);if(t.fetchAsString&&t.fetchAsString.includes(c.timestamptz)){if(n instanceof Date)return dateToTimestamptzString(n);if(n===Infinity)return"infinity";if(n===-Infinity)return"-infinity";return""}return n},isType(e){return e instanceof Date}};function dateToTimestamptzString(e){return e.toISOString().replace("T"," ")}const j={...U,name:"_timestamptz",oid:c._timestamptz,elementsOID:c.timestamptz};const z={name:"char",oid:c.char,jsType:"string",parseBinary(e){return e.toString("utf8")},encodeBinary(e,t){e.writeString((t?""+t:" ")[0],"utf8")},parseText(e){return""+e},isType(e){return typeof e==="string"&&e.length===1}};const K={...z,name:"_char",oid:c._char,elementsOID:c.char};const $={name:"varchar",oid:c.varchar,jsType:"string",parseBinary(e){return e.toString("utf8")},encodeBinary(e,t){e.writeString(""+t,"utf8")},parseText(e){return""+e},isType(e){return typeof e==="string"}};const G={...$,name:"_varchar",oid:c._varchar,elementsOID:c.varchar};const Q={name:"json",oid:c.json,jsType:"string",parseBinary(e){return e.toString("utf8")},encodeText(e){if(typeof e==="object"||typeof e==="bigint")return JSON.stringify(e);if(typeof e==="boolean")return e?"true":"false";return""+e},parseText(e){return""+e},isType(e){return typeof e==="object"}};const q={...Q,name:"_json",oid:c._json,elementsOID:c.json};const Z=/^\[ *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *]$/;const V=/^\( *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *\)$/;const Y=/^\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\)$/;const H=/^(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*)$/;const W={name:"lseg",oid:c.lseg,jsType:"object",parseBinary(e){return{x1:e.readDoubleBE(0),y1:e.readDoubleBE(8),x2:e.readDoubleBE(16),y2:e.readDoubleBE(24)}},encodeBinary(e,t){e.writeDoubleBE(t.x1);e.writeDoubleBE(t.y1);e.writeDoubleBE(t.x2);e.writeDoubleBE(t.y2)},parseText(e){const t=e.match(Z)||e.match(V)||e.match(Y)||e.match(H);if(!t)return undefined;return{x1:parseFloat(t[1]),y1:parseFloat(t[2]),x2:parseFloat(t[3]),y2:parseFloat(t[4])}},isType(e){return typeof e==="object"&&typeof e.x1==="number"&&typeof e.y1==="number"&&typeof e.x2==="number"&&typeof e.y2==="number"}};const J={...W,name:"_lseg",oid:c._lseg,elementsOID:c.lseg};const X=/^\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\)$/;const ee=/^(-?\d+\.?\d*) *, *(-?\d+\.?\d*)$/;const te={name:"point",oid:c.point,jsType:"object",parseBinary(e){return{x:e.readDoubleBE(0),y:e.readDoubleBE(8)}},encodeBinary(e,t){e.writeDoubleBE(t.x);e.writeDoubleBE(t.y)},parseText(e){const t=e.match(X)||e.match(ee);if(!t)return undefined;return{x:parseFloat(t[1]),y:parseFloat(t[2])}},isType(e){return typeof e==="object"&&typeof e.x==="number"&&typeof e.y==="number"}};const ne={...te,name:"_point",oid:c._point,elementsOID:c.point};const se=/^< *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *(-?\d+\.?\d*) *>$/;const re=/^\( *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *(-?\d+\.?\d*) *\)$/;const ie=/^\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *(-?\d+\.?\d*)$/;const oe=/^(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*)$/;const ae={name:"circle",oid:c.circle,jsType:"object",parseBinary(e){return{x:e.readDoubleBE(0),y:e.readDoubleBE(8),r:e.readDoubleBE(16)}},encodeBinary(e,t){e.writeDoubleBE(t.x);e.writeDoubleBE(t.y);e.writeDoubleBE(t.r)},parseText(e){const t=e.match(se)||e.match(re)||e.match(ie)||e.match(oe);if(!t)return undefined;return{x:parseFloat(t[1]),y:parseFloat(t[2]),r:parseFloat(t[3])}},isType(e){return typeof e==="object"&&typeof e.x==="number"&&typeof e.y==="number"&&typeof e.r==="number"}};const ce={...ae,name:"_circle",oid:c._circle,elementsOID:c.circle};const ue=/^\( *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *\)$/;const fe=/^\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\) *, *\( *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *\)$/;const he=/^(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*) *, *(-?\d+\.?\d*)$/;const le={name:"box",oid:c.box,jsType:"object",arraySeparator:";",parseBinary(e){return{x1:e.readDoubleBE(0),y1:e.readDoubleBE(8),x2:e.readDoubleBE(16),y2:e.readDoubleBE(24)}},encodeBinary(e,t){e.writeDoubleBE(t.x1);e.writeDoubleBE(t.y1);e.writeDoubleBE(t.x2);e.writeDoubleBE(t.y2)},parseText(e){const t=e.match(ue)||e.match(fe)||e.match(he);if(!t)return undefined;return{x1:parseFloat(t[1]),y1:parseFloat(t[2]),x2:parseFloat(t[3]),y2:parseFloat(t[4])}},isType(e){return typeof e==="object"&&typeof e.x1==="number"&&typeof e.y1==="number"&&typeof e.x2==="number"&&typeof e.y2==="number"}};const de={...le,name:"_box",oid:c._box,elementsOID:c.box};const me=16384;const pe=49152;const ge=4;const ye=[0,1e3,100,10];const _e={name:"numeric",oid:c.numeric,jsType:"number",parseBinary(e){const t=e.readInt16BE();const n=e.readInt16BE(2);const s=e.readInt16BE(4);const r=e.readInt16BE(6);if(s===pe)return NaN;const i=[];for(let n=0;n<t;n++){i[n]=e.readInt16BE(8+n*2)}const o=numberBytesToString(i,r,n,s);return parseFloat(o)},encodeText(e){const t=typeof e==="number"?e:parseFloat(e);return""+t},parseText:parseFloat,isType(e){return typeof e==="number"}};const we={..._e,name:"_numeric",oid:c._numeric,elementsOID:c.numeric};function numberBytesToString(e,t,n,s){let r;let i;r=(n+1)*ge;if(r<=0)r=1;let o=s===me?"-":"";if(n<0){i=n+1;o+="0"}else{for(i=0;i<=n;i++){o+=digitToString(i,e,i!==0)}}if(t>0){o+=".";for(r=0;r<t;i++,r+=ge){o+=digitToString(i,e,true)}}const a=(r-t)%ge;return o.substr(0,o.length-a)}function digitToString(e,t,n){let s="";let r=e>=0&&e<t.length?t[e]:0;for(let e=1;e<ye.length;e++){const t=ye[e];const i=Math.trunc(r/t);r-=i*t;const o=i>0;if(o||n){s+=i;n=true}}s+=r;return s}const Ce=/^[0-9a-fA-F]{8}-?[0-9a-fA-F]{4}-?[0-9a-fA-F]{4}-?[0-9a-fA-F]{4}-?[0-9a-fA-F]{12}$/;const be={name:"uuid",oid:c.uuid,jsType:"String",parseBinary(e){return e.toString("hex",0,4)+"-"+e.toString("hex",4,6)+"-"+e.toString("hex",6,8)+"-"+e.toString("hex",8,10)+"-"+e.toString("hex",10,16)},encodeBinary(e,t){if(!Ce.test(t))throw new Error(`"${t}" is not a valid guid value`);const n=Buffer.from(t.replace(/-/g,""),"hex");e.writeBuffer(n)},parseText(e){return e},isType(e){return typeof e==="string"&&Ce.test(e)}};const Ee={...be,name:"_uuid",oid:c._uuid,elementsOID:c.uuid};const Be=/^([01][0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])(?:\.(\d+))?(?:(Z)|(?:([+-])([01]?[0-9]|2[0-3]):?([0-5][0-9])?))?$/;const Se=/^([01][0-9]|2[0-3]):?([0-5][0-9]):?([0-5][0-9])?(?:\.(\d+))?(?:(Z)|(?:([+-])([01]?[0-9]|2[0-3]):?([0-5][0-9])?))?$/;function parseTime(e,t,n){const s=e.match(Se);if(!s)return new Date("invalid");const r=[1970,0,1,0,0,0,0];for(let e=1;e<4;e++){const t=s[e];r[e+2]=fastParseInt(t)||0}if(t&&s[6]){const e=s[9]==="-"?-1:1;r[3]-=(fastParseInt(s[7])||0)*e;r[4]-=(fastParseInt(s[8])||0)*e;return new Date(Date.UTC(...r))}if(s[5]||n)return new Date(Date.UTC(...r));return new Date(...r)}const Ie=4294967296;const Te={name:"time",oid:c.time,jsType:"string",parseBinary(e,t){const n=t.fetchAsString&&t.fetchAsString.includes(c.time);const s=e.readInt32BE();const r=e.readUInt32BE(4);let i=new Date((r+s*Ie)/1e3);if(n||!t.utcDates)i=new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds());return n?dateToTimeString(i):i},encodeBinary(e,t,n){if(typeof t==="string")t=parseTime(t,false,n.utcDates);if(!(t instanceof Date))t=new Date(t);let s=n.utcDates?t.getTime():t.getTime()-t.getTimezoneOffset()*60*1e3;s=s*1e3;const r=Math.floor(s/Ie);const i=s-r*Ie;e.writeInt32BE(r);e.writeUInt32BE(i)},parseText(e,t){if(t.fetchAsString&&t.fetchAsString.includes(c.time))return e;return parseTime(e,false,t.utcDates)},isType(e){return e instanceof Date&&e.getFullYear()===1970&&e.getMonth()===0&&e.getDate()===1||typeof e==="string"&&Be.test(e)}};function time_type_padZero(e){return e<9?"0"+e:""+e}function dateToTimeString(e){return time_type_padZero(e.getHours())+":"+time_type_padZero(e.getMinutes())+":"+time_type_padZero(e.getSeconds())}const De={...Te,name:"_time",oid:c._time,elementsOID:c.time};class DataTypeMap{constructor(e){this._itemsByOID={};this._items=[];if(e instanceof DataTypeMap)Object.assign(this._items,e._items)}get(e){return this._itemsByOID[e]}register(...e){for(const t of e){this._itemsByOID[t.oid]=t;const e=this._items.findIndex((e=>e.oid===t.oid));if(e>=0)this._items[e]=t;else this._items.push(t)}}determine(e){if(e==null)return c.unknown;const t=Array.isArray(e);for(const n of this._items){if(t){if(n.elementsOID&&n.isType(e[0]))return n.oid}else if(!n.elementsOID&&n.isType(e))return n.oid}}}const Me=new DataTypeMap;Me.register(f,h);Me.register(m,p,C,b,l,d);Me.register(S,I,E,B);Me.register(_e,we);Me.register(be,Ee);Me.register(U,j);Me.register(F,O);Me.register(v,A);Me.register(Te,De);Me.register(T,D);Me.register(Q,q);Me.register(te,ne);Me.register(ae,ce);Me.register(W,J);Me.register(le,de);Me.register($,G);Me.register(z,K);Me.register({...$,name:"bpchar",oid:c.bpchar});Me.register({...G,name:"_bpchar",oid:c._bpchar,elementsOID:c.bpchar});Me.register({...$,name:"name",oid:c.name});Me.register({...G,name:"_name",oid:c._name,elementsOID:c.name});Me.register({...$,name:"text",oid:c.text});Me.register({...G,name:"_text",oid:c._text,elementsOID:c.text});Me.register({...$,name:"xml",oid:c.xml});Me.register({...G,name:"_xml",oid:c._xml,elementsOID:c.xml});function parsePostgresArray(e,t){if(!e)return;const n=(t?.separator||",").substring(0,1);const s=t?.transform;const r=e.length;let i=0;const o=[];const iterate=t=>{let o;let a=false;let c="";let u="";while(i<r){o=e.charAt(i++);if(!u){if(!c&&o==="{"){const e=[];t.push(e);iterate(e);continue}if(o==="}"||o===n){if(c){if(c==="NULL"&&!a)t.push(null);else t.push(s?s(c):c);a=false}c="";if(o==="}")return;continue}}if(o==="\\"){o=e.charAt(i++);c+=o;continue}if(o==='"'||o==="'"){if(u&&u===o){u=""}else{a=true;u=o}continue}c+=o}};iterate(o);return o.length?o[0]:undefined}class BufferReader{constructor(e){this.offset=0;this.buffer=e}get length(){return this.buffer.length}readUInt8(){this._checkReadable(1);const e=this.buffer.readUInt8(this.offset);this.offset++;return e}readUInt16BE(){this._checkReadable(2);const e=this.buffer.readUInt16BE(this.offset);this.offset+=2;return e}readInt16BE(){this._checkReadable(2);const e=this.buffer.readInt16BE(this.offset);this.offset+=2;return e}readUInt32BE(){this._checkReadable(4);const e=this.buffer.readUInt32BE(this.offset);this.offset+=4;return e}readInt32BE(){this._checkReadable(4);const e=this.buffer.readInt32BE(this.offset);this.offset+=4;return e}readCString(e){const t=this.buffer.indexOf(0,this.offset);const n=this.buffer.toString(e,this.offset,t);this.offset=t+1;return n}readLString(e,t){if(e<0)return null;this._checkReadable(e);const n=this.buffer.toString(t,this.offset,this.offset+e);this.offset+=e;return n}readBuffer(e){if(e)this._checkReadable(e);const t=e!==undefined?this.offset+e:this.length;const n=this.buffer.slice(this.offset,t);this.offset=t;return n}moveBy(e){return this.moveTo(this.offset+e)}moveTo(e){if(e>=this.length)throw new Error("EOF in buffer detected.");this.offset=e;return this}_checkReadable(e){if(this.offset+e-1>=this.length)throw new Error("EOF in buffer detected.")}}function decodeBinaryArray(e,t,n){if(!e.length)return null;const s=new BufferReader(e);const r=s.readInt32BE();s.readInt32BE();s.readInt32BE();if(r===0)return[];const i=[];const readDim=e=>{const r=i[e];const o=new Array(r);for(let a=0;a<r;a++){if(e<i.length-1){o[a]=readDim(e+1);continue}const r=s.readInt32BE();if(r===-1)o[a]=null;else o[a]=t(s.readBuffer(r),n)}return o};for(let e=0;e<r;e++){i[e]=s.readInt32BE();s.readInt32BE()}return readDim(0)}const xe=r.DataFormat;const DefaultColumnParser=e=>e;const ke=/^true|t|1|yes|y$/i;function toBoolean(e){if(e==null)return;if(typeof e==="string")return ke.test(e);return!!e}function coerceToBoolean(e,t){return e!=null?toBoolean(e):toBoolean(t)}function getParsers(e,t){const n=new Array(t.length);const s=t.length;let r;let i;for(i=0;i<s;i++){r=t[i];const s=e.get(r.dataTypeId);if(s){const e=!!s.elementsOID;if(r.format===xe.binary){const t=s.parseBinary;if(t){n[i]=!e?t:(e,n)=>decodeBinaryArray(e,t,n)}}else if(r.format===xe.text){const t=s.parseText;if(t){n[i]=!e?t:(e,n)=>parsePostgresArray(e,{transform:e=>t(e,n),separator:s.arraySeparator})}}}n[i]=n[i]||DefaultColumnParser}return n}function parseRow(e,t,n){const s=t.length;let r;for(r=0;r<s;r++){t[r]=t[r]==null?null:e[r].call(undefined,t[r],n)}}function convertRowToObject(e,t){const n={};const s=t.length;let r;for(r=0;r<s;r++){n[e[r].fieldName]=t[r]}return n}function getIntlConnection(e){return e._intlCon}function wrapRowDescription(e,t,n){return t.map(((t,s)=>{const r=Array.isArray(n)?n[s]:n;const i={fieldName:t.fieldName,tableId:t.tableId,columnId:t.columnId,dataTypeId:t.dataTypeId,dataTypeName:u[t.dataTypeId]||"",jsType:r===xe.binary?"Buffer":"string"};i.isArray=i.dataTypeName.startsWith("_");if(i.isArray){i.elementDataTypeName=i.dataTypeName.substring(1);for(const e of Object.keys(u)){if(u[e]===i.elementDataTypeName)i.elementDataTypeId=parseInt(e,10)}}if(t.fixedSize&&t.fixedSize>0)i.fixedSize=t.fixedSize;if(t.modifier&&t.modifier>0)i.modifier=t.modifier;const o=e.get(i.dataTypeId);if(o){i.jsType=o.jsType}return i}))}class Portal{constructor(e,t){this._columnFormat=o;this._statement=e;this._name=t}get connection(){return this._statement.connection}get name(){return this._name}async bind(e,t){const n=getIntlConnection(this.connection);n.ref();try{const s=n.socket;this._columnFormat=t.columnFormat!=null?t.columnFormat:r.DataFormat.binary;s.sendBindMessage({typeMap:t.typeMap||Me,statement:this._statement.name,portal:this.name,paramTypes:this._statement.paramTypes,params:e,queryOptions:t});s.sendFlushMessage();return await s.capture((async(e,t,n)=>{switch(e){case r.BackendMessageCode.BindComplete:n();break;case r.BackendMessageCode.NoticeResponse:break;default:n(new Error(`Server returned unexpected response message (${String.fromCharCode(e)}).`))}}))}finally{n.unref()}}async retrieveFields(){const e=getIntlConnection(this.connection);e.ref();try{const t=e.socket;t.sendDescribeMessage({type:"P",name:this.name});t.sendFlushMessage();return await t.capture((async(e,t,n)=>{switch(e){case r.BackendMessageCode.NoticeResponse:break;case r.BackendMessageCode.NoData:n();break;case r.BackendMessageCode.RowDescription:n(undefined,t.fields);break;default:n(new Error(`Server returned unexpected response message (${String.fromCharCode(e)}).`))}}))}finally{e.unref()}}async execute(e){const t=getIntlConnection(this.connection);t.ref();try{const n=t.socket;n.sendExecuteMessage({portal:this.name,fetchCount:e||100});n.sendFlushMessage();const s=[];return await n.capture((async(e,t,n)=>{switch(e){case r.BackendMessageCode.NoticeResponse:break;case r.BackendMessageCode.NoData:n(undefined,{code:e});break;case r.BackendMessageCode.DataRow:if(Array.isArray(this._columnFormat)){s.push(t.columns.map(((e,t)=>this._columnFormat[t]===r.DataFormat.text?e.toString("utf8"):e)))}else if(this._columnFormat===r.DataFormat.binary)s.push(t.columns);else s.push(t.columns.map((e=>e.toString("utf8"))));break;case r.BackendMessageCode.PortalSuspended:n(undefined,{code:e,rows:s});break;case r.BackendMessageCode.CommandComplete:n(undefined,{code:e,rows:s,command:t.command,rowCount:t.rowCount});break;default:n(new Error(`Server returned unexpected response message (${String.fromCharCode(e)}).`))}}))}finally{t.unref()}}async close(){const e=getIntlConnection(this.connection);e.ref();try{const t=e.socket;t.sendCloseMessage({type:"P",name:this.name});t.sendSyncMessage();return await t.capture((async(t,n,s)=>{switch(t){case r.BackendMessageCode.NoticeResponse:break;case r.BackendMessageCode.CloseComplete:break;case r.BackendMessageCode.ReadyForQuery:e.transactionStatus=n.status;s();break;default:s(new Error(`Server returned unexpected response message (${String.fromCharCode(t)}).`))}}))}finally{e.unref()}}}let ve=0;let Ae=0;class PreparedStatement extends SafeEventEmitter{constructor(e,t,n){super();this._sql="";this._name="";this._refCount=0;this._connection=e;this._name="S_"+ ++ve;this._sql=t;this._paramTypes=n;this._onErrorSavePoint="SP_"+Math.round(Math.random()*1e8)}static async prepare(e,t,n){const s=getIntlConnection(e);s.assertConnected();const i=s.socket;const o=new PreparedStatement(e,t,n?.paramTypes);await s.statementQueue.enqueue((async()=>{s.ref();try{i.sendParseMessage({statement:o.name,sql:o.sql,paramTypes:o.paramTypes});i.sendFlushMessage();try{await i.capture((async(e,t,n)=>{switch(e){case r.BackendMessageCode.NoticeResponse:break;case r.BackendMessageCode.ParseComplete:n();break;default:n(new Error(`Server returned unexpected response message (0x${e.toString(16)}).`))}}))}finally{i.sendSyncMessage();await i.capture((async(e,t,n)=>{switch(e){case r.BackendMessageCode.NoticeResponse:break;case r.BackendMessageCode.ReadyForQuery:n();break;default:n(new Error(`Server returned unexpected response message (0x${e.toString(16)}).`))}}))}}finally{s.unref()}}));o._refCount=1;return o}get connection(){return this._connection}get name(){return this._name}get sql(){return this._sql}get paramTypes(){return this._paramTypes}async execute(e={}){const t=getIntlConnection(this.connection);const n=this.sql.match(/^(\bBEGIN\b|\bCOMMIT\b|\bROLLBACK|SAVEPOINT|RELEASE\b)/i);let s=false;let r=false;if(!n){if(!t.inTransaction&&(e?.autoCommit!=null?e?.autoCommit:t.config.autoCommit)===false){s=true}if(t.inTransaction&&e?.autoCommit)r=true}if(s)await t.execute("BEGIN");const i=!n&&(e?.onErrorRollback!=null?e.onErrorRollback:coerceToBoolean(t.config.onErrorRollback,true));if(t.inTransaction&&i)await t.execute("SAVEPOINT "+this._onErrorSavePoint);try{const n=await t.statementQueue.enqueue((()=>this._execute(e)));if(r)await t.execute("COMMIT");else if(t.inTransaction&&i)await t.execute("RELEASE "+this._onErrorSavePoint+";");return n}catch(e){if(t.inTransaction&&i)await t.execute("ROLLBACK TO "+this._onErrorSavePoint+";");throw e}}async close(){--this._refCount;if(this._refCount>0)return;const e=getIntlConnection(this.connection);await e.statementQueue.enqueue((()=>this._close()))}async cancel(){throw new Error("Not implemented yet.")}async _execute(e={}){let t;const n=getIntlConnection(this.connection);n.ref();try{const s={command:undefined};const r=Date.now();const i=Date.now();const a="P_"+ ++Ae;t=new Portal(this,a);await t.bind(e.params,e);const c=await t.retrieveFields();const u=e.typeMap||Me;let f;let h;if(c){f=getParsers(u,c);h=wrapRowDescription(u,c,e.columnFormat||o);s.fields=h;s.rowType=e.objectRows?"object":"array";if(e.cursor){throw new Error("Not implemented yet.")}}const l=await t.execute(e.fetchCount);s.executeTime=Date.now()-i;if(l.command)s.command=l.command;if(h&&f&&l.rows){if(!s.command)s.command="SELECT";const t=s.rows=l.rows;const n=t.length;let r;for(let s=0;s<n;s++){r=t[s];parseRow(f,r,e);if(e.objectRows){t[s]=convertRowToObject(h,r)}}}if(s.command==="DELETE"||s.command==="INSERT"||s.command==="UPDATE")s.rowsAffected=l.rowCount;s.executeTime=Date.now()-r;return s}finally{n.unref();if(t)await t.close()}}async _close(){if(--this._refCount>0)return;const e=getIntlConnection(this.connection);e.ref();try{const t=e.socket;t.sendCloseMessage({type:"S",name:this.name});t.sendSyncMessage();await t.capture((async(t,n,s)=>{switch(t){case r.BackendMessageCode.NoticeResponse:this.emit("notice",n);break;case r.BackendMessageCode.CloseComplete:break;case r.BackendMessageCode.ReadyForQuery:e.transactionStatus=n.status;s();break;default:s(new Error(`Server returned unexpected response message (0x${t.toString(16)}).`))}}))}finally{e.unref()}this.emit("close")}}class DoublyLinked{constructor(...e){this._cursor=undefined;this._head=undefined;this._tail=undefined;this._length=0;this._eof=undefined;if(arguments.length)this.push.apply(this,arguments)}get cursor(){return this._cursor}get head(){return this._head}get length(){return this._length}get tail(){return this._tail}concat(...e){const t=new DoublyLinked;const mergeFn=(e,t)=>{e.push(t);return e};this.reduce(mergeFn,t);for(const n of e){if(n instanceof DoublyLinked)n.reduce(mergeFn,t);else t.push(n)}return t.reset()}entries(){return{[Symbol.iterator](){let e;let t=0;return{next:()=>{e=e?e.next:this.head;return{value:e&&[t++,e.value],done:!e}}}}}}keys(){return{[Symbol.iterator](){let e;let t=0;return{next:()=>{e=e?e.next:this.head;return{value:e&&t++,done:!e}}}}}}values(){return{[Symbol.iterator](){let e;return{next:()=>{e=e?e.next:this.head;return{value:e&&e.value,done:!e}}}}}}every(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");if(!(this._length&&e))return true;t=t!==undefined?t:this;let n=this._head;let s;let r=0;while(n){s=n.next;if(!e.call(t,n.value,r++,t))return false;n=s}return true}everyRight(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");if(!(this._length&&e))return true;t=t!==undefined?t:this;let n=this.tail;for(let s=0;s<this._length;s++){if(!e.call(t,n.value,this._length-s-1,t))return false;n=n.prev}return true}filter(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");t=t!==undefined?t:this;let n=0;return this.reduce(((s,r)=>{if(e.call(t,r,n++,t))s.push(r);return s}),new DoublyLinked)}find(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");if(!this._length)return;t=t!==undefined?t:this;let n=this.head;for(let s=0;s<this.length;s++){if(e.call(t,n.value,s,t)){this._cursor=n;this._eof=false;return n.value}n=n.next}this._cursor=undefined}forEach(e,t){this.every(((t,n,s)=>{e.call(this,t,n,s);return true}),t)}forEachRight(e,t){this.everyRight(((t,n,s)=>{e.call(this,t,n,s);return true}),t)}includes(e,t){const sameValueZero=(e,t)=>e===t||typeof e==="number"&&typeof t==="number"&&isNaN(e)&&isNaN(t);t=t||0;if(t<0)t=this.length+t;this.find(((n,s)=>s>=t&&sameValueZero(n,e)));return!!this.cursor}insert(...e){for(const t of e){const e=new Node(this,t);if(this._length){this._cursor.next=e;e.prev=this._cursor;this._cursor=e}else{this._head=e;this._tail=e;this._cursor=e}this._length++;this._eof=false}return this._length}join(e){e=e||",";let t="";this.forEach((n=>{t+=(t?e:"")+n}));return t}map(e){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");const t=new DoublyLinked;this.forEach(((n,s,r)=>t.push(e(n,s,r))));return t.reset()}next(){if(this._cursor===this._tail){this._eof=true;return undefined}const e=this._cursor?this._cursor.next:this._head;this._cursor=e;return e&&e.value}prev(){let e;if(this._eof){this._eof=false;e=this._cursor=this._tail;return e&&e.value}e=this._cursor&&this._cursor.prev;this._cursor=e;return e&&e.value}pop(){const e=this._tail;if(e){e.remove();return e.value}}push(...e){if(e.length)this._eof=false;for(const t of e){const e=new Node(this,t);if(this._length){this._tail.next=e;e.prev=this._tail;this._tail=e}else{this._head=e;this._tail=e}this._length++}return this._length}reduce(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");let n=t;this.forEach(((t,s)=>{n=e(n,t,s,this)}));return n}reduceRight(e,t){if(typeof e!=="function")throw new TypeError("You must provide a function as first argument");let n=t;this.forEachRight(((t,s)=>{n=e(n,t,s,this)}));return n}remove(e,t){if(this.includes(e,t)){const e=this._cursor;e.remove();return e.value}}reset(){this._cursor=undefined;this._eof=false;return this}reverse(){let e=this._head;let t,n;for(let s=0;s<this._length;s++){t=e.prev;n=e.next;e.prev=n;e.next=t;e=n}t=this._head;n=this._tail;this._head=n;this._tail=t;this.reset();return this}shift(){const e=this._head;if(e){e.remove();return e.value}}slice(e,t){e=e||0;const n=[];this.every(((s,r)=>{if(r>=e)n.push(s);return!t||r<t}));return n}some(e,t){return!this.every(((t,n,s)=>!e.call(this,t,n,s)),t)}someRight(e,t){return!this.everyRight(((t,n,s)=>!e.call(this,t,n,s)),t)}toArray(){return this.slice()}toString(){return"DoublyLinked("+this.join()+")"}unshift(...e){for(const t of e){const e=new Node(this,t);if(this._length){this._head.prev=e;e.next=this._head;this._head=e}else{this._head=e;this._tail=e}this._length++}return this._length}[Symbol.iterator](){let e;return{next:()=>{e=e?e.next:this.head;return{value:e&&e.value,done:!e}}}}}class Node{constructor(e,t){this.list=e;this.value=t;this.prev=undefined;this.next=undefined}remove(){if(!this.list)return;if(this.prev)this.prev.next=this.next;if(this.next)this.next.prev=this.prev;if(this===this.list._cursor)this.list._cursor=this.next||this.prev;if(this===this.list._head)this.list._head=this.next;if(this===this.list._tail)this.list._tail=this.prev;this.list._length--;this.prev=undefined;this.next=undefined;this.list=undefined}}class TaskQueue extends s.EventEmitter{constructor(e){super();this._queue=new DoublyLinked;this.maxQueue=e&&e.maxQueue;this.paused=false}get size(){return this._queue.length+(this._taskRunning?1:0)}pause(){this.paused=true}resume(){this.paused=false;setImmediate((()=>this._next()))}enqueue(e,t){return new Promise(((n,s)=>{if(this.maxQueue&&this.size>=this.maxQueue)throw new Error("Queue limit exceeded.");this.emit("enqueue",e);const executor=()=>{let t;const handleCallback=(r,i)=>{if(t)return;t=true;this._taskRunning=null;if(r){s(r);if(this.listenerCount("error")>0)this.emit("error",r)}else{this.emit("task-complete",e);n(i)}if(!this._queue.length)this.emit("finish");else setImmediate((()=>this._next()))};try{const t=e(handleCallback);if(e.length===0){if(typeof t==="object"&&typeof t.then==="function"&&typeof t.catch==="function"){t.then((e=>handleCallback(null,e))).catch((e=>handleCallback(e||"Rejected")));return}}handleCallback(null,t)}catch(e){handleCallback(e)}};if(t)this._queue.unshift(executor);else this._queue.push(executor);setImmediate((()=>this._next()))}))}_next(){if(this._taskRunning||this.paused)return;this._taskRunning=this._queue.shift();if(this._taskRunning)this._taskRunning()}clear(){this._queue=new DoublyLinked}}const Re=e(import.meta.url)("net");const Pe=e(import.meta.url)("tls");const Fe=e(import.meta.url)("crypto");const Oe=5;const Le={M:"message",S:"severity",V:"severity",C:"code",D:"detail",H:"hint",P:"position",p:"internalPosition",q:"internalQuery",W:"where",s:"schema",t:"table",c:"column",d:"dataType",n:"constraint",F:"file",L:"line",R:"routine"};class Backend{reset(){this._buf=undefined}parse(e,t){if(this._buf){e=Buffer.concat([this._buf,e]);this._buf=undefined}const n=new BufferReader(e);let s;while(n.length-n.offset>=Oe){s=n.offset;const e=n.readUInt8();const r=n.readUInt32BE();if(n.length-n.offset<r-4){n.offset=s;this._buf=n.readBuffer();return}const i=Ne[e];const o=i&&i(n,e,r);t(e,o);n.offset=s+r+1}if(n.offset<n.length)this._buf=n.readBuffer(n.length-n.offset)}}const Ne={[r.BackendMessageCode.Authentication]:parseAuthentication,[r.BackendMessageCode.BackendKeyData]:parseBackendKeyData,[r.BackendMessageCode.CommandComplete]:parseCommandComplete,[r.BackendMessageCode.CopyData]:parseCopyData,[r.BackendMessageCode.CopyInResponse]:parseCopyResponse,[r.BackendMessageCode.CopyOutResponse]:parseCopyResponse,[r.BackendMessageCode.CopyBothResponse]:parseCopyResponse,[r.BackendMessageCode.DataRow]:parseDataRow,[r.BackendMessageCode.ErrorResponse]:parseErrorResponse,[r.BackendMessageCode.NoticeResponse]:parseErrorResponse,[r.BackendMessageCode.FunctionCallResponse]:parseFunctionCallResponse,[r.BackendMessageCode.NegotiateProtocolVersion]:parseNegotiateProtocolVersion,[r.BackendMessageCode.ParameterDescription]:parseParameterDescription,[r.BackendMessageCode.ParameterStatus]:parseParameterStatus,[r.BackendMessageCode.ReadyForQuery]:parseReadyForQuery,[r.BackendMessageCode.RowDescription]:parseRowDescription};function parseAuthentication(e,t,n){const s=e.readUInt32BE();switch(s){case 0:return;case 2:return{kind:"KerberosV5"};case 3:return{kind:"CleartextPassword"};case 5:return{kind:"MD5Password",salt:e.readBuffer(n-8)};case 6:return{kind:"SCMCredential"};case 7:return{kind:"GSS"};case 9:return{kind:"SSPI"};case 8:return{kind:"GSSContinue",data:e.readBuffer(n-8)};case 10:{const t={kind:"SASL",mechanisms:[]};let n;while(n=e.readCString()){t.mechanisms.push(n)}return t}case 11:return{kind:"SASLContinue",data:e.readLString(n-8,"utf8")};case 12:return{kind:"SASLFinal",data:e.readLString(n-8,"utf8")};default:throw new Error(`Unknown authentication kind (${s}).`)}}function parseBackendKeyData(e){return{processID:e.readUInt32BE(),secretKey:e.readUInt32BE()}}function parseCommandComplete(e){return{command:e.readCString("utf8")}}function parseCopyData(e,t,n){return{data:e.readBuffer(n-4)}}function parseCopyResponse(e){const t={overallFormat:e.readUInt8()===0?r.DataFormat.text:r.DataFormat.binary,columnCount:e.readUInt16BE()};if(t.columnCount){t.columnFormats=[];for(let n=0;n<t.columnCount;n++){t.columnFormats.push(e.readUInt16BE()===0?r.DataFormat.text:r.DataFormat.binary)}}return t}function parseDataRow(e){const t={columnCount:e.readUInt16BE()};if(t.columnCount){t.columns=[];for(let n=0;n<t.columnCount;n++){const n=e.readInt32BE();if(n<0)t.columns.push(null);else t.columns.push(e.readBuffer(n))}}return t}function parseErrorResponse(e){const t={};let n;while((n=e.readLString(1))!=="\0"){const s=e.readCString("utf8");const r=Le[n];if(r)t[r]=s}return t}function parseFunctionCallResponse(e,t,n){return{result:e.readBuffer(n-4)}}function parseNegotiateProtocolVersion(e){return{supportedVersionMinor:e.readUInt32BE(),numberOfNotSupportedVersions:e.readUInt32BE(),option:e.readCString("utf8")}}function parseParameterDescription(e){const t={parameterCount:e.readUInt32BE(),parameterIds:[]};for(let n=0;n<t.parameterCount;n++){t.parameterIds.push(e.readUInt32BE())}return t}function parseParameterStatus(e){return{name:e.readCString("utf8"),value:e.readCString("utf8")}}function parseReadyForQuery(e){return{status:e.readLString(1)}}function parseRowDescription(e){const t=e.readUInt16BE();const n={fields:[]};for(let s=0;s<t;s++){const t={fieldName:e.readCString("utf8"),tableId:e.readInt32BE(),columnId:e.readInt16BE(),dataTypeId:e.readInt32BE(),fixedSize:e.readInt16BE(),modifier:e.readInt32BE(),format:e.readInt16BE()===0?r.DataFormat.text:r.DataFormat.binary};n.fields.push(t)}return n}class SmartBuffer extends BufferReader{constructor(e){super(Buffer.allocUnsafe((e?.pageSize?parseInt(e.pageSize,10):0)||SmartBuffer.DEFAULT_PAGE_SIZE));this._lastHouseKeep=0;this._stMaxPages=1;this._length=0;this._houseKeepInterval=e?.houseKeepInterval||5e3;this.pageSize=this.buffer.length;this.maxSize=e?.maxLength||1024*1024*128;this._length=0}get capacity(){return this.buffer.length}get length(){return this._length}start(){this.offset=0;this._length=0;if(this._houseKeepTimer){clearTimeout(this._houseKeepTimer);this._houseKeepTimer=undefined}return this}flush(){if(this._houseKeepTimer)clearTimeout(this._houseKeepTimer);const e=this.length;this._length=0;const t=this.buffer.slice(0,e);const n=e?Math.ceil(e/this.pageSize):1;this._stMaxPages=Math.max(this._stMaxPages,n);if(this._lastHouseKeep<Date.now()+this._houseKeepInterval)this._houseKeep();this._houseKeepTimer=setTimeout((()=>{this._houseKeepTimer=undefined;this._houseKeep()}),this._houseKeepInterval).unref();return t}ensureCapacity(e){const t=this.offset+e;if(this.capacity<t){if(t>this.maxSize)throw new Error("Buffer limit exceeded.");const e=Math.ceil(t/this.pageSize)*this.pageSize;const n=Buffer.allocUnsafe(e);this.buffer.copy(n);this.buffer=n}this._length=Math.max(this.length,t);return this}fill(e=0,t=1){this.ensureCapacity(t);this.buffer.fill(e,this.offset,this.offset+t);this.offset+=t;return this}writeCString(e,t){const n=e?Buffer.byteLength(e,t):0;this.ensureCapacity(n+1);if(e){this.buffer.write(e,this.offset,t);this.offset+=n}this.writeUInt8(0);return this}writeLString(e,t){const n=e?Buffer.byteLength(e,t):0;this.ensureCapacity(n+4);this.writeInt32BE(e==null?-1:n);if(e){if(t)this.offset+=this.buffer.write(e,this.offset,t);else this.offset+=this.buffer.write(e,this.offset)}return this}writeString(e,t){if(e){const n=Buffer.byteLength(e,t);this.ensureCapacity(n);this.offset+=this.buffer.write(e,this.offset,t)}return this}writeInt8(e){this.ensureCapacity(1);this.buffer.writeInt8(e,this.offset);this.offset++;return this}writeUInt8(e){this.ensureCapacity(1);this.buffer.writeUInt8(e,this.offset);this.offset++;return this}writeUInt16BE(e){this.ensureCapacity(2);this.buffer.writeUInt16BE(e,this.offset);this.offset+=2;return this}writeUInt32BE(e){this.ensureCapacity(4);this.buffer.writeUInt32BE(e,this.offset);this.offset+=4;return this}writeInt16BE(e){this.ensureCapacity(2);this.buffer.writeInt16BE(e,this.offset);this.offset+=2;return this}writeInt32BE(e){this.ensureCapacity(4);this.buffer.writeInt32BE(e,this.offset);this.offset+=4;return this}writeBigInt64BE(e){e=typeof e==="bigint"?e:BigInt(e);this.ensureCapacity(8);if(typeof this.buffer.writeBigInt64BE==="function")this.buffer.writeBigInt64BE(e,this.offset);else writeBigUInt64BE(this.buffer,e,this.offset);this.offset+=8;return this}writeFloatBE(e){this.ensureCapacity(4);this.buffer.writeFloatBE(e,this.offset);this.offset+=4;return this}writeDoubleBE(e){this.ensureCapacity(8);this.buffer.writeDoubleBE(e,this.offset);this.offset+=8;return this}writeBuffer(e){this.ensureCapacity(e.length);e.copy(this.buffer,this.offset,0,e.length);this.offset+=e.length;return this}_houseKeep(){const e=this._stMaxPages*this.pageSize;if(this.buffer.length>e)this.buffer=Buffer.allocUnsafe(e);this._stMaxPages=this.length?Math.ceil(this.length/this.pageSize):1}}SmartBuffer.DEFAULT_PAGE_SIZE=4096;function arrayCalculateDim(e){if(!e||e.length===0)return[0];const t=[e.length];const iterate=(e,n)=>{for(let s=0;s<e.length;s++){if(Array.isArray(e[s])){t[n]=Math.max(t[n]||0,e[s].length);iterate(e[s],n+1)}}};iterate(e,1);return t}function encodeBinaryArray(e,t,n,s,r){n=n||c.varchar;const i=arrayCalculateDim(t);const o=i.length;const a=e.offset;e.writeInt32BE(o).writeInt32BE(0).writeInt32BE(n);for(let t=0;t<o;t++){e.writeInt32BE(i[t]);e.writeInt32BE(1)}let u=false;let f;const writeDim=(t,n)=>{const o=i[n];for(let a=0;a<o;a++){if(n<i.length-1){writeDim(t&&t[a],n+1);continue}if(!t||t[a]==null){u=true;e.writeInt32BE(-1);continue}e.writeInt32BE(0);f=e.offset;r(e,t[a],s);e.buffer.writeInt32BE(e.length-f,f-4)}};writeDim(t,0);if(u)e.buffer.writeInt32BE(1,a+4)}function stringifyArrayLiteral(e,t,n){const s=arrayCalculateDim(e);const writeDim=(e,r)=>{const i=s[r];const o=[];for(let a=0;a<i;a++){let i=e&&e[a];if(r<s.length-1){if(i!=null&&!Array.isArray(i))i=[i];o.push(writeDim(i,r+1));continue}if(i==null){o.push("NULL");continue}if(Array.isArray(i)){o.push(stringifyArrayLiteral(i,t,n));continue}if(n)i=n(i,t||{});o.push(escapeArrayItem(""+i))}return"{"+o.join(",")+"}"};return writeDim(e,0)}function escapeArrayItem(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}const Ue=r.DataFormat;const je=Buffer.from([r.FrontendMessageCode.Flush,0,0,0,4]);const ze=Buffer.from([r.FrontendMessageCode.Terminate,0,0,0,4]);const Ke=Buffer.from([r.FrontendMessageCode.Sync,0,0,0,4]);class Frontend{constructor(){this._io=new SmartBuffer}getSSLRequestMessage(){return this._io.start().writeUInt32BE(8).writeUInt16BE(1234).writeUInt16BE(5679).flush()}getStartupMessage(e){const t=this._io.start().writeInt32BE(0).writeInt16BE(r.VERSION_MAJOR).writeInt16BE(r.VERSION_MINOR);for(const[n,s]of Object.entries(e)){if(n!=="client_encoding")t.writeCString(n,"utf8").writeCString(s,"utf8")}t.writeCString("client_encoding","utf8").writeCString("UTF8","utf8").writeUInt8(0);return setLengthAndFlush(t,0)}getPasswordMessage(e){const t=this._io.start().writeInt8(r.FrontendMessageCode.PasswordMessage).writeInt32BE(0).writeCString(e,"utf8");return setLengthAndFlush(t,1)}getSASLMessage(e){const t=this._io.start().writeInt8(r.FrontendMessageCode.PasswordMessage).writeInt32BE(0).writeCString(e.mechanism,"utf8").writeLString(e.clientFirstMessage);return setLengthAndFlush(t,1)}getSASLFinalMessage(e){const t=this._io.start().writeInt8(r.FrontendMessageCode.PasswordMessage).writeInt32BE(0).writeString(e.clientFinalMessage);return setLengthAndFlush(t,1)}getParseMessage(e){if(e.statement&&e.statement.length>63)throw new Error("Query name length must be lower than 63");const t=this._io.start().writeInt8(r.FrontendMessageCode.Parse).writeInt32BE(0).writeCString(e.statement||"","utf8").writeCString(e.sql,"utf8").writeUInt16BE(e.paramTypes?e.paramTypes.length:0);if(e.paramTypes){for(const n of e.paramTypes){t.writeUInt32BE(n||0)}}return setLengthAndFlush(t,1)}getBindMessage(e){if(e.portal&&e.portal.length>63)throw new Error("Portal name length must be lower than 63");if(e.statement&&e.statement.length>63)throw new Error("Query name length must be lower than 63");const t=this._io.start().writeInt8(r.FrontendMessageCode.Bind).writeInt32BE(0).writeCString(e.portal||"","utf8").writeCString(e.statement||"","utf8");const{params:n,paramTypes:s,queryOptions:i}=e;const a=i.columnFormat!=null?i.columnFormat:o;if(n&&n.length){t.writeInt16BE(n.length);const o=t.offset;for(let e=0;e<n.length;e++){t.writeInt16BE(0)}t.writeUInt16BE(n.length);for(let a=0;a<(n===null||n===void 0?void 0:n.length);a++){let c=n[a];if(c==null){t.writeInt32BE(-1);continue}const u=s?s[a]:undefined;const f=u?e.typeMap.get(u):undefined;if(f){if(typeof f.encodeBinary==="function"){t.buffer.writeInt16BE(r.DataFormat.binary,o+a*2);t.writeInt32BE(0);const e=t.offset;if(f.elementsOID){c=Array.isArray(c)?c:[c];encodeBinaryArray(t,c,f.elementsOID,i,f.encodeBinary)}else{f.encodeBinary(t,c,i)}t.buffer.writeInt32BE(t.length-e,e-4)}else if(typeof f.encodeText==="function"){c=f.elementsOID?stringifyArrayLiteral(c,i,f.encodeText):f.encodeText(c,i);t.writeLString(c,"utf8")}}else if(Buffer.isBuffer(c)){t.buffer.writeInt16BE(r.DataFormat.binary,o+a*2);t.writeInt32BE(0);const e=t.offset;t.writeBuffer(c);t.buffer.writeInt32BE(t.length-e,e-4)}else{t.writeLString(""+c,"utf8")}}}else{t.writeUInt16BE(0);t.writeUInt16BE(0)}if(Array.isArray(a)){t.writeUInt16BE(a.length);for(let e=0;e<a.length;e++){t.writeUInt16BE(a[e])}}else if(a===Ue.binary){t.writeUInt16BE(1);t.writeUInt16BE(Ue.binary)}else t.writeUInt16BE(0);return setLengthAndFlush(t,1)}getDescribeMessage(e){if(e.name&&e.name.length>63)throw new Error(e.type==="P"?"Portal":"Statement"+"name length must be lower than 63");const t=this._io.start().writeInt8(r.FrontendMessageCode.Describe).writeInt32BE(0).writeUInt8(e.type.charCodeAt(0)).writeCString(e.name||"","utf8");return setLengthAndFlush(t,1)}getExecuteMessage(e){if(e.fetchCount&&(e.fetchCount<0||e.fetchCount>4294967295))throw new Error("fetchCount can be between 0 and 4294967295");const t=this._io.start().writeInt8(r.FrontendMessageCode.Execute).writeInt32BE(0).writeCString(e.portal||"","utf8").writeUInt32BE(e.fetchCount||0);return setLengthAndFlush(t,1)}getCloseMessage(e){if(e.name&&e.name.length>63)throw new Error(e.type==="P"?"Portal":"Statement"+"name length must be lower than 63");const t=this._io.start().writeInt8(r.FrontendMessageCode.Close).writeInt32BE(0).writeUInt8(e.type.charCodeAt(0)).writeCString(e.name||"","utf8");return setLengthAndFlush(t,1)}getQueryMessage(e){const t=this._io.start().writeInt8(r.FrontendMessageCode.Query).writeInt32BE(0).writeCString(e||"","utf8");return setLengthAndFlush(t,1)}getFlushMessage(){return je}getTerminateMessage(){return ze}getSyncMessage(){return Ke}}function setLengthAndFlush(e,t){e.buffer.writeUInt32BE(e.length-t,t);return e.flush()}class DatabaseError extends Error{constructor(e){super(e.message);Object.assign(this,{...e,line:undefined,file:undefined,routine:undefined});if(e.position)this.position=parseInt(e.position,10)||undefined}}let $e;(function(e){const t="Client Key";const n="Server Key";const s="n,,";function createSession(e,t){const n=Fe.randomBytes(18).toString("base64");const r=`${s}${firstMessageBare(e,n)}`;return{username:e,mechanism:t,nonce:n,clientFirstMessage:r}}e.createSession=createSession;function continueSession(e,r,i){const o=i.toString();const a=o.split(",");let c="";let u="";let f=0;for(const e of a){switch(e[0]){case"r":c=e.substring(2);break;case"s":u=e.substring(2);break;case"i":f=parseInt(e.substring(2),10);break}}if(!c)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");if(!u)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");if(!f)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");if(!c.startsWith(e.nonce))throw new Error("SASL: Server nonce does not start with client nonce");const h=`r=${c},s=${u},i=${f}`;const l=`c=${encode64(s)},r=${c}`;const d=`${firstMessageBare(e.username,e.nonce)},${h},${l}`;const m=hi(r,u,f);const p=hmac(m,t);const g=hash(p);const y=hmac(g,d);const _=xor(p,y);const w=_.toString("base64");const C=hmac(m,n);const b=hmac(C,d);e.serverSignature=b.toString("base64");e.clientFinalMessage=l+",p="+w}e.continueSession=continueSession;function finalizeSession(e,t){let n="";const s=t.split(",");for(const e of s){if(e[0]==="v")n=e.substr(2)}if(n!==e.serverSignature)throw new Error("SASL: Server signature does not match")}e.finalizeSession=finalizeSession;function firstMessageBare(e,t){return`n=${e},r=${t}`}function hi(e,t,n){return Fe.pbkdf2Sync(e,Buffer.from(t,"base64"),n,32,"sha256")}const encode64=e=>Buffer.from(e).toString("base64");function hmac(e,t){return Fe.createHmac("sha256",e).update(t).digest()}function hash(e){return Fe.createHash("sha256").update(e).digest()}function xor(e,t){e=Buffer.isBuffer(e)?e:Buffer.from(e);t=Buffer.isBuffer(t)?t:Buffer.from(t);if(e.length!==t.length)throw new Error("Buffers must be of the same length");const n=e.length;const s=Buffer.allocUnsafe(n);for(let r=0;r<n;r++){s[r]=e[r]^t[r]}return s}})($e||($e={}));const isPromise=function(e){return e&&(e instanceof global.Promise||typeof e==="object"&&typeof e.then==="function"&&typeof e.catch==="function")};const Ge=5432;const Qe=/^([^\d]+)(?: (\d+)(?: (\d+))?)?$/;class PgSocket extends SafeEventEmitter{constructor(e){super();this.options=e;this._state=a.CLOSED;this._backend=new Backend;this._frontend=new Frontend;this._sessionParameters={};this.setMaxListeners(99)}get state(){if(!this._socket||this._socket.destroyed)this._state=a.CLOSED;return this._state}get processID(){return this._processID}get secretKey(){return this._secretKey}get sessionParameters(){return this._sessionParameters}connect(){if(this._socket)return;this._state=a.CONNECTING;const e=this.options;const t=this._socket=new Re.Socket;const errorHandler=e=>{this._state=a.CLOSED;this._removeListeners();this._reset();t.destroy();this._socket=undefined;this.emit("error",e)};const connectHandler=()=>{t.setTimeout(0);if(this.options.keepAlive||this.options.keepAlive==null)t.setKeepAlive(true);if(e.ssl){t.write(this._frontend.getSSLRequestMessage());t.once("data",(n=>{this._removeListeners();if(n.toString()==="S"){const n={...e.ssl,socket:t};if(e.host&&Re.isIP(e.host)===0)n.servername=e.host;const s=this._socket=Pe.connect(n);s.once("error",errorHandler);s.once("secureConnect",(()=>{this._removeListeners();this._handleConnect()}));return}if(n.toString()==="N")return errorHandler(new Error("Server does not support SSL connections"));return errorHandler(new Error("There was an error establishing an SSL connection"))}))}else{this._handleConnect()}};t.setNoDelay(true);t.setTimeout(e.connectTimeoutMs||3e4,(()=>errorHandler(new Error("Connection timed out"))));t.once("error",errorHandler);t.once("connect",connectHandler);this.emit("connecting");if(e.host&&e.host.startsWith("/"))t.connect(e.host);else t.connect(e.port||Ge,e.host||"localhost")}close(){if(!this._socket||this._socket.destroyed){this._state=a.CLOSED;this._socket=undefined;this._reset();return}if(this._state===a.CLOSING)return;const e=this._socket;this._state=a.CLOSING;this._removeListeners();e.once("close",(()=>this._handleClose()));e.destroy()}sendParseMessage(e,t){this._send(this._frontend.getParseMessage(e),t)}sendBindMessage(e,t){this._send(this._frontend.getBindMessage(e),t)}sendDescribeMessage(e,t){this._send(this._frontend.getDescribeMessage(e),t)}sendExecuteMessage(e,t){this._send(this._frontend.getExecuteMessage(e),t)}sendCloseMessage(e,t){this._send(this._frontend.getCloseMessage(e),t)}sendQueryMessage(e,t){this._send(this._frontend.getQueryMessage(e),t)}sendFlushMessage(e){this._send(this._frontend.getFlushMessage(),e)}sendTerminateMessage(e){this._send(this._frontend.getTerminateMessage(),e)}sendSyncMessage(){this._send(this._frontend.getSyncMessage())}capture(e){return new Promise(((t,n)=>{const done=(e,s)=>{this.removeListener("error",errorHandler);this.removeListener("message",msgHandler);if(e)n(e);else t(s)};const errorHandler=e=>{this.removeListener("message",msgHandler);n(e)};const msgHandler=(t,n)=>{const s=e(t,n,done);if(isPromise(s))s.catch((e=>done(e)))};this.once("error",errorHandler);this.on("message",msgHandler)}))}_removeListeners(){if(!this._socket)return;this._socket.removeAllListeners("error");this._socket.removeAllListeners("connect");this._socket.removeAllListeners("data");this._socket.removeAllListeners("close")}_reset(){this._backend.reset();this._sessionParameters={};this._processID=undefined;this._secretKey=undefined;this._saslSession=undefined}_handleConnect(){const e=this._socket;if(!e)return;this._state=a.AUTHORIZING;this._reset();e.on("data",(e=>this._handleData(e)));e.on("error",(e=>this._handleError(e)));e.on("close",(()=>this._handleClose()));this._send(this._frontend.getStartupMessage({user:this.options.user||"postgres",database:this.options.database||""}))}_handleClose(){this._reset();this._socket=undefined;this._state=a.CLOSED;this.emit("close")}_handleError(e){if(this._state!==a.READY){this._socket?.end()}this.emit("error",e)}_handleData(e){this._backend.parse(e,((e,t)=>{try{switch(e){case r.BackendMessageCode.Authentication:this._handleAuthenticationMessage(t);break;case r.BackendMessageCode.ErrorResponse:this.emit("error",new DatabaseError(t));break;case r.BackendMessageCode.NoticeResponse:this.emit("notice",t);break;case r.BackendMessageCode.ParameterStatus:this._handleParameterStatus(t);break;case r.BackendMessageCode.BackendKeyData:this._handleBackendKeyData(t);break;case r.BackendMessageCode.ReadyForQuery:if(this._state!==a.READY){this._state=a.READY;this.emit("ready")}else this.emit("message",e,t);break;case r.BackendMessageCode.CommandComplete:{const n=this._handleCommandComplete(t);this.emit("message",e,n);break}default:this.emit("message",e,t)}}catch(e){this._handleError(e)}}))}_resolvePassword(e){(async()=>{const t=typeof this.options.password==="function"?await this.options.password():this.options.password;e(t||"")})().catch((e=>this._handleError(e)))}_handleAuthenticationMessage(e){if(!e){this.emit("authenticate");return}switch(e.kind){case r.AuthenticationMessageKind.CleartextPassword:this._resolvePassword((e=>{this._send(this._frontend.getPasswordMessage(e))}));break;case r.AuthenticationMessageKind.MD5Password:this._resolvePassword((t=>{const md5=e=>Fe.createHash("md5").update(e,"utf8").digest("hex");const n=md5(t+this.options.user);const s=md5(Buffer.concat([Buffer.from(n),e.salt]));const r="md5"+s;this._send(this._frontend.getPasswordMessage(r))}));break;case r.AuthenticationMessageKind.SASL:{if(!e.mechanisms.includes("SCRAM-SHA-256"))throw new Error("SASL: Only mechanism SCRAM-SHA-256 is currently supported");const t=this._saslSession=$e.createSession(this.options.user||"","SCRAM-SHA-256");this._send(this._frontend.getSASLMessage(t));break}case r.AuthenticationMessageKind.SASLContinue:{const t=this._saslSession;if(!t)throw new Error("SASL: Session not started yet");this._resolvePassword((n=>{$e.continueSession(t,n,e.data);const s=this._frontend.getSASLFinalMessage(t);this._send(s)}));break}case r.AuthenticationMessageKind.SASLFinal:{const t=this._saslSession;if(!t)throw new Error("SASL: Session not started yet");$e.finalizeSession(t,e.data);this._saslSession=undefined;break}}}_handleParameterStatus(e){this._sessionParameters[e.name]=e.value}_handleBackendKeyData(e){this._processID=e.processID;this._secretKey=e.secretKey}_handleCommandComplete(e){const t=e.command&&e.command.match(Qe);const n={command:t[1]};if(t[3]!=null){n.oid=parseInt(t[2],10);n.rowCount=parseInt(t[3],10)}else if(t[2])n.rowCount=parseInt(t[2],10);return n}_send(e,t){if(this._socket&&this._socket.writable){this._socket.write(e,t)}}}function toInt(e){if(e==null)return;const t=parseInt(e,10);if(t||t===0)return t;throw new TypeError(`"${e}" is not a valid integer value.`)}function toIntDef(e,t){return e!=null?toInt(e):toInt(t)}function configFromEnv(){const e=process.env;const t={};t.host=e.PGHOST||e.PGHOSTADDR;if(e.PGPORT)t.port=toIntDef(e.PGPORT,5432);if(e.PGDATABASE)t.database=e.PGDATABASE;if(e.PGUSER)t.user=e.PGUSER;if(e.PGPASSWORD)t.password=e.PGPASSWORD;if(e.PGAPPNAME)t.applicationName=e.PGAPPNAME;if(e.PGTZ)t.timezone=e.PGTZ;if(e.PGSCHEMA)t.schema=e.PGSCHEMA;if(e.PGCONNECT_TIMEOUT)t.connectTimeoutMs=toIntDef(e.PGCONNECT_TIMEOUT,3e4);return t}const isObjectOrClass=e=>e&&(typeof e==="object"&&!Array.isArray(e)||typeof e==="function"&&e.prototype&&e.prototype.constructor);function merge(e,t,n={}){if(!isObjectOrClass(e))throw new TypeError('Property "target" requires object type');if(!t)return e;if(!isObjectOrClass(t))throw new TypeError('Property "source" requires object type');if(t===e)return e;const s=Object.getOwnPropertyNames(t);s.push(...Object.getOwnPropertySymbols(t));for(const r of s){if(r==="__proto__")continue;if(n.filter&&!n.filter(t,r))continue;if((n.combine||n.adjunct)&&e.hasOwnProperty(r))continue;const s=Object.getOwnPropertyDescriptor(t,r);if(n.descriptor&&(s.get||s.set)){Object.defineProperty(e,r,s);continue}let i=t[r];if(i===undefined)continue;delete s.get;delete s.set;if(!n.descriptor){s.enumerable=true;s.configurable=true;s.writable=true}let o=e[r];if(isObjectOrClass(i)){if(n.deep){if(!isObjectOrClass(o)){s.value=o={};Object.defineProperty(e,r,s)}merge(o,i,n);continue}if(n.clone)i=merge({},i,n)}else if(Array.isArray(i)){if(n.arrayMerge&&Array.isArray(o)){if(typeof n.arrayMerge==="function")i=n.arrayMerge(o,i);else i=merge.arrayCombine(o,i)}else if(n.clone)i=i.slice()}s.value=i;Object.defineProperty(e,r,s)}return e}merge.all=function all(e,t={}){const n=e[0];for(const[s,r]of e.entries()){if(s>0)merge(n,r,t)}return n};merge.arrayCombine=function(e,t){return e.concat(t.filter((t=>!e.includes(t))))};function getConnectionConfig(e){const t=configFromEnv();if(typeof e==="string"){merge(t,parseConnectionString(e))}else if(typeof e==="object"){merge(t,e)}if(t.host){const e=parseConnectionString(""+t.host);merge(t,e)}t.user=t.user||"postgres";t.database=t.database||"postgres";t.host=t.host||"127.0.0.1";return t}function parseConnectionString(e){if(e.startsWith("/"))e="socket:/"+e;if(!e.includes("://"))e="postgres://"+e;const t=new URL(e);const n=Object.fromEntries(t.searchParams);const getFirst=e=>typeof e==="string"?e:Array.isArray(e)?e[0]:"";const s={};s.host=decodeURI(t.hostname||"");if(t.port)s.port=parseInt(t.port,10);if(t.protocol==="socket:"||t.protocol==="unix:"){if(!s.host.startsWith("/"))s.host="/"+s.host;s.host+=decodeURI(t.pathname||"");if(n.db)s.database=decodeURI(getFirst(n.db))}else if(t.protocol==="pg:"||t.protocol==="postgres:"){if(t.pathname)s.database=decodeURI(t.pathname.substring(1))}if(n.host)s.host=decodeURI(getFirst(n.host));if(n.db)s.database=decodeURI(getFirst(n.db));if(n.schema)s.schema=decodeURI(getFirst(n.schema));if(n.application_name)s.applicationName=decodeURI(getFirst(n.application_name));if(n.ssl)s.ssl=true;if(t.username)s.user=t.username;if(t.password)s.password=decodeURIComponent(t.password);return s}function escapeLiteral(e){let t=false;let n="'";let s;let r;const i=e.length;for(s=0;s<i;s++){r=e[s];if(r==="'")n+=r+r;else if(r==="\\"){n+=r+r;t=true}else n+=r}n+="'";if(t)n=" E"+n;return n}const qe=r.DataFormat;class IntlConnection extends SafeEventEmitter{constructor(e){super();this._refCount=0;this.transactionStatus="I";this.statementQueue=new TaskQueue;this._config=Object.freeze(getConnectionConfig(e));this.socket=new PgSocket(this._config);this.socket.on("error",(e=>this._onError(e)));this.socket.on("close",(()=>this.emit("close")));this.socket.on("connecting",(()=>this.emit("connecting")));this._onErrorSavePoint="SP_"+Math.round(Math.random()*1e8)}get config(){return this._config}get inTransaction(){return this.transactionStatus==="T"||this.transactionStatus==="E"}get state(){return this.socket.state}get refCount(){return this._refCount}get processID(){return this.socket.processID}get secretKey(){return this.socket.secretKey}get sessionParameters(){return this.socket.sessionParameters}async connect(){if(this.socket.state===a.READY)return;await new Promise(((e,t)=>{const handleConnectError=e=>t(e);this.socket.once("ready",(()=>{this.socket.removeListener("error",handleConnectError);e()}));this.socket.once("error",handleConnectError);this.socket.connect()}));let e="";if(this.config.schema)e+="SET search_path = "+escapeLiteral(this.config.schema)+";";if(this.config.timezone)e+="SET timezone TO "+escapeLiteral(this.config.timezone)+";";if(e)await this.execute(e,{autoCommit:true});this.emit("ready")}async close(){if(this.state===a.CLOSED)return;this.statementQueue.clear();return new Promise((e=>{if(this.socket.state===a.CLOSED)return;this.socket.once("close",e);this.socket.sendTerminateMessage((()=>{this.socket.close();this.emit("close")}))}))}async execute(e,t,n){this.assertConnected();return this.statementQueue.enqueue((async()=>{const s=e.match(/^(\bBEGIN\b|\bCOMMIT\b|\bROLLBACK|SAVEPOINT|RELEASE\b)/i);let r=false;let i=false;if(!s){if(!this.inTransaction&&(t?.autoCommit!=null?t?.autoCommit:this.config.autoCommit)===false){r=true}if(this.inTransaction&&t?.autoCommit)i=true}if(r)await this._execute("BEGIN");const o=!s&&(t?.onErrorRollback!=null?t.onErrorRollback:coerceToBoolean(this.config.onErrorRollback,true));if(this.inTransaction&&o)await this._execute("SAVEPOINT "+this._onErrorSavePoint);try{const s=await this._execute(e,t,n);if(i)await this._execute("COMMIT");else if(this.inTransaction&&o)await this._execute("RELEASE "+this._onErrorSavePoint+";");return s}catch(e){if(this.inTransaction&&o)await this._execute("ROLLBACK TO "+this._onErrorSavePoint+";");throw e}}))}async startTransaction(){if(!this.inTransaction)await this.execute("BEGIN")}async savepoint(e){if(!(e&&e.match(/^[a-zA-Z]\w+$/)))throw new Error(`Invalid savepoint "${e}`);await this.execute("BEGIN; SAVEPOINT "+e)}async commit(){if(this.inTransaction)await this.execute("COMMIT")}async rollback(){if(this.inTransaction)await this.execute("ROLLBACK")}async rollbackToSavepoint(e){if(!(e&&e.match(/^[a-zA-Z]\w+$/)))throw new Error(`Invalid savepoint "${e}`);await this.execute("ROLLBACK TO SAVEPOINT "+e,{autoCommit:false})}async releaseSavepoint(e){if(!(e&&e.match(/^[a-zA-Z]\w+$/)))throw new Error(`Invalid savepoint "${e}`);await this.execute("RELEASE SAVEPOINT "+e,{autoCommit:false})}ref(){this._refCount++}unref(){this._refCount--;return!this._refCount}assertConnected(){if(this.state===a.CLOSING)throw new Error("Connection is closing");if(this.state===a.CLOSED)throw new Error("Connection closed")}async _execute(e,t,n){this.ref();try{const s=Date.now();const i={totalCommands:0,totalTime:0,results:[]};const o=t||{};this.socket.sendQueryMessage(e);let a=Date.now();let c;let u={command:undefined};let f;const h=o.typeMap||Me;return await this.socket.capture((async(e,t,l)=>{switch(e){case r.BackendMessageCode.NoticeResponse:case r.BackendMessageCode.CopyInResponse:case r.BackendMessageCode.CopyOutResponse:case r.BackendMessageCode.EmptyQueryResponse:break;case r.BackendMessageCode.RowDescription:f=t.fields;c=getParsers(h,f);u.fields=wrapRowDescription(h,f,qe.text);u.rows=[];break;case r.BackendMessageCode.DataRow:let e=t.columns.map((e=>{if(e===null)return null;return e.toString("utf8")}));parseRow(c,e,o);if(o.objectRows&&u.fields)e=convertRowToObject(u.fields,e);if(n)n("row",e);u.rows=u.rows||[];u.rows.push(e);break;case r.BackendMessageCode.CommandComplete:u.command=t.command;if(u.command==="DELETE"||u.command==="INSERT"||u.command==="UPDATE")u.rowsAffected=t.rowCount;u.executeTime=Date.now()-a;if(u.rows)u.rowType=o.objectRows&&u.fields?"object":"array";i.results.push(u);if(n)n("command-complete",u);u={command:undefined};a=Date.now();break;case r.BackendMessageCode.ReadyForQuery:this.transactionStatus=t.status;i.totalTime=Date.now()-s;i.totalCommands=i.results.length;l(undefined,i)}}))}finally{this.unref()}}_onError(e){if(this.socket.state!==a.READY)return;this.emit("error",e)}}class BindParam{constructor(e,t){this.oid=e;this.value=t}}class Connection extends SafeEventEmitter{constructor(e,t){super();this._closing=false;if(e&&typeof e.acquire==="function"){if(!(t instanceof IntlConnection))throw new TypeError("Invalid argument.");this._pool=e;this._intlCon=t}else this._intlCon=new IntlConnection(e);this._intlCon.on("ready",((...e)=>this.emit("ready",...e)));this._intlCon.on("error",((...e)=>this.emit("error",...e)));this._intlCon.on("close",((...e)=>this.emit("close",...e)));this._intlCon.on("connecting",((...e)=>this.emit("connecting",...e)));this._intlCon.on("ready",((...e)=>this.emit("ready",...e)));this._intlCon.on("terminate",((...e)=>this.emit("terminate",...e)))}get config(){return this._intlCon.config}get inTransaction(){return this._intlCon.inTransaction}get state(){return this._intlCon.state}get processID(){return this._intlCon.processID}get sessionParameters(){return this._intlCon.sessionParameters}get secretKey(){return this._intlCon.secretKey}async connect(){await this._intlCon.connect();if(this.state===a.READY)this._closing=false}async close(e){this._intlCon.statementQueue.clear();if(this.state===a.CLOSED||this._closing)return;this._closing=true;if(this._intlCon.refCount>0&&typeof e==="number"&&e>0){const t=Date.now();return new Promise(((n,s)=>{const r=setInterval((()=>{if(this._intlCon.refCount<=0||Date.now()>t+e){clearInterval(r);if(this._intlCon.refCount>0){this.emit("terminate")}this._close().then(n).catch(s)}}),50)}))}await this._close()}execute(e,t){return this._intlCon.execute(e,t).catch((t=>{throw this._handleError(t,e)}))}async query(e,t){this._intlCon.assertConnected();const n=t?.typeMap||Me;const s=t?.params?.map((e=>e instanceof BindParam?e.oid:n.determine(e)||c.varchar));const r=await this.prepare(e,{paramTypes:s,typeMap:n}).catch((t=>{throw this._handleError(t,e)}));try{const e=t?.params?.map((e=>e instanceof BindParam?e.value:e));return await r.execute({...t,params:e})}finally{await r.close()}}async prepare(e,t){return await PreparedStatement.prepare(this,e,t)}startTransaction(){return this._intlCon.startTransaction()}commit(){return this._intlCon.commit()}rollback(){return this._intlCon.rollback()}async savepoint(e){if(!this._intlCon.inTransaction)await this._intlCon.startTransaction();return this._intlCon.savepoint(e)}rollbackToSavepoint(e){return this._intlCon.rollbackToSavepoint(e)}releaseSavepoint(e){return this._intlCon.releaseSavepoint(e)}async _close(){if(this._pool){await this._pool.release(this);this.emit("release")}else await this._intlCon.close();this._closing=false}_handleError(e,t){if(e.position){let n=t.substring(0,e.position-1);e.lineNr=n?(n.match(/\n/g)||[]).length:0;const s=n.lastIndexOf("\n")+1;const r=t.indexOf("\n",s);n=t.substring(0,s);e.colNr=e.position-n.length;e.line=r>0?t.substring(s,r):t.substring(s)}return e}}var Ze=n.e;export{Ze as Connection};